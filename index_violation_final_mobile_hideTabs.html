<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gray Home Decor Estimation</title>
<style>
  :root{ --bg:#f7f7fb; --card:#fff; --bd:#dadde3; --text:#111;
         --c-combi:#ffd966; --c-roller:#86efac; --c-pvc:#c7f0ff; --c-public:#fde68a;
         --btn:#2563eb; --btnh:#1d4ed8; }
  *{box-sizing:border-box}
  body{font-family:Arial,Helvetica,sans-serif;margin:16px;background:var(--bg);color:var(--text)}
  h1{margin:0 0 10px}
  .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap; position:sticky; top:0; z-index:1000; background:var(--bg); }
  .tab-btn{padding:10px 14px;border:1px solid var(--bd);border-radius:10px;background:#fff;cursor:pointer}
  .tab-btn.active[data-tab="combi"]{background:var(--c-combi)}
  .tab-btn.active[data-tab="roller"]{background:var(--c-roller)}
  .tab-btn.active[data-tab="pvc"]{background:var(--c-pvc)}
  .tab-btn.active[data-tab="public"]{background:var(--c-public)}
  .panel{display:none}
  .panel.active{display:block}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:8px 0}
  .row label{display:flex;gap:6px;align-items:center;font-size:14px}
  .row input[type="text"]{padding:8px;height:36px;border:1px solid var(--bd);border-radius:6px;min-width:220px;background:#fff}
  .btn{padding:9px 14px;border:0;border-radius:8px;background:#eab308;color:#111;cursor:pointer}
  .btn:hover{filter:brightness(0.95)}
  .muted{font-size:12px;color:#6b7280;margin:6px 2px 10px}
  .table-wrap{background:var(--card);border:1px solid var(--bd);border-radius:10px;overflow:auto;-webkit-overflow-scrolling:touch;}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  thead th{position:sticky;top:0;z-index:1}
  .theme-combi thead th{background:var(--c-combi)}
  .theme-roller thead th{background:var(--c-roller)}
  .theme-pvc thead th{background:var(--c-pvc)}
  .theme-public thead th{background:var(--c-public)}
  th,td{border-bottom:1px solid var(--bd);padding:8px;text-align:center;vertical-align:middle;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  th.col-idx, td.col-idx{width:44px}
  th.col-type, td.col-type{width:140px}
  th.col-room, td.col-room{width:160px}
  th.col-opt, td.col-opt{width:260px}
  th.col-code, td.col-code{width:170px}
  th.col-code2, td.col-code2{width:190px}
  th.col-w, td.col-w, th.col-h, td.col-h{width:120px}
  th.col-unit, td.col-unit{width:96px}
  th.col-sqft, td.col-sqft{width:120px}
  th.col-total, td.col-total{width:150px}
  th.col-remove, td.col-remove{width:90px}
  th.col-add, td.col-add{width:220px}
  input[type="number"], select{width:100%;height:36px;border:1px solid var(--bd);border-radius:6px;padding:6px;background:#fff}
  .magicbox{transform:scale(1.2); cursor:pointer}
  .total{text-align:right;margin-top:12px;font-weight:bold;line-height:1.7}
  #ownerToggle { display:none; } #ownerToggle.shown{ display:inline-block; }
  #ownerPanel{position:fixed;right:16px;bottom:16px;z-index:9999;background:#fff;border:1px solid var(--bd);
    border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.15);width:min(1100px,92vw);max-height:80vh;overflow:auto;display:none;}
  #ownerPanel header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--bd)}
  #ownerPanel h3{margin:0}
  #ownerPanel .wrap{display:grid;grid-template-columns:1fr;gap:10px;padding:12px}
  #ownerPanel .card{border:1px solid var(--bd);border-radius:10px;padding:10px}
  #ownerPanel table{table-layout:auto}
  #ownerPanel th{background:#f3f4f6}
  .pill{display:inline-block;background:#e5e7eb;border-radius:999px;padding:2px 8px;margin-right:6px}
  .danger{background:#ef4444;color:#fff}
  .ok{background:#10b981;color:#fff}
.tabs{position:sticky;top:0;z-index:9999;background:var(--bg)}
</style>

<style>
#ownerPanel{position:fixed;right:16px;bottom:16px;z-index:9999;background:#fff;border:1px solid var(--bd);
  border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.15);width:min(1100px,92vw);max-height:80vh;overflow:auto;display:none;}
#ownerPanel.max{
  inset:0 !important; right:auto; bottom:auto; width:100vw; max-height:none; height:100vh;
  border-radius:0; box-shadow:none; padding-bottom:60px; 
}
#ownerPanel.min{
  width:380px; max-height:48px; overflow:hidden;
}
#ownerPanel.min header{cursor:pointer}
#ownerPanel header .btn{margin-left:6px}
#ownerPanel .floating-footer{position:sticky; bottom:0; background:#fff; border-top:1px solid var(--bd); padding:8px 12px; display:flex; justify-content:flex-end; gap:8px}
</style>


<style>
  #a-table td.sqft, #a-table td.line {
    text-align: right;
    white-space: nowrap;
    min-width: 80px;
  }
</style>


<style>
@media print {
  @page { size: A4 portrait; margin: 25mm; }

  body * { visibility: hidden !important; }
  #ghd-print-root, #ghd-print-root * { visibility: visible !important; }
  #ghd-print-root { display: block !important; position: relative; font-family: Arial, Helvetica, sans-serif; font-size: 10pt; color:#000; }

  #ghd-print-header { position: fixed; top: 0; left: 0; right: 0; border-bottom:1px solid #bbb; padding-bottom:6px; }
  .ghd-title { font-weight: 800; font-size: 16pt; text-align: center; letter-spacing:.3px; }
  .ghd-branches { text-align: center; font-size: 10pt; margin: 2px 0 8px; }
  .ghd-contact, .ghd-phones, .ghd-dti { font-size: 10pt; }
  .ghd-meta { margin-top: 6px; display:grid; grid-template-columns:1.2fr 1.2fr 1fr 1fr 1fr; gap:6px 14px; font-size:10pt; }

  #ghd-print-body { margin-top: 165px; margin-bottom: 165px; }

  #ghd-print-body table { width:100% !important; border-collapse:collapse !important; table-layout:fixed !important; }
  #ghd-print-body thead { display: table-header-group; }
  #ghd-print-body th, #ghd-print-body td {
    border:1px solid #777; padding:6px 8px; font-size:9pt; text-align:center; vertical-align:middle;
    white-space:normal; word-wrap:break-word; overflow-wrap:anywhere;
  }
  #ghd-print-body td.col-type, #ghd-print-body td.col-room, #ghd-print-body td.col-opt { text-align:left; }
  #ghd-print-body td.col-sqft, #ghd-print-body td.col-total { text-align:right; }
  #ghd-print-body thead th { background:#eee; }

  #ghd-print-body th.col-idx,  #ghd-print-body td.col-idx  { width:26px !important; }
  #ghd-print-body th.col-type, #ghd-print-body td.col-type { width:120px !important; }
  #ghd-print-body th.col-code, #ghd-print-body td.col-code { width:66px !important; }
  #ghd-print-body th.col-code2,#ghd-print-body td.col-code2{ width:76px !important; }
  #ghd-print-body th.col-room, #ghd-print-body td.col-room { width:140px !important; }
  #ghd-print-body th.col-size, #ghd-print-body td.col-size { width:100px !important; }
  #ghd-print-body th.col-sqft, #ghd-print-body td.col-sqft { width:52px !important; }
  #ghd-print-body th.col-opt,  #ghd-print-body td.col-opt  { width:140px !important; }
  #ghd-print-body th.col-total,#ghd-print-body td.col-total{ width:86px !important; }

  #ghd-print-footer { position: fixed; bottom: 0; left: 0; right: 0; font-size: 9pt; border-top:1px solid #bbb; padding-top:6px; }
  .ghd-signs { display:grid; grid-template-columns:1fr 1fr 1fr; gap:18px; margin:8px 0 10px; }
  .ghd-signs .line{ width:100%; border-top:1px solid #777; height:2px; margin-top:24px; }
  .ghd-notes { }
}
</style>


<style>
@media print {
  /* Tighter page margins for more table area */
  @page { size: A4 portrait; margin: 10mm; }

  /* Slightly smaller table text for denser layout */
  #ghd-print-root { font-size: 9.5pt !important; }

  /* Reduce header/footer spacing to free vertical space */
  #ghd-print-body { margin-top: 150px !important; margin-bottom: 150px !important; }

  /* Compact but readable cell box */
  #ghd-print-body th, #ghd-print-body td {
    padding: 7px 8px !important;
    line-height: 1.2 !important;
  }

  /* Rebalance column widths to give more space to long codes & text */
  #ghd-print-body th.col-idx,  #ghd-print-body td.col-idx  { width: 26px !important; }   /* SN */
  #ghd-print-body th.col-type, #ghd-print-body td.col-type { width: 110px !important; }  /* Type (slightly tighter) */
  #ghd-print-body th.col-code, #ghd-print-body td.col-code { width: 110px !important; }  /* Code bigger */
  #ghd-print-body th.col-code2,#ghd-print-body td.col-code2{ width: 120px !important; }  /* Exact Code bigger */
  #ghd-print-body th.col-room, #ghd-print-body td.col-room { width: 170px !important; }  /* Area of House bigger */
  #ghd-print-body th.col-size, #ghd-print-body td.col-size { width: 110px !important; }  /* Size (W√óH) slightly bigger */
  #ghd-print-body th.col-sqft, #ghd-print-body td.col-sqft { width: 56px !important; }   /* Sq Ft a bit wider */
  #ghd-print-body th.col-opt,  #ghd-print-body td.col-opt  { width: 170px !important; }  /* Options bigger */
  #ghd-print-body th.col-total,#ghd-print-body td.col-total{ width: 90px !important; }   /* Total slightly wider */

  /* Keep long code tokens from overflowing */
  #ghd-print-body td.col-code, #ghd-print-body td.col-code2 {
    word-break: break-word !important;
    overflow-wrap: anywhere !important;
  }
}
</style>


<style>
@media print {
  /* Switch to landscape layout with slightly smaller margins */
  @page { size: A4 landscape; margin: 12mm; }

  #ghd-print-root { font-size: 9.5pt !important; }

  /* Adjust margins for header/footer */
  #ghd-print-body { margin-top: 120px !important; margin-bottom: 120px !important; }

  /* Table cell styling */
  #ghd-print-body th, #ghd-print-body td {
    padding: 7px 8px !important;
    line-height: 1.2 !important;
  }

  /* Distribute width across landscape orientation */
  #ghd-print-body th.col-idx,  #ghd-print-body td.col-idx  { width: 30px !important; }
  #ghd-print-body th.col-type, #ghd-print-body td.col-type { width: 140px !important; }
  #ghd-print-body th.col-code, #ghd-print-body td.col-code { width: 120px !important; }
  #ghd-print-body th.col-code2,#ghd-print-body td.col-code2{ width: 130px !important; }
  #ghd-print-body th.col-room, #ghd-print-body td.col-room { width: 200px !important; }
  #ghd-print-body th.col-size, #ghd-print-body td.col-size { width: 120px !important; }
  #ghd-print-body th.col-sqft, #ghd-print-body td.col-sqft { width: 70px !important; }
  #ghd-print-body th.col-opt,  #ghd-print-body td.col-opt  { width: 200px !important; }
  #ghd-print-body th.col-total,#ghd-print-body td.col-total{ width: 100px !important; }

  #ghd-print-body td.col-code, #ghd-print-body td.col-code2 {
    word-break: break-word !important;
    overflow-wrap: anywhere !important;
  }
}
</style>


<style>
@media print {
  #ghd-print-body th.col-type, #ghd-print-body td.col-type { width: 160px !important; }  /* more space */
  #ghd-print-body th.col-code, #ghd-print-body td.col-code { width: 140px !important; }  /* more space */
  #ghd-print-body th.col-code2,#ghd-print-body td.col-code2{ width: 140px !important; }  /* keep balanced */
  #ghd-print-body th.col-room, #ghd-print-body td.col-room { width: 160px !important; }  /* narrower */
  #ghd-print-body th.col-opt,  #ghd-print-body td.col-opt  { width: 160px !important; }  /* narrower */
}
</style>


<style>
@media print {
  /* Make Options narrower; keep others as set previously */
  #ghd-print-body th.col-opt,  #ghd-print-body td.col-opt  { width: 120px !important; }
}
</style>


<style>
@media print {
  #ghd-print-header .ghd-contact,
  #ghd-print-header .ghd-phones,
  #ghd-print-header .ghd-dti {
    text-align: center !important;
    margin-top: 2px;
  }
}
</style>


<style>
@media print {
  #ghd-print-header .ghd-dti {
    display: block;
    margin-bottom: 1.5em; /* add ~two blank lines */
  }
}
</style>


<style>
@media print {
  #ghd-print-meta {
    width: 100%;
    margin-top: 1em;
    border-collapse: collapse;
  }
  #ghd-print-meta td {
    padding: 2px 6px;
    font-size: 12pt;
  }
  #ghd-print-meta td.label {
    text-align: left;
    font-weight: bold;
    width: 40%;
  }
  #ghd-print-meta td.value {
    text-align: right;
    width: 60%;
  }
}
</style>


<style>
@media print {
  #ghd-print-header .ghd-dti {
    display: block;
    margin-bottom: 3em; /* add ~3 blank spaces before Client block */
  }
  #ghd-print-meta {
    width: 100%;
    margin-top: 0; /* margin handled by DTI */
    border-collapse: collapse;
  }
  #ghd-print-meta td {
    padding: 4px 6px;
    font-size: 12pt;
  }
  #ghd-print-meta td.label {
    text-align: left;
    font-weight: bold;
    width: 40%;
  }
  #ghd-print-meta td.value {
    text-align: right;
    width: 60%;
  }
}
</style>


<style>
@media print {
  #ghd-print-meta {
    margin-top: 0;
    border-collapse: collapse;
    width: 100%;
  }
  #ghd-print-meta td.label {
    text-align: left;
    font-weight: bold;
    width: 40%;
  }
  #ghd-print-meta td.value {
    text-align: right;
    width: 60%;
  }
}
</style>


<style>
@media print {
  #ghd-print-meta {
    margin-top: 0;
    margin-bottom: 2em; /* add spacing below client details */
    border-collapse: collapse;
    width: 100%;
  }
  #ghd-print-meta td.label {
    text-align: left;
    font-weight: bold;
    width: 40%;
  }
  #ghd-print-meta td.value {
    text-align: right;
    width: 60%;
  }
}
</style>


<style>
@media print {
  /* Keep stacked client block and push table below it */
  #ghd-print-meta {
    margin-top: 0;
    margin-bottom: 2em; /* space before items table */
    border-collapse: collapse;
    width: 100%;
  }
  #ghd-print-meta td.label { text-align: left; font-weight: bold; width: 40%; }
  #ghd-print-meta td.value { text-align: right; width: 60%; }

  /* Hide any legacy inline client details row to avoid duplication */
  #ghd-print-header .client-inline,
  #ghd-print-header .ghd-inline-meta,
  #ghd-inline-meta,
  .ghd-inline-meta {
    display: none !important;
  }

  /* Ensure the items table starts below the taller header (title + DTI + client block) */
  #ghd-print-body {
    margin-top: 220px !important; /* was ~120px; increase to clear header fully */
  }
}
</style>


<style>
@media print {
  /* Ensure meta block stays intact and the table never overlaps it */
  #ghd-print-meta { 
    margin-top: 0;
    margin-bottom: 2em;
    page-break-inside: avoid;
  }
  /* Push the table further down below the fixed header + meta */
  #ghd-print-body {
    margin-top: 300px !important; /* increased from 220px to avoid overlap */
  }
  /* Small extra spacer just in case printers collapse margins */
  #ghd-print-body::before {
    content: "";
    display: block;
    height: 8mm;
  }
}
</style>


<style>
@media print {
  /* Header still fixed */
  #ghd-print-header { position: fixed; top: 0; left: 0; right: 0; }

  /* The client meta block is now outside header, so it prints only once on the first page */
  #ghd-client-meta-wrap { 
    margin-top: 2em;   /* gap under DTI */
    margin-bottom: 1.5em; /* gap before items table */
    page-break-inside: avoid;
  }
  #ghd-print-meta,
  #ghd-print-meta td { 
    border: none !important;   /* remove those lines entirely */
  }
  #ghd-print-meta td.label { text-align:left; font-weight:bold; width: 40%; }
  #ghd-print-meta td.value { text-align:right; width: 60%; }

  /* Hide any legacy inline client row to avoid duplication */
  .client-inline, .ghd-inline-meta, #ghd-inline-meta, table.meta-inline { display: none !important; }

  /* Reset body margin-top to clear header only (not client meta, which is in flow) */
  #ghd-print-body { margin-top: 140px !important; } /* header height only */
}
</style>


<style>
@media print {
  /* Hide the old inline client details row completely */
  .client-inline, .ghd-inline-meta, #ghd-inline-meta, table.meta-inline {
    display: none !important;
    visibility: hidden !important;
    height: 0 !important;
  }
  /* Remove stray horizontal line under it */
  .client-inline hr, #ghd-inline-meta hr {
    display: none !important;
  }
}
</style>


<style>
@media print {
  #ghd-client-meta-wrap {
    margin-top: 20px;
    margin-bottom: 20px;
    page-break-inside: avoid;
  }
  #ghd-print-meta {
    border-collapse: collapse;
    width: 100%;
  }
  #ghd-print-meta td.label {
    text-align: left;
    font-weight: bold;
    width: 40%;
  }
  #ghd-print-meta td.value {
    text-align: right;
    width: 60%;
  }
}
</style>


<style>
@media print {
  /* Hide any legacy inline meta near the header to prevent duplication */
  #ghd-print-header .client-inline,
  #ghd-print-header .ghd-inline-meta,
  #ghd-print-header #ghd-inline-meta,
  #ghd-print-header table.meta-inline,
  #ghd-print-header .meta-inline,
  #ghd-print-header .inline-meta,
  #ghd-print-header .ghd-meta,
  #ghd-print-header .ghd-meta-row,
  #ghd-print-header .meta-row {
    display: none !important;
    visibility: hidden !important;
    height: 0 !important;
  }
  /* Remove any stray header hr/lines */
  #ghd-print-header hr { display:none !important; }
  #ghd-print-header { border-bottom: none !important; }
}
</style>


<style>
@media print {
  /* Hide duplicate client detail blocks */
  .client-inline,
  .ghd-inline-meta,
  #ghd-inline-meta,
  .meta-inline,
  .meta-row,
  .ghd-meta-row {
    display: none !important;
    visibility: hidden !important;
    height: 0 !important;
  }
  /* Remove any stray HR or border in header */
  #ghd-print-header hr { display:none !important; }
  #ghd-print-header { border-bottom: none !important; }
}
</style>


<style id="ghd-print-isolation">
@media print {
  @page { size: A4 landscape; margin: 12mm; }
  body * { visibility: hidden !important; }
  #ghd-print-root, #ghd-print-root * { visibility: visible !important; }
}
</style>


<style id="ghd-client-meta-css">
@media print {
  #ghd-client-meta-wrap { margin-top: 20px; margin-bottom: 20px; page-break-inside: avoid; }
  #ghd-print-meta, #ghd-print-meta td { border: none !important; }
  #ghd-print-meta { width: 100%; border-collapse: collapse; }
  #ghd-print-meta td.label { text-align: left; font-weight: bold; width: 40%; }
  #ghd-print-meta td.value { text-align: right; width: 60%; }
  /* Hide any legacy/inline meta rows near header */
  #ghd-print-header .client-inline,
  #ghd-print-header .ghd-inline-meta,
  #ghd-print-header #ghd-inline-meta,
  #ghd-print-header .meta-inline,
  #ghd-print-header .meta-row,
  #ghd-print-header .ghd-meta-row { display:none !important; height:0 !important; visibility:hidden !important; }
  #ghd-print-header hr { display: none !important; }
  #ghd-print-header { border-bottom: none !important; }
}
</style>


<style id="ghd-footer-trim">
@media print {
  #ghd-print-footer { border-top: none !important; }
  #ghd-print-footer .ghd-signs { grid-template-columns: 1fr !important; }
  #ghd-print-footer .ghd-signs .sig:nth-child(2),
  #ghd-print-footer .ghd-signs .sig:nth-child(3) { display: none !important; }
}
</style>


<style id="ghd-body-offset">
@media print {
  #ghd-print-body { margin-top: 140px !important; }
}
</style>


<style id="ghd-dump-guard">
@media print {
  pre, code, .template, .tpl, [data-template], .export-template, .raw-template {
    display: none !important;
    visibility: hidden !important;
    height: 0 !important;
  }
}
</style>


<style id="ghd-client-unique-only">
@media print {
  /* Keep only the stacked block once */
  #ghd-client-meta-wrap { display: block !important; visibility: visible !important; height: auto !important; }

  /* Hide any duplicate client detail blocks anywhere */
  .client-inline,
  #ghd-inline-meta,
  .meta-inline,
  .meta-row,
  .ghd-meta-row {
    display: none !important;
    visibility: hidden !important;
    height: 0 !important;
    overflow: hidden !important;
  }
}
</style>








<style id="ghd-client-below-header">
@media print {
  #ghd-print-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
  }
  #ghd-client-meta-wrap {
    margin-top: 140px; /* pushes below fixed header */
    margin-bottom: 40px; /* adjusted to ~2 blank lines before table */
    page-break-inside: avoid;
  }
  #ghd-print-meta {
    width: 100%;
    border-collapse: collapse;
  }
  #ghd-print-meta td.label { text-align: left; font-weight: bold; width: 40%; }
  #ghd-print-meta td.value { text-align: right; width: 60%; }
}
</style>











<style id="ghd-client-spacing-after-validity">
@media print {
  #ghd-print-meta tr:last-child td {
    padding-bottom: 10px !important; /* locked spacing after Quotation Validity */
  }
}
</style>


<style id="ghd-tighten-spacing">
@media print {
  #ghd-print-meta tr:last-child td {
    padding-bottom: 0 !important; /* no extra gap after Quotation Validity */
  }
  #ghd-items-table {
    margin-top: 5px !important;  /* tiny buffer before items table */
  }
  #ghd-print-footer {
    page-break-before: always;   /* footer appears only at end */
  }
}
</style>


<style id="ghd-remove-gap-validity-to-table">
@media print {
  #ghd-client-meta-wrap {
    margin-bottom: 0 !important; /* no extra gap after client block */
  }
  #ghd-print-meta tr:last-child td {
    padding-bottom: 0 !important; /* remove padding after validity */
  }
  #ghd-items-table {
    margin-top: 5px !important;  /* tiny buffer only */
  }
}
</style>


<style id="ghd-hard-isolation">
@media print {
  /* Hide EVERYTHING except the dedicated print root to prevent stray content adding space */
  body > *:not(#ghd-print-root) { display: none !important; }
  /* Ensure the root itself is shown */
  #ghd-print-root { display: block !important; }
}
</style>


<style id="ghd-tighten-table-start">
@media print {
  /* Zero out any accidental margins right before the items table */
  #ghd-print-body { margin-top: 0 !important; }
  #ghd-print-body table:first-of-type { margin-top: 5px !important; }
  /* Remove borders/lines under client meta if any */
  #ghd-print-meta, #ghd-print-meta td { border: none !important; }
}
</style>





<style id="ghd-totals-style">
@media print {
  #ghd-totals-foot tr td { border-top: 1px solid #000; padding-top: 6px; font-weight: bold; font-size: 12pt; }
  #ghd-totals-foot tr td.label { text-align: right; }
  #ghd-totals-foot tr td.amount { text-align: right; width: 140px; }
}
</style>


<style id="ghd-print-cleanup-2">
@media print {
  /* Hide any script/template/code dumps */
  script, style, pre, code,
  .template, .tpl, .export-template, .raw-template, [data-template],
  .debug, .dev-notes, .dev, .dump, .js-dump {
    display: none !important;
    visibility: hidden !important;
    height: 0 !important;
    overflow: hidden !important;
  }
}
</style>


<style id="ghd-footer-font-match">
@media print {
  #ghd-print-footer { font-size: 12pt !important; line-height: 1.25; }
  #ghd-print-footer p, #ghd-print-footer li, #ghd-print-footer div { font-size: 12pt !important; }
}
</style>


<style id="ghd-signature-trim">
@media print {
  #ghd-print-footer .ghd-signs { display: grid; grid-template-columns: 1fr; gap: 8mm; }
  #ghd-print-footer .ghd-signs .sig { text-align: left; }
  #ghd-print-footer .ghd-signs .sig .line,
  #ghd-print-footer .ghd-signs .sig hr {
    width: 180px !important;   /* shortened line */
    margin: 6px 0 !important;
    border: 0;
    border-top: 1px solid #000;
    height: 0;
  }
  #ghd-print-footer .ghd-signs .sig .label {
    display: block;
    margin-top: 2px;
  }
}
</style>


<style id="ghd-footer-dedupe">
@media print {
  #ghd-print-root #ghd-print-footer ~ #ghd-print-footer { display: none !important; }
  body > :not(#ghd-print-root) #ghd-print-footer { display: none !important; }
}
</style>


<style id="ghd-page-portrait">
@media print { @page { size: A4 portrait; margin: 12mm; } }
</style>


<style id="ghd-print-cleanup-strong">
@media print {
  script, style, pre, code,
  .template, .tpl, .export-template, .raw-template, [data-template],
  .debug, .dev-notes, .dev, .dump, .js-dump {
    display: none !important;
    visibility: hidden !important;
    height: 0 !important;
    overflow: hidden !important;
  }
  #ghd-print-root #ghd-print-footer ~ #ghd-print-footer { display: none !important; }
}
</style>


<style id="ghd-footer-tune">
@media print {
  #ghd-print-footer { font-size: 12pt !important; line-height: 1.25; }
  #ghd-print-footer p, #ghd-print-footer li, #ghd-print-footer div { font-size: 12pt !important; }
  #ghd-print-footer .ghd-signs .sig .line,
  #ghd-print-footer .ghd-signs .sig hr {
    width: 180px !important;
    margin: 6px 0 !important;
    border: 0; border-top: 1px solid #000; height: 0;
  }
}
</style>


<style id="ghd-footer-notes-print">
@media print {
  #ghd-footer-notes-toolbar { display: none !important; }
  #ghd-print-footer #ghd-footer-notes {
    margin-top: 6pt;
    font-size: 12pt;
    line-height: 1.25;
    white-space: pre-wrap;
  }
}
@media screen {
  #ghd-print-footer #ghd-footer-notes { display: none; }
}
</style>


<style id="ghd-screen-toolbar-print-hide">
@media print {
  #ghd-screen-toolbar { display: none !important; }
}
</style>






<style id="ghd-viol-style">
  /* visual for violation content */
  .mp-viol-host { display:block; min-height:1em; }
  .mp-viol { color:#d00 !important; font-weight:600 !important; font-size:0.95em; line-height:1.2; }
</style>

<style id="ghd-mobile-friendly">
  /* Base: fluid text, nicer line-height */
  html { -webkit-text-size-adjust: 100%; }
  body { font-size: clamp(14px, 3.6vw, 16px); line-height: 1.45; }

  /* Inputs & buttons: comfortable touch targets */
  input, select, button, textarea {
    font: inherit;
    min-height: 42px;
  }

  /* Let long cell text wrap on phones (but keep desktop behavior) */
  @media (max-width: 600px) {
    thead th, tbody td { white-space: normal; }
  }

  /* Stack the top controls on phones */
  @media (max-width: 600px) {
    .row { flex-direction: column; align-items: stretch; }
    .row label { width: 100%; }
    .row input[type="text"],
    .row input[type="number"],
    .row select,
    .btn { width: 100%; }
  }

  /* Tighten fixed column widths on phones */
  @media (max-width: 600px) {
    th.col-idx, td.col-idx   { width: 36px; }
    th.col-w, td.col-w,
    th.col-h, td.col-h       { width: 84px; }
    th.col-unit, td.col-unit { width: 74px; }
    th.col-sqft, td.col-sqft { width: 92px; text-align: right; }
    th.col-total, td.col-total { width: 120px; text-align: right; }
    th.col-code, td.col-code,
    th.col-code2, td.col-code2,
    th.col-opt,  td.col-opt,
    th.col-room, td.col-room { width: auto; }
  }

  /* Keep sticky tabs usable on small screens */
  .tabs { gap: 6px; }
  .tab-btn { padding: 9px 12px; }
  
  /* Ensure table wrapper scrolls if rule was missing in original */
  .table-wrap{overflow:auto;-webkit-overflow-scrolling:touch;}
</style>

<style id="ghd-hide-tabs-buttons">
  /* Hide all buttons/controls inside the .tabs container */
  .tabs button,
  .tabs .tab-btn,
  .tabs [role="tab"],
  .tabs a,
  .tabs input[type="button"],
  .tabs input[type="submit"] {
    display: none !important;
  }
  /* Disable interactions on the tabs bar just in case */
  .tabs { pointer-events: none; }
</style>
</head>
<body>

<!-- GHD Screen Toolbar: Project Location + Footer Notes -->
<div id="ghd-screen-toolbar" style="padding:10px 12px; background:#f5f7fb; border-bottom:1px solid #dfe3eb; display:flex; gap:20px; align-items:flex-start; flex-wrap:wrap;">
  <div style="display:flex; align-items:center; gap:8px;">
    <label for="projectLocationInput" style="font-weight:600;">Project Location:</label>
    <input id="projectLocationInput" type="text" placeholder="Type project location‚Ä¶" 
           style="min-width:340px; padding:6px 8px; border:1px solid #bfc7d4; border-radius:6px;">
  </div>
  <div style="display:flex; gap:8px; align-items:flex-start;">
    <label for="ghdFooterNotesInput" style="font-weight:600; margin-top:6px;">Footer Notes (prints at bottom):</label>
    <textarea id="ghdFooterNotesInput" style="font-size:14px;" placeholder="Add delivery timings, payment terms, bank accounts, or special instructions‚Ä¶"
              style="min-width:420px; min-height:72px; padding:6px 8px; border:1px solid #bfc7d4; border-radius:6px;"></textarea>
  </div>
</div>


<div id="ghd-footer-notes-toolbar" style="padding:8px 12px; background:#f9fafb; border-top:1px solid #eee; border-bottom:1px solid #eee;">
  <label for="ghdFooterNotesInput" style="font-weight:600; margin-right:8px;">Footer Notes (prints at bottom):</label>
  <textarea id="ghdFooterNotesInput" style="font-size:14px;" placeholder="Add delivery notes, special terms, reference info‚Ä¶" 
    style="min-width:420px; min-height:64px; padding:6px 8px; border:1px solid #ccc; border-radius:6px; vertical-align:top;"></textarea>
</div>


<!-- BIND *ANY* "Print Quote" BUTTONS + add a floating guaranteed button -->
<style>
@media screen {
  #ghdProPrintBtn { position: fixed; top: 12px; right: 12px; z-index: 2147483647;
    background:#111;color:#fff;border:none;border-radius:8px;padding:10px 14px;font-size:14px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.25); }
  #ghdProPrintBtn:hover{opacity:.9}
}
@media print { #ghdProPrintBtn{ display:none !important; } }
</style>
<button id="ghdProPrintBtn" type="button" title="Print (Pro Layout)">Print (Pro Layout)</button>
<script>
(function(){
  function getActiveTabKey(){
    var btn = document.querySelector('.tab-btn.active');
    if (btn && btn.dataset && btn.dataset.tab) return btn.dataset.tab;
    var panel = document.querySelector('.panel.active');
    if (panel && panel.id && panel.id.startsWith('panel-')) return panel.id.replace('panel-','');
    return null;
  }
  function proPrint(tab){
    try{
      if (window.GHD && typeof window.GHD.openQuote === 'function'){
        window.GHD.openQuote(tab || getActiveTabKey());
      } else {
        window.print();
      }
    }catch(e){ console.error(e); }
  }
  // Floating guaranteed button
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('ghdProPrintBtn');
    if (btn) btn.addEventListener('click', function(e){ e.preventDefault(); proPrint(); });
  });

  // Bind ANY existing buttons/links that look like Print Quote
  function looksLikePrintEl(el){
    if (!el) return false;
    var id=(el.id||'').toLowerCase(), cls=(el.className||'').toString().toLowerCase(), txt=(el.textContent||'').toLowerCase().trim();
    return id.includes('print')||id.includes('quote')||cls.includes('print')||cls.includes('quote')||txt==='print quote'||txt==='print'||txt.includes('print quote');
  }
  function bindAll(){
    Array.from(document.querySelectorAll('button,a,[role="button"],input[type="button"],input[type="submit"]')).forEach(function(el){
      if (looksLikePrintEl(el) && !el.__ghdBound){
        el.__ghdBound = true;
        el.addEventListener('click', function(e){
          e.preventDefault(); e.stopPropagation();
          var tab = this.dataset && this.dataset.tab ? this.dataset.tab : getActiveTabKey();
          proPrint(tab);
          return false;
        }, true);
      }
    });
  }
  document.addEventListener('DOMContentLoaded', bindAll);
  // Re-bind in case buttons are recreated dynamically
  var mo = new MutationObserver(function(){ bindAll(); });
  mo.observe(document.documentElement, {childList:true, subtree:true});
})();
</script>


<!-- PRINT-ONLY HEADER/FOOTER + ROOT (safe) -->
<div id="ghd-print-root" style="display:none;">
  <div id="ghd-print-header">
    <div class="ghd-title">GRAY HOME D√âCOR &amp; INTERIOR DESIGN</div>
    <div class="ghd-branches">Laug Mexico Pampanga ¬∑ Cabuyao Laguna ¬∑ Batangas City</div>
    <div class="ghd-contact">Email: Grayhomedecor@yahoo.com</div>
    <div class="ghd-phones">Tel: 09513183794 ¬∑ 09956447799 ¬∑ 09166373872 (Viber &amp; WhatsApp)</div>
    <div class="ghd-dti">DTI Permit no. 2117593</div>




    <div class="ghd-meta">
      <div><strong>Client Name:</strong> <span id="ghdPH_client">‚Äî</span></div>
      <div><strong>Project Location:</strong> <span id="ghdPH_location">‚Äî</span></div>
      <div><strong>Quotation Ref:</strong> <span id="ghdPH_ref">‚Äî</span></div>
      <div><strong>Quotation Date:</strong> <span id="ghdPH_date">‚Äî</span></div>
      <div><strong>Quotation Validity:</strong> <span id="ghdPH_validity">‚Äî</span></div>
    </div>
  </div>

  
  <!-- Standalone Client Details (appears once below header, not repeated on page 2+) -->
  <div id="ghd-client-meta-wrap">
    <table id="ghd-print-meta">
      <tr><td class="label">Client Name:</td><td class="value" id="ghdPH_client">‚Äî</td></tr>
      <tr><td class="label">Project Location:</td><td class="value" id="ghdPH_location">‚Äî</td></tr>
      <tr><td class="label">Quotation Ref:</td><td class="value" id="ghdPH_ref">‚Äî</td></tr>
      <tr><td class="label">Quotation Date:</td><td class="value" id="ghdPH_date">‚Äî</td></tr>
      <tr><td class="label">Quotation Validity:</td><td class="value" id="ghdPH_validity">‚Äî</td></tr>
    </table>
  </div>

  <div id="ghd-print-body"><!-- active table gets cloned here --></div>

  <div id="ghd-print-footer">
    <div class="ghd-signs">
      <div class="sig"><div class="line"></div><div>Customer Signature</div></div>
      <div class="sig"><div class="line"></div><div>Prepared By</div></div>
      <div class="sig"><div class="line"></div><div>Approved By</div></div>
    </div>
    <div class="ghd-notes">
      <div>Delivery is 7‚Äì14 days from the date of Down Payment. +5 days if regular powdercoat; +30 days if woodgrain powdercoat.</div>
      <div><strong>Payment Terms:</strong> 50% advance, 50% upon installation.</div>
      <div><strong>BDO:</strong> 003580488958 &nbsp; <strong>BPI:</strong> 02469210963 &nbsp; <strong>GCash:</strong> 09166373872</div>
      <div><strong>Material Used:</strong> <span id="ghdPF_material">‚Äî</span></div>
    </div>
  </div>
</div>

<h1>Gray Home Decor Estimation</h1>
<div class="muted">Combi option restored in Owner Panel. ‚ÄúExact Code‚Äù boxes added beside each dropdown. Final per ft¬≤ = <b>Base √ó 2 + 20</b>. Magic applies to <b>Combi & Roller only</b>. </div>

<div class="tabs">
  <button type="button" class="tab-btn active" data-tab="all">All Products</button>
  <button type="button" class="tab-btn" data-tab="combi">Combi Blinds</button>
  <button type="button" class="tab-btn" data-tab="roller">Roller Blinds</button>
  <button type="button" class="tab-btn" data-tab="pvc">PVC Vertical & Other</button><button type="button" class="tab-btn" data-tab="other">Main Products</button><button type="button" class="tab-btn" data-tab="synergy">Synergy Combi Vertical</button>
<button type="button" class="tab-btn" data-tab="shangrila">Shangrila Blinds</button>
<button type="button" class="tab-btn" data-tab="venetian">Venetian Blinds</button><button type="button" class="tab-btn" data-tab="realwood">Realwood Blinds</button>
<button type="button" class="tab-btn" data-tab="curtains">Curtains - Fabric Registry</button>


  
  <button type="button" id="ownerToggle" class="tab-btn">‚öôÔ∏è Edit Prices</button>

  <button type="button" class="tab-btn" data-tab="preset">Preset Estimator</button>
</div>
  <button type="button" class="tab-btn" data-tab="all">All Products</button>

<!-- COMBI PANEL -->
<section id="panel-combi" class="panel active theme-combi">
  <div class="row">
    <label>Customer: <input id="c-cust" type="text" placeholder="Enter customer name"></label>
    <button type="button" id="c-add" class="btn">+ Add Item</button>
    <button type="button" class="btn" data-ghd-tab="combi" onclick="GHD.openQuote('combi')">üñ®Ô∏è Print Quote</button>
    <button type="button" class="btn" data-ghd-tab="combi" onclick="GHD.exportQuote('combi')">‚¨á Export Quote (.xlsx)</button>
  </div>
  <div class="muted">Combi: Line = Area √ó Final (if Magic is checked ‚Üí Area √ó (Final + 20)). Min area 15 ft¬≤, Min height 36".</div>
  <div class="table-wrap"><table id="c-table">
    <thead><tr>
      <th class="col-idx">#</th>
      <th class="col-code">Code</th>
      <th class="col-code2">Exact Code</th>
      <th class="col-w">Width</th><th class="col-unit">Unit</th>
      <th class="col-h">Height</th><th class="col-unit">Unit</th>
      <th class="col-sqft">Sq Ft</th>
      <th class="col-add">Magic (+‚Ç±20/ft¬≤)</th>
      <th class="col-total">Line Total</th>
      <th class="col-remove">Remove</th>
    </tr></thead>
    <tbody></tbody>
  <tfoot id="ghd-totals-foot"></tfoot></table></div>
  <div class="total">Customer: <span id="c-custOut">‚Äî</span> ‚Ä¢ Grand Total: ‚Ç±<span id="c-grand">0</span></div>
</section>

<!-- ROLLER PANEL -->
<section id="panel-roller" class="panel theme-roller">
  <div class="row">
    <label>Customer: <input id="r-cust" type="text" placeholder="Enter customer name"></label>
    <button type="button" id="r-add" class="btn">+ Add Item</button>
    <button type="button" class="btn" data-ghd-tab="roller" onclick="GHD.openQuote('roller')">üñ®Ô∏è Print Quote</button>
    <button type="button" class="btn" data-ghd-tab="roller" onclick="GHD.exportQuote('roller')">‚¨á Export Quote (.xlsx)</button>
  </div>
  <div class="muted">Roller: Line = Area √ó ( Final + Chain + BottomTube ) (if Magic is checked ‚Üí +20). Min area 15 ft¬≤.</div>
  <div class="table-wrap"><table id="r-table">
    <thead><tr>
      <th class="col-idx">#</th>
      <th class="col-code">Code</th>
      <th class="col-code2">Exact Code</th>
      <th class="col-w">Width</th><th class="col-unit">Unit</th>
      <th class="col-h">Height</th><th class="col-unit">Unit</th>
      <th class="col-sqft">Sq Ft</th>
      <th class="col-add">Chain</th>
      <th class="col-add">Bottom Tube</th>
      <th class="col-add">Magic (+‚Ç±20/ft¬≤)</th>
      <th class="col-total">Line Total</th>
      <th class="col-remove">Remove</th>
    </tr></thead>
    <tbody></tbody>
  </table></div>
  <div class="total">Customer: <span id="r-custOut">‚Äî</span> ‚Ä¢ Grand Total: ‚Ç±<span id="r-grand">0</span></div>
</section>

<!-- PVC PANEL -->
<section id="panel-pvc" class="panel theme-pvc">
  <div class="row">
    <label>Customer: <input id="p-cust" type="text" placeholder="Enter customer name"></label>
    <button type="button" id="p-add" class="btn">+ Add Item</button>
    <button type="button" class="btn" data-ghd-tab="pvc" onclick="GHD.openQuote('pvc')">üñ®Ô∏è Print Quote</button>
    <button type="button" class="btn" data-ghd-tab="pvc" onclick="GHD.exportQuote('pvc')">‚¨á Export Quote (.xlsx)</button>
  </div>
  <div class="muted">PVC: Line = Area √ó Final.</div>
  <div class="table-wrap"><table id="p-table">
    <thead><tr>
      <th class="col-idx">#</th>
      <th class="col-code">Code</th>
      <th class="col-code2">Exact Code</th>
      <th class="col-w">Width</th><th class="col-unit">Unit</th>
      <th class="col-h">Height</th><th class="col-unit">Unit</th>
      <th class="col-sqft">Sq Ft</th>
      <th class="col-total">Line Total</th>
      <th class="col-remove">Remove</th>
    </tr></thead>
    <tbody></tbody>
  </table></div>
  <div class="total">Customer: <span id="p-custOut">‚Äî</span> ‚Ä¢ Grand Total: ‚Ç±<span id="p-grand">0</span></div>
</section>


<!-- ALL PRODUCTS PANEL -->
<section id="panel-all" class="panel active theme-combi">
  <div class="row">
    <label>Customer: <input id="a-cust" type="text" placeholder="Enter customer name"></label>
    <label>VAT % <input id="a-vat" type="number" value="0" min="0" step="0.01" style="width:90px;height:36px"></label>
    <label>Discount % <input id="a-disc" type="number" value="0" min="0" max="100" step="0.01" style="width:90px;height:36px"></label>
    <button id="a-add" class="btn">+ Add Item</button>
    <button type="button" class="btn" data-ghd-tab="all" onclick="GHD.openQuote('all')">üñ®Ô∏è Print Quote</button>
    <button type="button" class="btn" data-ghd-tab="all" onclick="GHD.exportQuote('all')">‚¨á Export Quote (.xlsx)</button>
  </div>
  <div class="muted">Use this tab on-site to mix items. Choose a product type (Combi, Roller, Polycarbonate), enter size, and optionally set Exact Code & Area of House (e.g., Living, Kitchen).</div>
  <div class="table-wrap"><table id="a-table">
    <thead><tr>
      <th class="col-idx">#</th>
      <th class="col-type">Type</th>
      <th class="col-code">Code</th>
      <th class="col-code2">Exact Code</th>
      <th class="col-room">Area of House</th>
      <th class="col-w">W</th><th class="col-unit">Unit</th>
      <th class="col-h">H</th><th class="col-unit">Unit</th>
      <th class="col-sqft">Sq Ft</th>
      <th class="col-opt">Options</th>
      <th class="col-total">Line Total</th>
      <th class="col-remove">Remove</th>
    </tr></thead>
    <tbody></tbody>
  </table></div>
  <div class="total">
    Customer: <span id="a-custOut">‚Äî</span><br/>
    Subtotal: ‚Ç±<span id="a-sub">0</span> ‚Ä¢ Discount: ‚Ç±<span id="a-discAmt">0</span> ‚Ä¢ VAT: ‚Ç±<span id="a-vatAmt">0</span><br/>
    <span style="font-size:18px">Grand Total: ‚Ç±<span id="a-grand">0</span></span>
  </div>
</section>

<!-- PUBLIC PANEL REMOVED -->

<!-- OWNER PANEL (hidden until unlocked) -->

<!-- SYNERGY COMBI VERTICAL PANEL -->
<section id="panel-synergy" class="panel theme-pvc">
  <div class="row">
    <label>Customer: <input id="s-cust" type="text" placeholder="Enter customer name"></label>
    <button type="button" id="s-add" class="btn">+ Add Item</button>
    <button type="button" class="btn" data-ghd-tab="synergy" onclick="GHD.openQuote('synergy')">üñ®Ô∏è Print Quote</button>
    <button type="button" class="btn" data-ghd-tab="synergy" onclick="GHD.exportQuote('synergy')">‚¨á Export Quote (.xlsx)</button>
  </div>
  <div class="muted">Synergy Combi Vertical: Line = Area √ó Final.</div>
  <div class="table-wrap"><table id="s-table">
    <thead><tr>
      <th class="col-idx">#</th>
      <th class="col-code">Code</th>
      <th class="col-code2">Exact Code</th>
      <th class="col-w">Width</th><th class="col-unit">Unit</th>
      <th class="col-h">Height</th><th class="col-unit">Unit</th>
      <th class="col-sqft">Sq Ft</th>
      <th class="col-total">Line Total</th>
      <th class="col-remove">Remove</th>
    </tr></thead>
    <tbody></tbody>
  </table></div>
  <div class="total">Customer: <span id="s-custOut">‚Äî</span> ‚Ä¢ Grand Total: ‚Ç±<span id="s-grand">0</span></div>
</section>

<!-- SHANGRILA BLINDS PANEL -->
<section id="panel-shangrila" class="panel theme-pvc">
  <div class="row">
    <label>Customer: <input id="g-cust" type="text" placeholder="Enter customer name"></label>
    <button type="button" id="g-add" class="btn">+ Add Item</button>
    <button type="button" class="btn" data-ghd-tab="shangrila" onclick="GHD.openQuote('shangrila')">üñ®Ô∏è Print Quote</button>
    <button type="button" class="btn" data-ghd-tab="shangrila" onclick="GHD.exportQuote('shangrila')">‚¨á Export Quote (.xlsx)</button>
  </div>
  <div class="muted">Shangrila Blinds: Line = Area √ó Final.</div>
  <div class="table-wrap"><table id="g-table">
    <thead><tr>
      <th class="col-idx">#</th>
      <th class="col-code">Code</th>
      <th class="col-code2">Exact Code</th>
      <th class="col-w">Width</th><th class="col-unit">Unit</th>
      <th class="col-h">Height</th><th class="col-unit">Unit</th>
      <th class="col-sqft">Sq Ft</th>
      <th class="col-total">Line Total</th>
      <th class="col-remove">Remove</th>
    </tr></thead>
    <tbody></tbody>
  </table></div>
  <div class="total">Customer: <span id="g-custOut">‚Äî</span> ‚Ä¢ Grand Total: ‚Ç±<span id="g-grand">0</span></div>
</section>

<!-- VENETIAN BLINDS PANEL -->
<section id="panel-venetian" class="panel theme-pvc">
  <div class="row">
    <label>Customer: <input id="v-cust" type="text" placeholder="Enter customer name"></label>
    <button type="button" id="v-add" class="btn">+ Add Item</button>
    <button type="button" class="btn" data-ghd-tab="venetian" onclick="GHD.openQuote('venetian')">üñ®Ô∏è Print Quote</button>
    <button type="button" class="btn" data-ghd-tab="venetian" onclick="GHD.exportQuote('venetian')">‚¨á Export Quote (.xlsx)</button>
  </div>
  <div class="muted">Venetian Blinds: Line = Area √ó Final.</div>
  <div class="table-wrap"><table id="v-table">
    <thead><tr>
      <th class="col-idx">#</th>
      <th class="col-code">Code</th>
      <th class="col-code2">Exact Code</th>
      <th class="col-w">Width</th><th class="col-unit">Unit</th>
      <th class="col-h">Height</th><th class="col-unit">Unit</th>
      <th class="col-sqft">Sq Ft</th>
      <th class="col-total">Line Total</th>
      <th class="col-remove">Remove</th>
    </tr></thead>
    <tbody></tbody>
  </table></div>
  <div class="total">Customer: <span id="v-custOut">‚Äî</span> ‚Ä¢ Grand Total: ‚Ç±<span id="v-grand">0</span></div>
</section>

<!-- REALWOOD BLINDS PANEL -->
<section id="panel-realwood" class="panel theme-pvc">
  <div class="row">
    <label>Customer: <input id="rw-cust" type="text" placeholder="Enter customer name"></label>
    <button type="button" id="rw-add" class="btn">+ Add Item</button>
    <button type="button" class="btn" data-ghd-tab="realwood" onclick="GHD.openQuote('realwood')">üñ®Ô∏è Print Quote</button>
    <button type="button" class="btn" data-ghd-tab="realwood" onclick="GHD.exportQuote('realwood')">‚¨á Export Quote (.xlsx)</button>
  </div>
  <div class="muted">Realwood Blinds: Line = Area √ó Final.</div>
  <div class="table-wrap"><table id="rw-table">
    <thead><tr>
      <th class="col-idx">#</th>
      <th class="col-code">Code</th>
      <th class="col-code2">Exact Code</th>
      <th class="col-w">Width</th><th class="col-unit">Unit</th>
      <th class="col-h">Height</th><th class="col-unit">Unit</th>
      <th class="col-sqft">Sq Ft</th>
      <th class="col-total">Line Total</th>
      <th class="col-remove">Remove</th>
    </tr></thead>
    <tbody></tbody>
  </table></div>
  <div class="total">Customer: <span id="rw-custOut">‚Äî</span> ‚Ä¢ Grand Total: ‚Ç±<span id="rw-grand">0</span></div>
</section>

<!-- CURTAINS - FABRIC REGISTRY PANEL -->
<section id="panel-curtains" class="panel theme-pvc">
  <div class="row">
    <label>Customer: <input id="ct-cust" type="text" placeholder="Enter customer name"></label>
    <button type="button" id="ct-add" class="btn">+ Add Item</button>
    <button type="button" class="btn" data-ghd-tab="curtains" onclick="GHD.openQuote('curtains')">üñ®Ô∏è Print Quote</button>
    <button type="button" class="btn" data-ghd-tab="curtains" onclick="GHD.exportQuote('curtains')">‚¨á Export Quote (.xlsx)</button>
  </div>
  <div class="muted">Curtains - Fabric Registry: Minimum area 28 ft¬≤. Line = Area √ó Final. Finish selectable.</div>
  <div class="table-wrap"><table id="ct-table">
    <thead><tr>
      <th class="col-idx">#</th>
      <th class="col-code">Code</th>
      <th class="col-code2">Exact Code</th>
      <th class="col-w">Width</th><th class="col-unit">Unit</th>
      <th class="col-h">Height</th><th class="col-unit">Unit</th>
      <th class="col-sqft">Sq Ft</th>
      <th class="col-opt">Finish</th>
      <th class="col-total">Line Total</th>
      <th class="col-remove">Remove</th>
    </tr></thead>
    <tbody></tbody>
  </table></div>
  <div class="total">Customer: <span id="ct-custOut">‚Äî</span> ‚Ä¢ Grand Total: ‚Ç±<span id="ct-grand">0</span></div>

<!-- Accordion & Screen (embedded public calculator) -->
</section>
<div id="ownerPanel">
  <header>
    <h3>‚öôÔ∏è Owner Panel ‚Äî Master Codes & Prices</h3>
    <div>
      <span class="pill">Final = Base √ó 2 + 20</span>
      <span class="pill">Shortcut: Ctrl/‚åò + Shift + P</span>
      <button type="button" id="ownerMinBtn" class="btn" title="Minimize panel">‚Äî Minimize</button> <button type="button" id="ownerMaxBtn" class="btn" title="Maximize panel">üóñ Maximize</button> <button type="button" id="ownerClose" class="btn danger">Close ‚úï</button>
    </div>
  </header>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <label>Passcode <input id="passcode" type="password" placeholder="Set/Enter passcode" value="gray2025"></label>
        <button type="button" id="saveLocal" class="btn ok">üíæ Save to Browser</button>
        <button type="button" id="exportJSON" class="btn">‚¨á Export JSON</button>
        <button type="button" id="exportXLSX" class="btn">‚¨á Export Excel (.xlsx ‚Äî includes Final)</button>
        <button type="button" id="exportFinal" class="btn">‚¨á Export Excel (with Final)</button>
        <input type="file" id="importFile" accept="application/json,.xlsx,.csv" style="display:none">
        <button type="button" id="importJSON" class="btn">‚¨Ü Import JSON</button>
        <button type="button" id="importXLSX" class="btn">‚¨Ü Import Excel/CSV</button>
      </div>
      <div class="muted">Your codes & prices are stored in this browser (localStorage). Export for backup or import to another device.</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;width:100%">
        <div><b>Master Codes</b>: Code ‚Ä¢ Base ‚Ç±/ft¬≤ ‚Ä¢ auto Final ‚Ä¢ Visibility (Combi / Roller / PVC / Public).</div>
        <button type="button" id="addMaster" class="btn">+ Add Code</button>
      </div>
      <div class="table-wrap">
        <table id="masterTable">
          <thead><tr>
            <th>Code</th>
            <th>Base ‚Ç±/ft¬≤</th>
            <th>Final (√ó2 + 20)</th>
            <th>Combi</th>
            <th>Roller</th>
            <th>PVC</th>
            <th>Public</th>
            <th>Synergy</th>
            <th>Shangrila</th>
            <th>Venetian</th>
            <th>Realwood</th>
            <th>Curtains</th>
            <th>Remove</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h4>Globals</h4>
      <div class="row">
        <label>Min ft¬≤ <input id="g-minsqft" type="number" value="15"></label>
        <label>Min Height (in) <input id="g-minh" type="number" value="36"></label>
        <label>Magic +/ft¬≤ <input id="g-magic" type="number" value="20"></label>
      </div>
    </div>
  </div>
</div>

<script>
// ======= Data layer (localStorage) =======
const DEFAULT_DATA = {
  globals: { min_sqft: 15, min_height_in: 36, magic_add_per_sqft: 20 },
  master: [
    { code: "N500", base: 100, show:{combi:true, roller:true, pvc:false, public:false} },
    { code: "B500", base: 110, show:{combi:true, roller:false, pvc:false, public:false} },
    { code: "W300", base: 95,  show:{combi:true, roller:false, pvc:false, public:false} },
    { code: "A4501", base: 120, show:{combi:false, roller:true, pvc:false, public:false} },
    { code: "PVC_BASIC", base: 80, show:{combi:false, roller:false, pvc:true, public:false} },
    { code: "P100", base: 1800, show:{combi:false, roller:false, pvc:false, public:true} }
  ]
};
function loadData(){
  const txt = localStorage.getItem("ghd_estimator_data");
  if(!txt) return structuredClone(DEFAULT_DATA);
  try { return JSON.parse(txt); } catch(e){ return structuredClone(DEFAULT_DATA); }
}
function saveData(data){ localStorage.setItem("ghd_estimator_data", JSON.stringify(data)); }
let DATA = loadData();
DATA.master.forEach(m=>{ m.show = m.show||{}; ['synergy','shangrila','venetian','realwood','curtains'].forEach(k=>{ if(typeof m.show[k] === 'undefined') m.show[k] = false; }); });

function finalFromBase(base){ return (+base||0)*2 + 20; }

// ======= Owner Panel =======
const ownerToggle = document.getElementById('ownerToggle');
const ownerPanel = document.getElementById('ownerPanel');
const ownerClose = document.getElementById('ownerClose');
const passcodeInput = document.getElementById('passcode');

function revealOwnerButton(){ ownerToggle.classList.add('shown'); }
function openOwnerPanel(){ ownerPanel.style.display = 'block'; }
function closeOwnerPanel(){ ownerPanel.style.display = 'none'; }

window.addEventListener('keydown', (e)=>{
  const isCombo = (e.shiftKey && (e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='p');
  if(isCombo){
    const input = prompt('Enter passcode to unlock Owner Panel:');
    const set = passcodeInput.value || 'gray2025';
    if(input === set){ revealOwnerButton(); openOwnerPanel(); localStorage.setItem('ghd_owner_unlocked','1'); }
    else alert('Incorrect passcode');
  }
});
(function(){
  const p = new URLSearchParams(location.search).get('admin');
  const h = location.hash.replace('#','');
  const pass = passcodeInput.value || 'gray2025';
  if(p===pass || h===('owner='+pass)){ revealOwnerButton(); openOwnerPanel(); localStorage.setItem('ghd_owner_unlocked','1'); }
  if(localStorage.getItem('ghd_owner_unlocked')==='1'){ revealOwnerButton(); }
})();

ownerToggle.addEventListener('click', openOwnerPanel);
ownerClose.addEventListener('click', closeOwnerPanel);

// Save/export/import
document.getElementById('saveLocal').addEventListener('click', ()=>{
  DATA.globals.min_sqft = +document.getElementById('g-minsqft').value||15;
  DATA.globals.min_height_in = +document.getElementById('g-minh').value||36;
  DATA.globals.magic_add_per_sqft = +document.getElementById('g-magic').value||20;
  saveData(DATA);
  alert('Saved to this browser.');
  rebuildAllDropdowns(); recalcAll();
});
document.getElementById('exportJSON').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(DATA,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ghd_estimator_data.json'; a.click();
  URL.revokeObjectURL(a.href);
});
document.getElementById('importJSON').addEventListener('click', ()=> document.getElementById('importFile').click());
document.getElementById('importFile').addEventListener('change', async (e)=>{
  const txt = await e.target.files[0].text();
  try{ DATA = JSON.parse(txt); saveData(DATA); alert('Imported.'); renderMaster(); rebuildAllDropdowns(); recalcAll(); }
  catch(err){ alert('Invalid JSON'); }
});

// Build master table
const masterT = document.getElementById('masterTable').querySelector('tbody');
function renderMaster(){
  document.getElementById('g-minsqft').value = DATA.globals.min_sqft;
  document.getElementById('g-minh').value = DATA.globals.min_height_in;
  document.getElementById('g-magic').value = DATA.globals.magic_add_per_sqft;
  masterT.innerHTML = '';
  for(const row of DATA.master){
    const final = finalFromBase(row.base);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" value="${row.code}" data-k="code" style="width:130px;height:34px;border:1px solid var(--bd);border-radius:6px;padding:4px"></td>
      <td><input type="number" value="${row.base}" data-k="base" style="width:120px;height:34px;border:1px solid var(--bd);border-radius:6px;padding:4px"></td>
      <td><input value="${final}" disabled style="width:130px;height:34px;border:1px dashed var(--bd);border-radius:6px;padding:4px;background:#f9fafb"></td>
      <td><input type="checkbox" data-k="combi" ${row.show.combi?'checked':''}></td>
      <td><input type="checkbox" data-k="roller" ${row.show.roller?'checked':''}></td>
      <td><input type="checkbox" data-k="pvc" ${row.show.pvc?'checked':''}></td>
      <td><input type="checkbox" data-k="public" ${row.show.public?'checked':''}></td>
      <td><input type="checkbox" data-k="synergy" ${row.show.synergy?'checked':''}></td>
      <td><input type="checkbox" data-k="shangrila" ${row.show.shangrila?'checked':''}></td>
      <td><input type="checkbox" data-k="venetian" ${row.show.venetian?'checked':''}></td>
      <td><input type="checkbox" data-k="realwood" ${row.show.realwood?'checked':''}></td>
      <td><input type="checkbox" data-k="curtains" ${row.show.curtains?'checked':''}></td>
      <td><button class="btn danger" data-del="1">Delete</button></td>
    `;
    masterT.appendChild(tr);
  }
}
renderMaster();

document.getElementById('addMaster').addEventListener('click', ()=>{
  DATA.master.push({code:'NEW_'+(DATA.master.length+1), base:0, show:{combi:true, roller:false, pvc:false, public:false}});
  renderMaster(); rebuildAllDropdowns(); recalcAll();
});

// Prevent re-render-on-keystroke; update only changed row
masterT.addEventListener('input', (e) => {
  const tr = e.target.closest('tr');
  if(!tr) return;
  const rows = Array.from(masterT.children);
  const idx = rows.indexOf(tr);
  if(idx < 0) return;

  // Read current row values
  const codeEl = tr.querySelector('[data-k="code"]');
  const baseEl = tr.querySelector('[data-k="base"]');
  const cEl = tr.querySelector('[data-k="combi"]');
  const rEl = tr.querySelector('[data-k="roller"]');
  const pEl = tr.querySelector('[data-k="pvc"]');
  const pubEl = tr.querySelector('[data-k="public"]');
  const synEl = tr.querySelector('[data-k="synergy"]');
  const shaEl = tr.querySelector('[data-k="shangrila"]');
  const venEl = tr.querySelector('[data-k="venetian"]');
  const rwEl = tr.querySelector('[data-k="realwood"]');
  const ctEl = tr.querySelector('[data-k="curtains"]');

  const updated = {
    code: (codeEl?.value || '').trim(),
    base: +(baseEl?.value || 0),
    show: { combi: !!(cEl?.checked), roller: !!(rEl?.checked), pvc: !!(pEl?.checked), public: !!(pubEl?.checked), synergy: !!(synEl?.checked), shangrila: !!(shaEl?.checked), venetian: !!(venEl?.checked), realwood: !!(rwEl?.checked), curtains: !!(ctEl?.checked) }
  };

  // Update in place
  DATA.master[idx] = updated;
  saveData(DATA);

  // Update the "Final" cell in this row if base changed
  const finalCell = tr.querySelector('td:nth-child(3) input');
  if(finalCell){ finalCell.value = finalFromBase(updated.base); }

  rebuildAllDropdowns();
  recalcAll();
});

masterT.addEventListener('click', (e)=>{
  if(e.target.dataset.del){
    const i=[...masterT.children].indexOf(e.target.closest('tr'));
    DATA.master.splice(i,1); saveData(DATA); renderMaster(); rebuildAllDropdowns(); recalcAll();
  }
});

// ======= Helpers =======
function toInches(val, unit){
  const v = +val||0;
  switch(unit){
    case 'cm': return v / 2.54;
    case 'mm': return v / 25.4;
    case 'ft': return v * 12;
    case 'm':  return v * 39.3701;
    default:   return v; // inches
  }
}
function sqftFromWH(w, wu, h, hu, minHIn){
  const W = toInches(w, wu);
  const H = Math.max(minHIn, toInches(h, hu));
  return (W*H)/144.0;
}
function fmt(n){ return (Math.round((+n||0))).toLocaleString('en-PH'); }
function getCodesFor(tab){
  if(tab==='combi') return DATA.master.filter(m => m.show.combi).map(m => m.code);
  if(tab==='roller') return DATA.master.filter(m => m.show.roller).map(m => m.code);
  if(tab==='pvc')    return DATA.master.filter(m => m.show.pvc).map(m => m.code);
  if(tab==='synergy') return DATA.master.filter(m => m.show.synergy).map(m => m.code);
  if(tab==='shangrila') return DATA.master.filter(m => m.show.shangrila).map(m => m.code);
  if(tab==='venetian') return DATA.master.filter(m => m.show.venetian).map(m => m.code);
  if(tab==='realwood') return DATA.master.filter(m => m.show.realwood).map(m => m.code);
  if(tab==='curtains') return DATA.master.filter(m => m.show.curtains).map(m => m.code);
  if(tab==='public') return DATA.master.filter(m => m.show.public).map(m => m.code);
  return [];
}
function getBase(code){
  const found = DATA.master.find(m => m.code === code);
  return found ? +found.base : 0;
}
function getFinal(code){ return finalFromBase(getBase(code)); }

function buildRowHTML(hasMagic=false, extras={}){
  const unitSel = `<select class="unit"><option>in</option><option>cm</option><option>mm</option><option>ft</option><option>m</option></select>`;
  return `
  <tr>
    <td class="col-idx"></td>
    <td class="col-code"><select class="code"></select></td>
    <td class="col-code2"><input type="text" class="codeExact" placeholder="Exact code (optional)"></td>
    ${extras.width!==false?`<td class="col-w"><input type="number" class="width" value="50" step="any"></td><td class="col-unit">${unitSel}</td>`:''}
    ${extras.height!==false?`<td class="col-h"><input type="number" class="height" value="72" step="any"></td><td class="col-unit">${unitSel}</td>`:''}
    ${extras.sqft!==false?`<td class="col-sqft sqft"></td>`:''}
    ${extras.chain?`<td class="col-add"><select class="chain">
      <option value="0">Plastic (free)</option>
      <option value="20">Brass +20/ft¬≤</option>
      <option value="20">Stainless +20/ft¬≤</option>
    </select></td>`:''}
    ${extras.btube?`<td class="col-add"><select class="btube">
      <option value="0">20mm Round (free / standard)</option>
      <option value="30">Hot Press close wrap + weight +30/ft¬≤</option>
      <option value="20">Hot Press open wrap no weight +20/ft¬≤</option>
      <option value="0">Rectangular BT (0)</option>
      <option value="4">Capsule no wrap +4/ft¬≤</option>
      <option value="20">Capsule full wrap +20/ft¬≤</option>
      <option value="30">62mm Oblong full wrap +30/ft¬≤</option>
      <option value="20">62mm Oblong no wrap +20/ft¬≤</option>
    </select></td>`:''}
    ${hasMagic?`<td class="col-add"><input type="checkbox" class="magic magicbox"></td>`:''}
    <td class="col-total line"></td>
    <td class="col-remove"><button class="btn">‚úï</button></td>
  </tr>`;
}
function rebuildDropdown($table, tab){
  const codes = getCodesFor(tab);
  $table.querySelectorAll('select.code').forEach(sel=>{
    const cur = sel.value;
    sel.innerHTML = codes.map(c=>`<option value="${c}">${c}</option>`).join('');
    if(codes.includes(cur)) sel.value = cur;
  });
}
function rebuildAllDropdowns(){
  const ct = document.getElementById('c-table'); if(ct) rebuildDropdown(ct, 'combi');
  const rt = document.getElementById('r-table'); if(rt) rebuildDropdown(rt, 'roller');
  const pt = document.getElementById('p-table'); if(pt) rebuildDropdown(pt, 'pvc');
  // public removed
  const st = document.getElementById('s-table'); if(st) rebuildDropdown(st, 'synergy');
  const gt = document.getElementById('g-table'); if(gt) rebuildDropdown(gt, 'shangrila');
  const vt = document.getElementById('v-table'); if(vt) rebuildDropdown(vt, 'venetian');
  const rwt = document.getElementById('rw-table'); if(rwt) rebuildDropdown(rwt, 'realwood');
  const ctt = document.getElementById('ct-table'); if(ctt) rebuildDropdown(ctt, 'curtains');
}

// Calculators

function recalcRealwood(){  const minSq = DATA.globals.min_sqft, minH = DATA.globals.min_height_in;

  const tbody = document.querySelector('#rw-table tbody');
  let i=0, sub=0;
  tbody.querySelectorAll('tr').forEach(tr=>{
    tr.querySelector('.col-idx').textContent = (++i);
    const code = tr.querySelector('select.code').value;
    const w = tr.querySelector('.width').value, wu = tr.querySelectorAll('.unit')[0].value;
    const h = tr.querySelector('.height').value, hu = tr.querySelectorAll('.unit')[1].value;
    const areaRaw = sqftFromWH(w,wu,h,hu,minH);
    const area = Math.max(minSq, areaRaw);
    tr.querySelector('.sqft').textContent = area.toFixed(2);
    const final = getFinal(code);
    const line = area * final;
    tr.querySelector('.line').textContent = '‚Ç±'+fmt(line);
    sub += line;
  });
  document.getElementById('rw-grand').textContent = fmt(sub);
  document.getElementById('rw-custOut').textContent = document.getElementById('rw-cust').value || '‚Äî';
}
function recalcCurtains(){
  const tbody = document.querySelector('#ct-table tbody');
  let i=0, sub=0;
  tbody.querySelectorAll('tr').forEach(tr=>{
    tr.querySelector('.col-idx').textContent = (++i);
    const code = tr.querySelector('select.code').value;
    const w = tr.querySelector('.width').value, wu = tr.querySelectorAll('.unit')[0].value;
    const h = tr.querySelector('.height').value, hu = tr.querySelectorAll('.unit')[1].value;
    const areaRaw = sqftFromWH(w,wu,h,hu,0);
    const area = Math.max(28, areaRaw); // minimum 28 ft¬≤
    tr.querySelector('.sqft').textContent = area.toFixed(2);
    const final = getFinal(code);
    const line = area * final;
    tr.querySelector('.line').textContent = '‚Ç±'+fmt(line);
    sub += line;
  });
  document.getElementById('ct-grand').textContent = fmt(sub);
  document.getElementById('ct-custOut').textContent = document.getElementById('ct-cust').value || '‚Äî';
}


function recalcSynergy(){  const minSq = DATA.globals.min_sqft, minH = DATA.globals.min_height_in;
const tbody=document.querySelector('#s-table tbody');let i=0,sub=0;tbody.querySelectorAll('tr').forEach(tr=>{tr.querySelector('.col-idx').textContent=(++i);const code=tr.querySelector('select.code').value;const w=tr.querySelector('.width').value, wu=tr.querySelectorAll('.unit')[0].value;const h=tr.querySelector('.height').value, hu=tr.querySelectorAll('.unit')[1].value;const areaRaw = sqftFromWH(w,wu,h,hu,minH);
    const area = Math.max(minSq, areaRaw);tr.querySelector('.sqft').textContent=area.toFixed(2);const final=getFinal(code);const line=area*final;tr.querySelector('.line').textContent='‚Ç±'+fmt(line);sub+=line;});document.getElementById('s-grand').textContent=fmt(sub);document.getElementById('s-custOut').textContent=document.getElementById('s-cust').value||'‚Äî';}

function recalcShangrila(){  const minSq = DATA.globals.min_sqft, minH = DATA.globals.min_height_in;
const tbody=document.querySelector('#g-table tbody');let i=0,sub=0;tbody.querySelectorAll('tr').forEach(tr=>{tr.querySelector('.col-idx').textContent=(++i);const code=tr.querySelector('select.code').value;const w=tr.querySelector('.width').value, wu=tr.querySelectorAll('.unit')[0].value;const h=tr.querySelector('.height').value, hu=tr.querySelectorAll('.unit')[1].value;const areaRaw = sqftFromWH(w,wu,h,hu,minH);
    const area = Math.max(minSq, areaRaw);tr.querySelector('.sqft').textContent=area.toFixed(2);const final=getFinal(code);const line=area*final;tr.querySelector('.line').textContent='‚Ç±'+fmt(line);sub+=line;});document.getElementById('g-grand').textContent=fmt(sub);document.getElementById('g-custOut').textContent=document.getElementById('g-cust').value||'‚Äî';}

function recalcVenetian(){  const minSq = DATA.globals.min_sqft, minH = DATA.globals.min_height_in;
const tbody=document.querySelector('#v-table tbody');let i=0,sub=0;tbody.querySelectorAll('tr').forEach(tr=>{tr.querySelector('.col-idx').textContent=(++i);const code=tr.querySelector('select.code').value;const w=tr.querySelector('.width').value, wu=tr.querySelectorAll('.unit')[0].value;const h=tr.querySelector('.height').value, hu=tr.querySelectorAll('.unit')[1].value;const areaRaw = sqftFromWH(w,wu,h,hu,minH);
    const area = Math.max(minSq, areaRaw);tr.querySelector('.sqft').textContent=area.toFixed(2);const final=getFinal(code);const line=area*final;tr.querySelector('.line').textContent='‚Ç±'+fmt(line);sub+=line;});document.getElementById('v-grand').textContent=fmt(sub);document.getElementById('v-custOut').textContent=document.getElementById('v-cust').value||'‚Äî';}


function recalcCombi(){
  const minSq = DATA.globals.min_sqft, minH = DATA.globals.min_height_in, addMagic = DATA.globals.magic_add_per_sqft;
  const tbody = document.querySelector('#c-table tbody');
  let i=0, sub=0;
  tbody.querySelectorAll('tr').forEach(tr=>{
    tr.querySelector('.col-idx').textContent = (++i);
    const code = tr.querySelector('select.code').value;
    const w = tr.querySelector('.width').value, wu = tr.querySelectorAll('.unit')[0].value;
    const h = tr.querySelector('.height').value, hu = tr.querySelectorAll('.unit')[1].value;
    const magic = tr.querySelector('.magic')?.checked;
    const area = Math.max(minSq, sqftFromWH(w,wu,h,hu,minH));
    tr.querySelector('.sqft').textContent = area.toFixed(2);
    const final = getFinal(code);
    const line = area * ( final + (magic?addMagic:0) );
    tr.querySelector('.line').textContent = '‚Ç±'+fmt(line);
    sub += line;
  });
  document.getElementById('c-grand').textContent = fmt(sub);
  document.getElementById('c-custOut').textContent = document.getElementById('c-cust').value || '‚Äî';
}
function recalcRoller(){  const minSq = DATA.globals.min_sqft, minH = DATA.globals.min_height_in, addMagic = DATA.globals.magic_add_per_sqft;
  const tbody = document.querySelector('#r-table tbody');
  let i=0, sub=0;
  tbody.querySelectorAll('tr').forEach(tr=>{
    tr.querySelector('.col-idx').textContent = (++i);
    const code = tr.querySelector('select.code').value;
    const w = tr.querySelector('.width').value, wu = tr.querySelectorAll('.unit')[0].value;
    const h = tr.querySelector('.height').value, hu = tr.querySelectorAll('.unit')[1].value;
    const area = Math.max(minSq, sqftFromWH(w,wu,h,hu,minH));
    tr.querySelector('.sqft').textContent = area.toFixed(2);
    const final = getFinal(code);
    const chain = +(tr.querySelector('.chain').value||0);
    const btube = +(tr.querySelector('.btube').value||0);
    const magic = tr.querySelector('.magic')?.checked;
    const line = area * ( final + chain + btube + (magic?addMagic:0) );
    tr.querySelector('.line').textContent = '‚Ç±'+fmt(line);
    sub += line;
  });
  document.getElementById('r-grand').textContent = fmt(sub);
  document.getElementById('r-custOut').textContent = document.getElementById('r-cust').value || '‚Äî';
}
function recalcPVC(){  const minSq = DATA.globals.min_sqft, minH = DATA.globals.min_height_in;

  const tbody = document.querySelector('#p-table tbody');
  let i=0, sub=0;
  tbody.querySelectorAll('tr').forEach(tr=>{
    tr.querySelector('.col-idx').textContent = (++i);
    const code = tr.querySelector('select.code').value;
    const w = tr.querySelector('.width').value, wu = tr.querySelectorAll('.unit')[0].value;
    const h = tr.querySelector('.height').value, hu = tr.querySelectorAll('.unit')[1].value;
    const areaRaw = sqftFromWH(w,wu,h,hu,minH);
    const area = Math.max(minSq, areaRaw);
    tr.querySelector('.sqft').textContent = area.toFixed(2);
    const final = getFinal(code);
    const line = area * final;
    tr.querySelector('.line').textContent = '‚Ç±'+fmt(line);
    sub += line;
  });
  document.getElementById('p-grand').textContent = fmt(sub);
  document.getElementById('p-custOut').textContent = document.getElementById('p-cust').value || '‚Äî';
}
function recalcPublic(){
  const tbody = document.querySelector('#pub-table tbody');
  if(!tbody) return;
  let i=0, sub=0;
  tbody.querySelectorAll('tr').forEach(tr=>{
    tr.querySelector('.col-idx').textContent = (++i);
    const code = tr.querySelector('select.code').value;
    const base = getBase(code);
    tr.querySelector('.line').textContent = '‚Ç±'+fmt(base);
    sub += base;
  });
  document.getElementById('pub-grand').textContent = fmt(sub);
}
function recalcAll(){ recalcCombi(); recalcRoller(); recalcPVC(); recalcSynergy(); recalcShangrila(); recalcVenetian(); recalcRealwood(); recalcCurtains(); recalcPublic(); }

// Add row helper
function addRow($table, tab, config){
  $table.querySelector('tbody').insertAdjacentHTML('beforeend', buildRowHTML(config.magic, config));
  const tr = $table.querySelector('tbody tr:last-child');
  const sel = tr.querySelector('select.code');
  sel.innerHTML = getCodesFor(tab).map(c=>`<option value="${c}">${c}</option>`).join('');
  tr.addEventListener('input', recalcAll);
  tr.querySelector('.btn').addEventListener('click', ()=>{ tr.remove(); recalcAll(); });
  recalcAll();
}

// Buttons add
document.getElementById('c-add').addEventListener('click',()=> addRow(document.getElementById('c-table'),'combi',{magic:true,width:true,height:true,sqft:true}));
document.getElementById('r-add').addEventListener('click',()=> addRow(document.getElementById('r-table'),'roller',{magic:true,width:true,height:true,sqft:true, chain:true, btube:true}));
document.getElementById('p-add').addEventListener('click',()=> addRow(document.getElementById('p-table'),'pvc',{magic:false,width:true,height:true,sqft:true}));
document.getElementById('s-add').addEventListener('click',()=> addRow(document.getElementById('s-table'),'synergy',{magic:false,width:true,height:true,sqft:true}));
document.getElementById('g-add').addEventListener('click',()=> addRow(document.getElementById('g-table'),'shangrila',{magic:false,width:true,height:true,sqft:true}));
document.getElementById('v-add').addEventListener('click',()=> addRow(document.getElementById('v-table'),'venetian',{magic:false,width:true,height:true,sqft:true}));
document.getElementById('rw-add').addEventListener('click',()=> addRow(document.getElementById('rw-table'),'realwood',{magic:false,width:true,height:true,sqft:true}));
document.getElementById('ct-add').addEventListener('click',()=> {
  const tbl = document.getElementById('ct-table');
  tbl.querySelector('tbody').insertAdjacentHTML('beforeend', `
  <tr>
    <td class='col-idx'></td>
    <td class='col-code'><select class='code'></select></td>
    <td class='col-code2'><input type='text' class='codeExact' placeholder='Exact code (optional)'></td>
    <td class='col-w'><input type='number' class='width' value='50' step='any'></td><td class='col-unit'><select class='unit'><option>in</option><option>cm</option><option>mm</option><option>ft</option><option>m</option></select></td>
    <td class='col-h'><input type='number' class='height' value='72' step='any'></td><td class='col-unit'><select class='unit'><option>in</option><option>cm</option><option>mm</option><option>ft</option><option>m</option></select></td>
    <td class='col-sqft sqft'></td>
    <td class='col-opt'><select class='finish'><option>Pleated</option><option>Ring</option><option>S fold</option></select></td>
    <td class='col-total line'></td>
    <td class='col-remove'><button class='btn'>‚úï</button></td>
  </tr>`);
  const tr = tbl.querySelector('tbody tr:last-child');
  const sel = tr.querySelector('select.code'); sel.innerHTML = getCodesFor('curtains').map(c=>`<option value='${c}'>${c}</option>`).join('');
  tr.addEventListener('input', recalcAll);
  tr.querySelector('.btn').addEventListener('click', ()=>{ tr.remove(); recalcAll(); });
  recalcAll();
});
document.getElementById('pub-add').addEventListener('click',()=> addRow(document.getElementById('pub-table'),'public',{magic:false,width:false,height:false,sqft:false}));

// initial rows
addRow(document.getElementById('c-table'),'combi',{magic:true,width:true,height:true,sqft:true});
addRow(document.getElementById('r-table'),'roller',{magic:true,width:true,height:true,sqft:true, chain:true, btube:true});
addRow(document.getElementById('p-table'),'pvc',{magic:false,width:true,height:true,sqft:true});
addRow(document.getElementById('s-table'),'synergy',{magic:false,width:true,height:true,sqft:true});
addRow(document.getElementById('g-table'),'shangrila',{magic:false,width:true,height:true,sqft:true});
addRow(document.getElementById('v-table'),'venetian',{magic:false,width:true,height:true,sqft:true});
addRow(document.getElementById('rw-table'),'realwood',{magic:false,width:true,height:true,sqft:true});
(function(){ const tbl=document.getElementById('ct-table'); const tbody=tbl.querySelector('tbody'); tbody.innerHTML=''; document.getElementById('ct-add').click(); })();
(()=>{ const tbl=document.getElementById('pub-table'); if(tbl){ addRow(tbl,'public',{magic:false,width:false,height:false,sqft:false}); } })();
// After save/import: rebuild dropdowns with combi filter
function rebuildAllDropdowns(){
  const ct = document.getElementById('c-table'); if(ct) rebuildDropdown(ct, 'combi');
  const rt = document.getElementById('r-table'); if(rt) rebuildDropdown(rt, 'roller');
  const pt = document.getElementById('p-table'); if(pt) rebuildDropdown(pt, 'pvc');
  // public removed
  const st = document.getElementById('s-table'); if(st) rebuildDropdown(st, 'synergy');
  const gt = document.getElementById('g-table'); if(gt) rebuildDropdown(gt, 'shangrila');
  const vt = document.getElementById('v-table'); if(vt) rebuildDropdown(vt, 'venetian');
  const rwt = document.getElementById('rw-table'); if(rwt) rebuildDropdown(rwt, 'realwood');
  const ctt = document.getElementById('ct-table'); if(ctt) rebuildDropdown(ctt, 'curtains');
}

// Tabs
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const tab = btn.dataset.tab;
    if(!tab) return;
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active', b===btn));
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    document.getElementById('panel-'+tab).classList.add('active');
  });
});
</script>

<!-- SheetJS for XLSX (falls back to CSV if offline) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
function masterToRows(){
  return DATA.master.map(m => ({
    Code: m.code || "",
    Base: +m.base || 0,
    "Final (√ó2 + 20)": Math.round(((+m.base||0) * 2) + 20),
    Combi: !!(m.show && m.show.combi),
    Roller: !!(m.show && m.show.roller),
    PVC: !!(m.show && m.show.pvc),
    Public: !!(m.show && m.show.public),
    Synergy: !!(m.show && m.show.synergy),
    Shangrila: !!(m.show && m.show.shangrila),
    Venetian: !!(m.show && m.show.venetian),
    Realwood: !!(m.show && m.show.realwood),
    Curtains: !!(m.show && m.show.curtains)
  }));
}
function rowsToMaster(rows){
  function asBool(v){
    if (typeof v === 'boolean') return v;
    if (v == null) return false;
    const s = String(v).trim().toLowerCase();
    return ['1','true','yes','y','t','x','checked'].includes(s);
  }
  const out = [];
  for (const r of rows){
    const code = (r['Code'] ?? r['code'] ?? '').toString().trim();
    if(!code) continue;
    const base = Number(r['Base'] ?? r['base'] ?? 0) || 0;
    out.push({
      code,
      base,
      show: {
        combi: asBool(r['Combi'] ?? r['combi']),
        roller: asBool(r['Roller'] ?? r['roller']),
        pvc: asBool(r['PVC'] ?? r['pvc']),
        public: asBool(r['Public'] ?? r['public']),
        synergy: asBool(r['Synergy'] ?? r['synergy']),
        shangrila: asBool(r['Shangrila'] ?? r['shangrila']),
        venetian: asBool(r['Venetian'] ?? r['venetian']),
        realwood: asBool(r['Realwood'] ?? r['realwood']),
        curtains: asBool(r['Curtains'] ?? r['curtains'])
      }
    });
  }
  return out;
}
function exportXLSX(){
  try{
    if(typeof XLSX === 'undefined') throw new Error('no_xlsx');
    const ws = XLSX.utils.json_to_sheet(masterToRows());
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Pricing');
    const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
    const blob = new Blob([wbout], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'pricing.xlsx'; a.click(); URL.revokeObjectURL(a.href);
  }catch(e){
    // Fallback: CSV
    const rows = masterToRows();
    const headers = ['Code','Base','Combi','Roller','PVC','Public','Synergy','Shangrila','Venetian','Realwood','Curtains'];
    const csv = [headers.join(',')].concat(rows.map(r=>headers.map(h=>r[h]).join(','))).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'pricing.csv'; a.click(); URL.revokeObjectURL(a.href);
    alert('Could not load Excel library, exported CSV instead.');
  }
}
async function importFromFile(file){
  const ext = (file.name.split('.').pop()||'').toLowerCase();
  const buf = await file.arrayBuffer();
  let rows = [];
  if (ext === 'xlsx' || ext === 'xls'){
    if(typeof XLSX === 'undefined'){ alert('Excel library not available; please go online or import CSV/JSON.'); return; }
    const wb = XLSX.read(buf, {type:'array'});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    rows = XLSX.utils.sheet_to_json(sheet);
  } else if (ext === 'csv'){
    const text = new TextDecoder().decode(buf);
    const lines = text.split(/\r?\n/).filter(Boolean);
    const headers = lines.shift().split(',').map(h=>h.trim());
    for(const line of lines){
      const vals = line.split(',');
      const obj = {};
      headers.forEach((h,i)=> obj[h] = (vals[i]||'').trim());
      rows.push(obj);
    }
  } else if (ext === 'json'){
    const text = new TextDecoder().decode(buf);
    try{ const parsed = JSON.parse(text); if(parsed.master) { DATA = parsed; saveData(DATA); renderMaster(); rebuildAllDropdowns(); recalcAll(); return; } else rows = parsed; }catch(e){ alert('Invalid JSON'); return; }
  } else {
    alert('Unsupported file type. Use .xlsx, .csv, or .json'); return;
  }
  const master = rowsToMaster(rows);
  if (!master.length){ alert('No rows found. Expect columns: Code, Base, Combi, Roller, PVC, Public.'); return; }
  DATA.master = master;
  saveData(DATA);
  renderMaster(); rebuildAllDropdowns(); recalcAll();
}
document.addEventListener('DOMContentLoaded', () => {
  const importBtn = document.getElementById('importXLSX');
  const exportBtn = document.getElementById('exportXLSX');
  const fileInput = document.getElementById('importFile');
  if (exportBtn) exportBtn.addEventListener('click', exportXLSX);
  if (importBtn) importBtn.addEventListener('click', ()=> fileInput.click());
  if (fileInput) fileInput.addEventListener('change', e => { const f = e.target.files?.[0]; if(f) importFromFile(f); e.target.value = ''; });
});
</script>


<script>
(function(){
  // Delegated click handler so dynamically added buttons work too
  const tabsBar = document.querySelector('.tabs');
  function activate(tab){
    if(!tab) return;
    document.querySelectorAll('.tab-btn').forEach(b=>{
      b.classList.toggle('active', b.dataset.tab === tab);
    });
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    const pnl = document.getElementById('panel-'+tab);
    if(pnl) pnl.classList.add('active');
    window.scrollTo({top:0, behavior:'smooth'});
  }
  if(tabsBar){
    tabsBar.addEventListener('click', (e)=>{
      const btn = e.target.closest('.tab-btn[data-tab]');
      if(!btn) return;
      e.preventDefault();
      activate(btn.dataset.tab);
    });
  }

  // Optional: keyboard access with 1-4
  const order = ['all','combi','roller','pvc','other','synergy','shangrila','venetian','realwood','curtains'];
  window.addEventListener('keydown', (e)=>{
    if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA')) return;
    const idx = parseInt(e.key,10)-1;
    if(idx>=0 && idx<order.length){ activate(order[idx]); }
  });
})();
</script>





<script>
// ======== ALL PRODUCTS (mixed) ========
function allGetCodesFor(product){
  if(product==='Combi')  return DATA.master.filter(m => m.show.combi).map(m=>m.code);
  if(product==='Roller') return DATA.master.filter(m => m.show.roller).map(m=>m.code);
  if(product==='PVC')    return DATA.master.filter(m => m.show.pvc).map(m=>m.code);
  if(product==='Synergy Combi Vertical') return DATA.master.filter(m => m.show.synergy).map(m=>m.code);
  if(product==='Shangrila Blinds') return DATA.master.filter(m => m.show.shangrila).map(m=>m.code);
  if(product==='Venetian Blinds') return DATA.master.filter(m => m.show.venetian).map(m=>m.code);
  if(product==='Realwood Blinds') return DATA.master.filter(m => m.show.realwood).map(m=>m.code);
  if(product==='Curtains - Fabric Registry') return DATA.master.filter(m => m.show.curtains).map(m=>m.code);
  if(product==='Polycarbonate' || product==='Polycarbonate Accordion' || product==='Pleated Screen' || product==='Security Screen (Lock Included)' || product==='Top-to-Bottom Screen' || product==='Honeycomb'){
    const M = DATA.master || [];
    return M.map(m=>m.code);
  }

  return (DATA.master||[]).map(m=>m.code);
  if(product==='Regular Accordion Door' || product==='French Accordion Door' || product==='Pleated Mesh' || product==='Security Screen'){
    const M = DATA.master || [];
    return M.map(m=>m.code);
  }

}
function buildAllRow(){
  const unitSel = `<select class="unit"><option>in</option><option>cm</option><option>mm</option><option>ft</option><option>m</option></select>`;
  const typeSel = `<select class="type">
    <option>Combi</option>
    <option>Roller</option>
    <option>PVC</option>
    <option>Synergy Combi Vertical</option>
    <option>Shangrila Blinds</option>
    <option>Venetian Blinds</option>
    <option>Realwood Blinds</option>
    <option>Curtains - Fabric Registry</option>
    <option>Regular Accordion Door One Way</option>
    <option>Regular Accordion Door Two Way</option>
    <option>French Accordion Door One Way</option>
    <option>French Accordion Door Two Way</option>
    <option>Polycarbonate Accordion Door One Way</option>
    <option>Polycarbonate Accordion Door Two Way</option>
    <option>Pleated Mesh One Way</option>
    <option>Pleated Mesh Two Way</option>
    <option>Security Screen One Way</option>
    <option>Security Screen Two Way</option>
    <option>Top to Bottom Screen</option>
    <option>Honeycomb Only One Way</option>
    <option>Honeycomb Only Two Way</option>
    <option>Honeycomb Combination with Screen</option>
</select>`;
  const codeSel = `<select class="code"></select>`;
  
  const opts = `<div class="opts">
    <!-- Combi options -->
    <label class="opt-combi" style="display:none"><input type="checkbox" class="magic"> Magic (+‚Ç±20/ft¬≤)</label>
    <!-- Roller options -->
    <div class="opt-roller row" style="gap:6px; display:none; grid-template-columns:1fr 1fr 1fr">
      <select class="chain">
        <option value="0">Plastic (free)</option>
        <option value="20">Brass +20/ft¬≤</option>
        <option value="20">Stainless +20/ft¬≤</option>
      </select>
      <select class="btube">
        <option value="0">20mm Round (free / standard)</option>
        <option value="30">Hot Press close wrap + weight +30/ft¬≤</option>
        <option value="20">Hot Press open wrap no weight +20/ft¬≤</option>
        <option value="0">Rectangular BT (0)</option>
        <option value="4">Capsule no wrap +4/ft¬≤</option>
        <option value="20">Capsule full wrap +20/ft¬≤</option>
        <option value="30">62mm Oblong full wrap +30/ft¬≤</option>
        <option value="20">62mm Oblong no wrap +20/ft¬≤</option>
      </select>
      <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" class="magic"> Magic</label>
    </div>
    <!-- Polycarbonate options -->
    <div class="opt-polycarb row" style="gap:6px; display:none">
      <label></label>
    </div>
    <!-- Accordion options -->
    <div class="opt-accordion row" style="gap:6px; display:none; grid-template-columns:1fr 1fr 1fr">
      <label>Style 
        <select class="acc-style">
          <option value="regular">Regular</option>
          <option value="french">French</option>
        </select>
      </label>
      <label></label>
      <label><input type="checkbox" class="lock"> Lock (+‚Ç±1,000)</label>
    </div>
    <!-- Pleated options -->
    <div class="opt-pleated row" style="gap:6px; display:none">
      <label>Type 
        <select class="pl-type">
          <option>One-Way</option>
          <option>Two-Way</option>
        </select>
      </label>
    </div>
    <!-- Security options -->
    <div class="opt-security row" style="gap:6px; display:none">
      <label>Type 
        <select class="sec-type">
          <option>One-Way</option>
          <option>Two-Way</option>
        </select>
      </label>
    </div>
    <!-- T2B options -->
    <div class="opt-t2b row" style="gap:6px; display:none">
      <span class="muted">Top-to-Bottom screen</span>
    </div>
    <!-- Honeycomb options -->
    <div class="opt-honey row" style="gap:6px; display:none">
      <label>Type 
        <select class="hc-type">
          <option>One-Way</option>
          <option>Two-Way</option>
          <option>With Screen</option>
        </select>
      </label>
    </div>
  </div>`;

  return `<tr>
    <td class="col-idx"></td>
    <td class="col-type">${typeSel}</td>
    <td class="col-code">${codeSel}</td>
    <td class="col-code2"><input type="text" class="codeExact" placeholder="Exact code (optional)"></td>
    <td class="col-room"><input type="text" class="room" placeholder="Living / Kitchen / etc."></td>
    <td class="col-w"><input type="number" class="width" value="50" step="any"></td>
    <td class="col-unit">${unitSel}</td>
    <td class="col-h"><input type="number" class="height" value="72" step="any"></td>
    <td class="col-unit">${unitSel}</td>
    <td class="col-sqft sqft"></td>
    <td class="col-opt">${opts}</td>
    <td class="col-total line"></td>
    <td class="col-remove"><button class="btn">‚úï</button></td>
  </tr>`;
}
function allShowOptions(tr, product){
  tr.querySelectorAll('.opts > *').forEach(x=> x.style.display='none');
  tr.querySelector('.opt-combi')?.setAttribute('style', product==='Combi' ? 'display:block' : 'display:none');
  tr.querySelector('.opt-roller')?.setAttribute('style', product==='Roller' ? 'display:grid; gap:6px; grid-template-columns:1fr 1fr 1fr' : 'display:none');
  tr.querySelector('.opt-poly')?.setAttribute('style', product==='Polycarbonate' ? 'display:grid; gap:6px; grid-template-columns:1fr' : 'display:none');
tr.querySelector('.opt-curtains')?.setAttribute('style', product==='Curtains - Fabric Registry' ? 'display:grid; gap:6px; grid-template-columns:1fr' : 'display:none');
  
  tr.querySelector('.opt-accordion')?.setAttribute('style', product==='Polycarbonate Accordion' ? 'display:grid; gap:6px; grid-template-columns:1fr 1fr 1fr' : 'display:none');
  tr.querySelector('.opt-pleated')?.setAttribute('style', product==='Pleated Screen' ? 'display:grid; gap:6px; grid-template-columns:1fr' : 'display:none');
  tr.querySelector('.opt-security')?.setAttribute('style', product==='Security Screen (Lock Included)' ? 'display:grid; gap:6px; grid-template-columns:1fr' : 'display:none');
  tr.querySelector('.opt-t2b')?.setAttribute('style', product==='Top-to-Bottom Screen' ? 'display:grid; gap:6px; grid-template-columns:1fr' : 'display:none');
  tr.querySelector('.opt-honey')?.setAttribute('style', product==='Honeycomb' ? 'display:grid; gap:6px; grid-template-columns:1fr' : 'display:none');

  
  // Visibility for aliases/extra labels
  if(product==='Regular Accordion Door' || product==='French Accordion Door' || product==='Polycarbonate Accordion'){
    tr.querySelector('.opt-accordion')?.setAttribute('style','display:grid; gap:6px; grid-template-columns:1fr 1fr 1fr');
  }
  if(product==='Pleated Mesh' || product==='Pleated Screen'){
    tr.querySelector('.opt-pleated')?.setAttribute('style','display:grid; gap:6px; grid-template-columns:1fr');
  }
  if(product==='Security Screen' || product==='Security Screen (Lock Included)'){
    tr.querySelector('.opt-security')?.setAttribute('style','display:grid; gap:6px; grid-template-columns:1fr');
  }
  if(product==='Top-to-Bottom Screen'){
    tr.querySelector('.opt-t2b')?.setAttribute('style','display:grid; gap:6px; grid-template-columns:1fr');
  }
  if(product==='Honeycomb'){
    tr.querySelector('.opt-honey')?.setAttribute('style','display:grid; gap:6px; grid-template-columns:1fr');
  }
  // Preset style lock for Regular/French types
  const s = tr.querySelector('.opt-accordion .acc-style');
  if(s){
    if(product==='Regular Accordion Door'){ s.value='regular'; s.disabled = true; }
    else if(product==='French Accordion Door'){ s.value='french'; s.disabled = true; }
    else { s.disabled = false; }
  }

  tr.querySelector('.opt-polycarb')?.style.setProperty('display','grid');
  tr.querySelector('.col-code').style.display = (product==='Combi' || product==='Roller' || product==='PVC' || product==='Synergy Combi Vertical' || product==='Shangrila Blinds' || product==='Venetian Blinds' || product==='Realwood Blinds' || product==='Curtains - Fabric Registry') ? '' : 'none';
}
function allRebuildCode(tr){
  const product = tr.querySelector('.type').value;
  const sel = tr.querySelector('select.code');
  if(!sel) return;
  const cur = sel.value;
  const items = allGetCodesFor(product);
  sel.innerHTML = items.map(c=>`<option value="${c}">${c}</option>`).join('');
  if(items.includes(cur)) sel.value = cur;
}
function allAddRow(){
  const tbody = document.querySelector('#a-table tbody');
  tbody.insertAdjacentHTML('beforeend', buildAllRow());
  const tr = tbody.lastElementChild;
  // default product is Combi
  allShowOptions(tr, 'Combi');
  allRebuildCode(tr);
  tr.addEventListener('input', recalcAllMixed);
  tr.querySelector('.type').addEventListener('change', () => { allShowOptions(tr, tr.querySelector('.type').value); allRebuildCode(tr); recalcAllMixed(); });
  tr.querySelector('.btn').addEventListener('click', ()=>{ tr.remove(); recalcAllMixed(); });
  recalcAllMixed();
}
function recalcAllMixed(){
  const minSq = DATA.globals.min_sqft, minH = DATA.globals.min_height_in, addMagic = DATA.globals.magic_add_per_sqft;
  const tbody = document.querySelector('#a-table tbody');
  let i=0, sub=0;
  tbody.querySelectorAll('tr').forEach(tr=>{
    tr.querySelector('.col-idx').textContent = (++i);
    const product = tr.querySelector('.type').value;
    const w = +tr.querySelector('.width').value || 0, wu = tr.querySelectorAll('.unit')[0].value;
    const h = +tr.querySelector('.height').value || 0, hu = tr.querySelectorAll('.unit')[1].value;
    const W = toInches(w, wu), H = toInches(h, hu);
    let area = (W*H)/144.0;
    let line = 0, note = '';
    if(product==='Combi'){
      area = Math.max(minSq, sqftFromWH(w,wu,h,hu,minH));
      const code = tr.querySelector('select.code').value;
      const final = getFinal(code);
      const hasMagic = tr.querySelector('.opt-combi .magic')?.checked;
      line = area * (hasMagic ? (final + addMagic) : final);
    } else if(product==='Roller'){
      area = Math.max(minSq, sqftFromWH(w,wu,h,hu,minH));
      const code = tr.querySelector('select.code').value;
      const final = getFinal(code);
      const chain = +(tr.querySelector('.opt-roller .chain').value||0);
      const btube = +(tr.querySelector('.opt-roller .btube').value||0);
      const hasMagic = tr.querySelector('.opt-roller .magic')?.checked;
      line = area * ( (final + chain + btube) + (hasMagic?addMagic:0) );
    } else if(product==='PVC'){
      area = Math.max(minSq, sqftFromWH(w,wu,h,hu,minH));
      const code = tr.querySelector('select.code').value;
      const final = getFinal(code);
      line = area * final;
    } else if(product==='Synergy Combi Vertical' || product==='Shangrila Blinds' || product==='Venetian Blinds' || product==='Realwood Blinds'){
      area = sqftFromWH(w,wu,h,hu,0);
      const code = tr.querySelector('select.code').value;
      const final = getFinal(code);
      line = area * final;
    } else if(product==='Curtains - Fabric Registry'){
      area = sqftFromWH(w,wu,h,hu,0);
      area = Math.max(28, area);
      const code = tr.querySelector('select.code').value;
      const final = getFinal(code);
      const finish = tr.querySelector('.opt-curtains .finish')?.value;
      line = area * final;
    } else if(product==='Polycarbonate'){
      // Replicate the polycarbonate calc (totals-only)
      if(H > 120){ line = 0; note = 'Not allowed'; }
    else if(product==='Polycarbonate Accordion'){
      const code = tr.querySelector('select.code').value;
      const final = getFinal(code);
      const Hi = toInches(h,hu);
      let Huse = 84; if(Hi<=84) Huse=84; else if(Hi<=96) Huse=96; else if(Hi<=108) Huse=108; else Huse=120;
      area = Math.max(20, (toInches(w,wu)*Huse)/144.0);
      const style = tr.querySelector('.opt-accordion .acc-style')?.value || 'regular';
      const opening = tr.querySelector('.opt-accordion .opening')?.value || 'one-way';
      let openFee = 0;
      if(opening==='one-way') openFee = (style==='french')?1200:1000; else openFee = (style==='french')?2400:2000;
      const lockFee = tr.querySelector('.opt-accordion .lock')?.checked ? 1000 : 0;
      line = area * final + openFee + lockFee;
    }
    else if(product==='Regular Accordion Door' || product==='French Accordion Door'){
      const code = tr.querySelector('select.code').value;
      const final = getFinal(code);
      const Hi = toInches(h,hu);
      let Huse = 84; if(Hi<=84) Huse=84; else if(Hi<=96) Huse=96; else if(Hi<=108) Huse=108; else Huse=120;
      area = Math.max(20, (toInches(w,wu)*Huse)/144.0);
      const style = (product==='French Accordion Door') ? 'french' : 'regular';
      const opening = tr.querySelector('.opt-accordion .opening')?.value || 'one-way';
      let openFee = 0;
      if(opening==='one-way') openFee = (style==='french')?1200:1000; else openFee = (style==='french')?2400:2000;
      const lockFee = tr.querySelector('.opt-accordion .lock')?.checked ? 1000 : 0;
      line = area * final + openFee + lockFee;
    }
    else if(product==='Pleated Screen'){
      const code = tr.querySelector('select.code').value;
      const final = getFinal(code);
      area = Math.max(15, sqftFromWH(w,wu,h,hu,0));
      line = area * final;
    }
    else if(product==='Pleated Mesh'){
      const code = tr.querySelector('select.code').value;
      const final = getFinal(code);
      area = Math.max(15, sqftFromWH(w,wu,h,hu,0));
      line = area * final;
    }
    else if(product==='Security Screen (Lock Included)'){
      const code = tr.querySelector('select.code').value;
      const final = getFinal(code);
      area = Math.max(20, sqftFromWH(w,wu,h,hu,0));
      const t = tr.querySelector('.opt-security .sec-type')?.value || 'Two-Way';
      const twoWayFee = (t==='Two-Way') ? 3000 : 0;
      line = area * final + twoWayFee;
    }
    else if(product==='Security Screen'){
      const code = tr.querySelector('select.code').value;
      const final = getFinal(code);
      area = Math.max(20, sqftFromWH(w,wu,h,hu,0));
      const t = tr.querySelector('.opt-security .sec-type')?.value || 'Two-Way';
      const twoWayFee = (t==='Two-Way') ? 3000 : 0;
      line = area * final + twoWayFee;
    }
    else if(product==='Top-to-Bottom Screen'){
      const code = tr.querySelector('select.code').value;
      const final = getFinal(code);
      area = Math.max(15, sqftFromWH(w,wu,h,hu,0));
      line = area * final;
    }
    else if(product==='Honeycomb'){
      const code = tr.querySelector('select.code').value;
      const final = getFinal(code);
      area = Math.max(20, sqftFromWH(w,wu,h,hu,0));
      line = area * final;
    }

      let h_ft = H/12, adj_ft = (h_ft <=7 ? 7 : h_ft <=8 ? 8 : h_ft <=9 ? 9 : 10);
      const adj_in = adj_ft * 12; const areaAdj = (W * adj_in) / 144; const sqftCharge = Math.max(20, areaAdj);
      const opening = tr.querySelector('.opt-poly .opening')?.value || 'one-way';
      const rate = 750;
      const addOpening = (opening === "two-way") ? (1200 + 3000) : 1200;
      line = (note==='Not allowed') ? 0 : Math.round(sqftCharge * rate + addOpening);
    }
    tr.querySelector('.sqft').textContent = (area>0?area.toFixed(2):'0.00');
    tr.querySelector('.line').textContent = note ? note : ('‚Ç±'+fmt(line));
    sub += (note ? 0 : line);
  });
  document.getElementById('a-sub').textContent = fmt(sub);
  const discPct = (+document.getElementById('a-disc').value||0)/100;
  const vatPct = (+document.getElementById('a-vat').value||0)/100;
  const discAmt = sub*discPct; const vatAmt = (sub-discAmt)*vatPct;
  document.getElementById('a-discAmt').textContent = fmt(discAmt);
  document.getElementById('a-vatAmt').textContent = fmt(vatAmt);
  document.getElementById('a-grand').textContent = fmt(sub - discAmt + vatAmt);
  document.getElementById('a-custOut').textContent = document.getElementById('a-cust').value || '‚Äî';
}

// Wire buttons
document.getElementById('a-add')?.addEventListener('click', allAddRow);

// Add one starter row
allAddRow();

// Rebuild codes when master changes
const _oldRebuild = rebuildAllDropdowns;
rebuildAllDropdowns = function(){
  _oldRebuild();
  document.querySelectorAll('#a-table tbody tr').forEach(tr=> allRebuildCode(tr));
};
</script>


<!-- Other Products (embedded exactly as provided) -->
<section id="panel-other" class="panel">
  
    <button id="mpFabBtn" title="Edit Main Product Prices"
      style="position:fixed;right:18px;bottom:18px;z-index:9999;background:#2563eb;color:#fff;
             border:0;border-radius:12px;padding:12px 16px;font-weight:700;
             box-shadow:0 10px 24px rgba(0,0,0,.25);">
      üíº Main Product Prices
    </button>
    
<iframe loading="lazy"  srcdoc="&lt;!doctype html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;utf-8&quot; /&gt;
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot; /&gt;
  &lt;title&gt;All-in-One Estimator ‚Äî Public (Totals Only)&lt;/title&gt;
  &lt;style&gt;
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Noto Sans; }
    body { margin: 0; background: #0f172a; color: #e5e7eb; }
    .container { max-width: 1100px; margin: 24px auto; padding: 16px; }
    .card { background: #111827; border-radius: 16px; padding: 20px; box-shadow: 0 10px 24px rgba(0,0,0,.3); }
    h1 { margin: 0 0 10px; font-size: 22px; }
    .muted { color: #9ca3af; margin: 0 0 10px; }
    .grid { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 12px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 640px) { .grid { grid-template-columns: 1fr; } }
    label { display:block; font-size:12px; color:#cbd5e1; margin-bottom:6px; }
    input, select { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #1f2937; background:#0b1220; color:#e5e7eb; }
    .products { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 16px; margin-top: 16px; }
    @media (max-width: 900px) { .products { grid-template-columns: 1fr; } }
    .product { background:#0b1220; border:1px solid #1f2937; border-radius:16px; padding:16px; }
    .product h2 { margin:0 0 8px; font-size:18px; }
    .note { font-size:12px; color:#a3e635; margin:6px 0 0; }
    .result { background:#0a0f1c; border:1px dashed #1f2937; border-radius:12px; padding:12px; margin-top:10px; min-height:48px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .total { font-weight:800; }
    .quote { background:#111827; color:#fff; border-radius:12px; padding:12px; margin-top:10px; white-space:pre-wrap; min-height:64px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 640px) { .row { grid-template-columns: 1fr; } }
    .btn { background:#059669; color:#fff; padding:10px 16px; border-radius:10px; border:none; cursor:pointer; font-weight:700; }
    .summary { margin-top:18px; }
    /* Hide all technical details completely */
    .small, .kv { display:none !important; }
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div class=&quot;container&quot;&gt;
    &lt;div class=&quot;card&quot;&gt;
      &lt;h1&gt;All-in-One Estimator&lt;/h1&gt;
      &lt;p class=&quot;muted&quot;&gt;Enter client + size. This public view shows **totals only** and basic &quot;allowed/not allowed&quot; notes ‚Äî no per‚Äësqft rates or internal formulas.&lt;/p&gt;
      &lt;div class=&quot;grid&quot;&gt;
        &lt;div&gt;
          &lt;label&gt;Client Name&lt;/label&gt;
          &lt;input id=&quot;client_name&quot; type=&quot;text&quot; placeholder=&quot;Enter client name&quot; /&gt;
        &lt;/div&gt;
        &lt;div&gt;
          &lt;label&gt;Width&lt;/label&gt;
          &lt;input id=&quot;width&quot; type=&quot;number&quot; step=&quot;0.01&quot; placeholder=&quot;Enter width&quot; /&gt;
        &lt;/div&gt;
        &lt;div&gt;
          &lt;label&gt;Height&lt;/label&gt;
          &lt;input id=&quot;height&quot; type=&quot;number&quot; step=&quot;0.01&quot; placeholder=&quot;Enter height&quot; /&gt;
        &lt;/div&gt;
        &lt;div&gt;
          &lt;label&gt;Unit&lt;/label&gt;
          &lt;select id=&quot;unit&quot;&gt;
            &lt;option value=&quot;mm&quot;&gt;mm&lt;/option&gt;
            &lt;option value=&quot;cm&quot;&gt;cm&lt;/option&gt;
            &lt;option value=&quot;m&quot;&gt;m&lt;/option&gt;
            &lt;option value=&quot;in&quot;&gt;in&lt;/option&gt;
            &lt;option value=&quot;ft&quot;&gt;ft&lt;/option&gt;
          &lt;/select&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class=&quot;products&quot;&gt;
      &lt;section class=&quot;product&quot; id=&quot;accordion&quot;&gt;
        &lt;h2&gt;Accordion Door (Regular / French)&lt;/h2&gt;
        &lt;div class=&quot;row&quot;&gt;
          &lt;div&gt;
            &lt;label&gt;Style&lt;/label&gt;
            &lt;select id=&quot;ad_style&quot;&gt;
              &lt;option value=&quot;regular&quot;&gt;Regular&lt;/option&gt;
              &lt;option value=&quot;french&quot;&gt;French&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;
          &lt;div&gt;
            &lt;label&gt;Opening&lt;/label&gt;
            &lt;select id=&quot;ad_opening&quot;&gt;
              &lt;option value=&quot;one-way&quot;&gt;One-Way&lt;/option&gt;
              &lt;option value=&quot;two-way&quot;&gt;Two-Way (Center)&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;result&quot;&gt;&lt;div id=&quot;ad_note&quot;&gt;&lt;/div&gt;&lt;div class=&quot;total&quot; id=&quot;ad_total&quot;&gt;&lt;/div&gt;&lt;/div&gt;
        &lt;div class=&quot;quote&quot; id=&quot;ad_quote&quot;&gt;&lt;/div&gt;
        &lt;button class=&quot;btn&quot; onclick=&quot;copyQuote(&#x27;ad_quote&#x27;)&quot;&gt;Copy Message&lt;/button&gt;
      &lt;/section&gt;

      &lt;section class=&quot;product&quot; id=&quot;polycarbonate&quot;&gt;
        &lt;h2&gt;Polycarbonate Accordion&lt;/h2&gt;
        &lt;div class=&quot;row&quot;&gt;
          &lt;div&gt;
            &lt;label&gt;Opening&lt;/label&gt;
            &lt;select id=&quot;pc_opening&quot;&gt;
              &lt;option value=&quot;one-way&quot;&gt;One-Way&lt;/option&gt;
              &lt;option value=&quot;two-way&quot;&gt;Two-Way (Center)&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;
          &lt;div&gt;
            &lt;label&gt;Type&lt;/label&gt;
            &lt;select id=&quot;pc_type&quot;&gt;
              &lt;option value=&quot;frosted&quot;&gt;Frosted&lt;/option&gt;
              &lt;option value=&quot;transparent&quot;&gt;Transparent&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;note&quot; id=&quot;pc_note&quot;&gt;&lt;/div&gt;
        &lt;div class=&quot;result&quot;&gt;&lt;div id=&quot;pc_note2&quot;&gt;&lt;/div&gt;&lt;div class=&quot;total&quot; id=&quot;pc_total&quot;&gt;&lt;/div&gt;&lt;/div&gt;
        &lt;div class=&quot;quote&quot; id=&quot;pc_quote&quot;&gt;&lt;/div&gt;
        &lt;button class=&quot;btn&quot; onclick=&quot;copyQuote(&#x27;pc_quote&#x27;)&quot;&gt;Copy Message&lt;/button&gt;
      &lt;/section&gt;

      &lt;section class=&quot;product&quot; id=&quot;pleated&quot;&gt;
        &lt;h2&gt;Pleated Screen&lt;/h2&gt;
        &lt;div class=&quot;row&quot;&gt;
          &lt;div&gt;
            &lt;label&gt;Type&lt;/label&gt;
            &lt;select id=&quot;pl_type&quot;&gt;
              &lt;option value=&quot;one-way&quot;&gt;One-Way&lt;/option&gt;
              &lt;option value=&quot;two-way&quot;&gt;Two-Way&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;note&quot; id=&quot;pl_note&quot;&gt;&lt;/div&gt;
        &lt;div class=&quot;result&quot;&gt;&lt;div id=&quot;pl_note2&quot;&gt;&lt;/div&gt;&lt;div class=&quot;total&quot; id=&quot;pl_total&quot;&gt;&lt;/div&gt;&lt;/div&gt;
        &lt;div class=&quot;quote&quot; id=&quot;pl_quote&quot;&gt;&lt;/div&gt;
        &lt;button class=&quot;btn&quot; onclick=&quot;copyQuote(&#x27;pl_quote&#x27;)&quot;&gt;Copy Message&lt;/button&gt;
      &lt;/section&gt;

      &lt;section class=&quot;product&quot; id=&quot;security&quot;&gt;
        &lt;h2&gt;Security Screen (Lock Included)&lt;/h2&gt;
        &lt;div class=&quot;row&quot;&gt;
          &lt;div&gt;
            &lt;label&gt;Type&lt;/label&gt;
            &lt;select id=&quot;sc_type&quot;&gt;
              &lt;option value=&quot;one-way&quot;&gt;One-Way&lt;/option&gt;
              &lt;option value=&quot;two-way&quot;&gt;Two-Way (Center)&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;note&quot; id=&quot;sc_note&quot;&gt;&lt;/div&gt;
        &lt;div class=&quot;result&quot;&gt;&lt;div id=&quot;sc_note2&quot;&gt;&lt;/div&gt;&lt;div class=&quot;total&quot; id=&quot;sc_total&quot;&gt;&lt;/div&gt;&lt;/div&gt;
        &lt;div class=&quot;quote&quot; id=&quot;sc_quote&quot;&gt;&lt;/div&gt;
        &lt;button class=&quot;btn&quot; onclick=&quot;copyQuote(&#x27;sc_quote&#x27;)&quot;&gt;Copy Message&lt;/button&gt;
      &lt;/section&gt;

      &lt;section class=&quot;product&quot; id=&quot;t2b&quot;&gt;
        &lt;h2&gt;Top-to-Bottom Screen&lt;/h2&gt;
        &lt;div class=&quot;result&quot;&gt;&lt;div id=&quot;t2b_note&quot;&gt;&lt;/div&gt;&lt;div class=&quot;total&quot; id=&quot;t2b_total&quot;&gt;&lt;/div&gt;&lt;/div&gt;
        &lt;div class=&quot;quote&quot; id=&quot;t2b_quote&quot;&gt;&lt;/div&gt;
        &lt;button class=&quot;btn&quot; onclick=&quot;copyQuote(&#x27;t2b_quote&#x27;)&quot;&gt;Copy Message&lt;/button&gt;
      &lt;/section&gt;

      &lt;section class=&quot;product&quot; id=&quot;honeycomb&quot;&gt;
        &lt;h2&gt;Honeycomb (Three Options)&lt;/h2&gt;
        &lt;div class=&quot;result&quot;&gt;&lt;div&gt;One-Way&lt;/div&gt;&lt;div class=&quot;total&quot; id=&quot;hc_one&quot;&gt;&lt;/div&gt;&lt;/div&gt;
        &lt;div class=&quot;result&quot;&gt;&lt;div&gt;Two-Way&lt;/div&gt;&lt;div class=&quot;total&quot; id=&quot;hc_two&quot;&gt;&lt;/div&gt;&lt;/div&gt;
        &lt;div class=&quot;result&quot;&gt;&lt;div&gt;With Screen&lt;/div&gt;&lt;div class=&quot;total&quot; id=&quot;hc_combo&quot;&gt;&lt;/div&gt;&lt;/div&gt;
        &lt;div class=&quot;quote&quot; id=&quot;hc_quote_all&quot;&gt;&lt;/div&gt;
        &lt;button class=&quot;btn&quot; onclick=&quot;copyQuote(&#x27;hc_quote_all&#x27;)&quot;&gt;Copy Honeycomb Summary&lt;/button&gt;
      &lt;/section&gt;
    &lt;/div&gt;

    &lt;div class=&quot;card summary&quot;&gt;
      &lt;h2 style=&quot;margin:0 0 10px;&quot;&gt;Combined Summary&lt;/h2&gt;
      &lt;div class=&quot;quote&quot; id=&quot;all_quote&quot;&gt;&lt;/div&gt;
      &lt;div style=&quot;margin-top:10px;&quot;&gt;
        &lt;button class=&quot;btn&quot; onclick=&quot;copyQuote(&#x27;all_quote&#x27;)&quot;&gt;Copy Combined Message&lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;

&lt;script&gt;
  function toInches(value, unit) {
    const u = (unit || &quot;&quot;).toLowerCase();
    if (!value || value &lt;= 0) return 0;
    if (u === &quot;mm&quot;) return value / 25.4;
    if (u === &quot;cm&quot;) return value / 2.54;
    if (u === &quot;m&quot;)  return value * 39.3700787;
    if (u === &quot;ft&quot;) return value * 12;
    return value;
  }
  function toMeters(value, unit) {
    const u = (unit || &quot;&quot;).toLowerCase();
    if (!value || value &lt;= 0) return 0;
    if (u === &quot;mm&quot;) return value / 1000;
    if (u === &quot;cm&quot;) return value / 100;
    if (u === &quot;m&quot;)  return value;
    if (u === &quot;in&quot;) return value * 0.0254;
    if (u === &quot;ft&quot;) return value * 0.3048;
    return value * 0.0254;
  }
  function sqft(wIn, hIn) { return (wIn * hIn) / 144.0; }
  const peso0 = n =&gt; new Intl.NumberFormat(&quot;en-PH&quot;, { style:&quot;currency&quot;, currency:&quot;PHP&quot;, maximumFractionDigits:0 }).format(n || 0);
  const fix2 = n =&gt; (Math.round((n || 0) * 100) / 100);

  let last = { w:0,h:0,mW:0,areaRaw:0,
    t2bAllowed:true,t2bTotal:null,
    plAllowed:true,plTwo:false,plTotal:0,
    scAllowed:true,scTwo:false,scTotal:0,
    pcTotal:0, adTotal:0, hcOne:null, hcTwo:null, hcCombo:null,
    pcWarn:&quot;&quot;, hcWarn:&quot;&quot;
  };

  function autoCompute() {
    const width = parseFloat(document.getElementById(&quot;width&quot;).value);
    const height = parseFloat(document.getElementById(&quot;height&quot;).value);
    const unit = document.getElementById(&quot;unit&quot;).value;
    if (!width || !height) { buildCombined(unit || &quot;in&quot;, document.getElementById(&quot;width&quot;).value || &quot;&quot;, document.getElementById(&quot;height&quot;).value || &quot;&quot;); return; }
    const w = toInches(width, unit);
    const h = toInches(height, unit);
    const mW = toMeters(width, unit);
    const areaRaw = sqft(w, h);
    last.w = w; last.h = h; last.mW = mW; last.areaRaw = areaRaw;

    const autoTwoWay = mW &gt; 3;

    computeAccordion(w,h,areaRaw);
    computePolycarbonate(w,h,areaRaw, autoTwoWay);
    computePleated(w,h,areaRaw, document.getElementById(&quot;pl_type&quot;).value, autoTwoWay);
    computeSecurity(w,h,areaRaw, document.getElementById(&quot;sc_type&quot;).value, autoTwoWay);
    computeT2B(w,h,areaRaw);
    computeHoneycomb(w,h,areaRaw, mW, autoTwoWay);

    buildCombined(unit, width, height);
  }

  function copyQuote(id) {
    const el = document.getElementById(id);
    const text = (el &amp;&amp; el.textContent) ? el.textContent : &quot;&quot;;
    if (!text.trim()) { alert(&quot;Nothing to copy.&quot;); return; }
    navigator.clipboard.writeText(text).then(() =&gt; { alert(&quot;Copied!&quot;); })
    .catch(() =&gt; {
      const ta = document.createElement(&quot;textarea&quot;); ta.value = text; document.body.appendChild(ta);
      ta.select(); document.execCommand(&quot;copy&quot;); document.body.removeChild(ta); alert(&quot;Copied!&quot;);
    });
  }

  // Accordion (no technical details shown)
  function computeAccordion(w,h,areaRaw) {
    const total = (()=&gt;{
      if (h &gt; 120) return null;
      let h_ft = h/12, adj_ft = (h_ft &lt;=7 ? 7 : h_ft &lt;=8 ? 8 : h_ft &lt;=9 ? 9 : 10);
      const adj_in = adj_ft * 12;
      const areaAdj = (w * adj_in) / 144;
      const sqftCharge = Math.max(20, areaAdj);
      const style = document.getElementById(&quot;ad_style&quot;).value;
      const opening = document.getElementById(&quot;ad_opening&quot;).value;
      const rate = (style === &quot;french&quot;) ? 320 : 220;
      const addOpening = (style === &quot;french&quot;) ? (opening === &quot;two-way&quot; ? 2400 : 1200) : (opening === &quot;two-way&quot; ? 2000 : 1000);
      return Math.round(sqftCharge * rate + addOpening);
    })();
    const note = document.getElementById(&quot;ad_note&quot;);
    const out = document.getElementById(&quot;ad_total&quot;);
    const quote = document.getElementById(&quot;ad_quote&quot;);
    if (total === null) { note.textContent = &quot;Not allowed (height &gt; 120 in).&quot;; out.textContent = &quot;‚Äî&quot;; quote.textContent = withClient(&quot;Accordion: Not allowed.&quot;); return; }
    note.textContent = &quot;Estimated Total&quot;;
    out.textContent = peso0(total);
    quote.textContent = withClient(`Accordion: ${peso0(total)}`);
  }

  // Polycarbonate
  function computePolycarbonate(w,h,areaRaw, autoTwoWay) {
    const note = document.getElementById(&quot;pc_note&quot;);
    const out2 = document.getElementById(&quot;pc_total&quot;);
    const quote = document.getElementById(&quot;pc_quote&quot;);
    const openingSel = document.getElementById(&quot;pc_opening&quot;);
    if (autoTwoWay) openingSel.value = &quot;two-way&quot;;
    if (h &gt; 120) { note.textContent = &quot;&quot;; out2.textContent = &quot;‚Äî&quot;; quote.textContent = withClient(&quot;Polycarbonate: Not allowed (height &gt; 120 in).&quot;); return; }
    let h_ft = h/12, adj_ft = (h_ft &lt;=7 ? 7 : h_ft &lt;=8 ? 8 : h_ft &lt;=9 ? 9 : 10);
    const adj_in = adj_ft * 12;
    const areaAdj = (w * adj_in) / 144;
    const sqftCharge = Math.max(20, areaAdj);
    const opening = openingSel.value;
    const rate = 750;
    // ‚úÖ Revised add-on logic: two-way = 1200 + 3000
    const addOpening = (opening === &quot;two-way&quot;) ? (1200 + 3000) : 1200;
    const total = Math.round(sqftCharge * rate + addOpening);
    note.textContent = autoTwoWay ? &quot;Auto Two-Way (width &gt; 3 m)&quot; : &quot;&quot;;
    out2.textContent = peso0(total);
    quote.textContent = withClient(`Polycarbonate (${opening}): ${peso0(total)}`);
  }

  // Top-to-Bottom
  function computeT2B(w,h,areaRaw) {
    const out = document.getElementById(&quot;t2b_total&quot;);
    const note = document.getElementById(&quot;t2b_note&quot;);
    const quote = document.getElementById(&quot;t2b_quote&quot;);
    const widthOK = w &lt;= 70, heightOK = h &lt;= 70.866;
    if (!widthOK || !heightOK) {
      const reasons=[]; if(!widthOK) reasons.push(&quot;width &gt; 70 in&quot;); if(!heightOK) reasons.push(&quot;height &gt; 70.866 in&quot;);
      note.textContent = &quot;Not allowed (&quot; + reasons.join(&quot; &amp; &quot;) + &quot;)&quot;;
      out.textContent = &quot;‚Äî&quot;;
      quote.textContent = withClient(`Top-to-Bottom: Not allowed (${reasons.join(&quot; &amp; &quot;)}).`);
      return;
    }
    const area = Math.max(15, areaRaw);
    const total = Math.round(area * 250);
    note.textContent = &quot;Estimated Total&quot;;
    out.textContent = peso0(total);
    quote.textContent = withClient(`Top-to-Bottom: ${peso0(total)}`);
  }

  // Pleated
  function computePleated(w,h,areaRaw, type, autoTwoWay) {
    const out = document.getElementById(&quot;pl_total&quot;);
    const note = document.getElementById(&quot;pl_note2&quot;);
    const quote = document.getElementById(&quot;pl_quote&quot;);
    if (h &gt; 120) { note.textContent = &quot;Not allowed (height &gt; 120 in)&quot;; out.textContent = &quot;‚Äî&quot;; quote.textContent = withClient(&quot;Pleated: Not allowed.&quot;); return; }
    const twoForced = autoTwoWay;
    const two = twoForced || (String(type).toLowerCase()===&quot;two-way&quot;);
    const mW = last.mW;
    if (two &amp;&amp; mW &gt; 6) { note.textContent = &quot;Not allowed (two-way width &gt; 6 m)&quot;; out.textContent = &quot;‚Äî&quot;; quote.textContent = withClient(&quot;Pleated: Not allowed (two-way width &gt; 6 m).&quot;); return; }
    const area = Math.max(15, areaRaw);
    const rate = two ? 375 : 350;
    const total = Math.round(area * rate);
    note.textContent = twoForced ? &quot;Auto Two-Way (width &gt; 3 m)&quot; : &quot;Estimated Total&quot;;
    out.textContent = peso0(total);
    quote.textContent = withClient(`Pleated (${two ? &quot;Two-Way&quot; : &quot;One-Way&quot;}): ${peso0(total)}`);
  }

  // Security
  function computeSecurity(w,h,areaRaw, type, autoTwoWay) {
    const out = document.getElementById(&quot;sc_total&quot;);
    const note = document.getElementById(&quot;sc_note2&quot;);
    const quote = document.getElementById(&quot;sc_quote&quot;);
    if (h &gt; 120) { note.textContent = &quot;Not allowed (height &gt; 120 in)&quot;; out.textContent = &quot;‚Äî&quot;; quote.textContent = withClient(&quot;Security: Not allowed.&quot;); return; }
    const twoForced = autoTwoWay;
    const two = twoForced || (String(type).toLowerCase().includes(&quot;two&quot;));
    const mW = last.mW;
    if (two &amp;&amp; mW &gt; 6) { note.textContent = &quot;Not allowed (two-way width &gt; 6 m)&quot;; out.textContent = &quot;‚Äî&quot;; quote.textContent = withClient(&quot;Security: Not allowed (two-way width &gt; 6 m).&quot;); return; }
    const area = Math.max(20, areaRaw);
    const base = area * 750;
    const addon = two ? (area * 780 + 3000) : 0;
    const total = Math.round(base + addon);
    note.textContent = twoForced ? &quot;Auto Two-Way (width &gt; 3 m)&quot; : &quot;Estimated Total&quot;;
    out.textContent = peso0(total);
    quote.textContent = withClient(`Security (${two ? &quot;Two-Way&quot; : &quot;One-Way&quot;}): ${peso0(total)}`);
  }

  // Honeycomb
  function computeHoneycomb(w,h,areaRaw, mW, autoTwoWay) {
    const prefix = (document.getElementById(&quot;client_name&quot;).value || &quot;&quot;).trim();
    const pfx = prefix ? `For ${prefix}: ` : &quot;&quot;;
    const areaMin20 = Math.max(20, areaRaw);
    const oneRate = 390, twoRate = 390, cbRate = 410;
    const oneAllowed = (w &lt;= 94.49 &amp;&amp; h &lt;= 110.24);
    const twoAllowed = (w &lt;= 188.98 &amp;&amp; h &lt;= 120);
    const cbAllowed  = (w &lt;= 94 &amp;&amp; h &lt;= 110);
    const oneTotal = oneAllowed ? Math.round(areaMin20 * oneRate) : null;
    const twoTotal = twoAllowed ? Math.round(areaMin20 * twoRate + 3000) : null;
    const cbTotal  = cbAllowed  ? Math.round(areaMin20 * cbRate) : null;

    document.getElementById(&quot;hc_one&quot;).textContent   = oneAllowed ? peso0(oneTotal) : &quot;Not allowed&quot;;
    document.getElementById(&quot;hc_two&quot;).textContent   = twoAllowed ? peso0(twoTotal) : &quot;Not allowed&quot;;
    document.getElementById(&quot;hc_combo&quot;).textContent = cbAllowed  ? peso0(cbTotal)  : &quot;Not allowed&quot;;

    const oneStr = oneAllowed ? peso0(oneTotal) : &quot;Not allowed&quot;;
    const twoStr = twoAllowed ? peso0(twoTotal) : &quot;Not allowed&quot;;
    const cbStr  = cbAllowed  ? peso0(cbTotal)  : &quot;Not allowed&quot;;
    const combined = `${pfx}Honeycomb ‚Äî One-Way: ${oneStr}; Two-Way: ${twoStr}; With Screen: ${cbStr}. Free estimate, delivery &amp; installation depende sa location.`;
    document.getElementById(&quot;hc_quote_all&quot;).textContent = combined;
  }

  // Helpers
  function withClient(text) {
    const name = document.getElementById(&quot;client_name&quot;).value;
    return (name ? `For ${name}: ` : &quot;&quot;) + text;
  }

  function buildCombined(unit, Wraw, Hraw) {
    const name = document.getElementById(&quot;client_name&quot;).value;
    const header = name ? `Estimation Summary for ${name}\n` : &quot;Estimation Summary\n&quot;;
    const dims = `${Wraw} √ó ${Hraw} ${unit}`;
    const adLine = `Accordion Door: ${peso0(document.getElementById(&quot;ad_total&quot;).textContent || 0)}`;
    const pcLine = `Polycarbonate: ${peso0(document.getElementById(&quot;pc_total&quot;).textContent || 0)}`;
    const scLine = document.getElementById(&quot;sc_total&quot;).textContent ? `Security: ${peso0(document.getElementById(&quot;sc_total&quot;).textContent)}` : &quot;Security: Not allowed&quot;;
    const t2bLine = document.getElementById(&quot;t2b_total&quot;).textContent ? `Top-to-Bottom: ${peso0(document.getElementById(&quot;t2b_total&quot;).textContent)}` : &quot;Top-to-Bottom: Not allowed&quot;;
    const plLine = document.getElementById(&quot;pl_total&quot;).textContent ? `Pleated: ${peso0(document.getElementById(&quot;pl_total&quot;).textContent)}` : &quot;Pleated: Not allowed&quot;;
    const hcLine = `Honeycomb ‚Äî One-Way: ${document.getElementById(&quot;hc_one&quot;).textContent}; Two-Way: ${document.getElementById(&quot;hc_two&quot;).textContent}; With Screen: ${document.getElementById(&quot;hc_combo&quot;).textContent}`;
    const combined = `${header}${dims}
${adLine}
${pcLine}
${scLine}
${t2bLine}
${plLine}
${hcLine}

Free estimate, delivery &amp; installation depende sa location. Salamat po!`;
    document.getElementById(&quot;all_quote&quot;).textContent = combined;
  }

  function wireAuto() {
    const ids = [&quot;client_name&quot;,&quot;width&quot;,&quot;height&quot;,&quot;unit&quot;,&quot;ad_style&quot;,&quot;ad_opening&quot;,&quot;pc_opening&quot;,&quot;pc_type&quot;,&quot;pl_type&quot;,&quot;sc_type&quot;];
    ids.forEach(id =&gt; {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener(&quot;input&quot;, autoCompute);
      el.addEventListener(&quot;change&quot;, autoCompute);
    });
    autoCompute();
  }
  document.addEventListener(&quot;DOMContentLoaded&quot;, wireAuto);
&lt;/script&gt;

&lt;div style=&quot;margin-top:28px;padding:16px;background:#111827;border:1px solid #1f2937;border-radius:12px&quot;&gt;
  &lt;div style=&quot;font-weight:700;margin-bottom:8px;font-size:16px&quot;&gt;üìû Contact &amp; Orders&lt;/div&gt;
  &lt;div style=&quot;display:flex;flex-wrap:wrap;gap:8px&quot;&gt;
    &lt;a href=&quot;https://www.facebook.com/Grayhomedecor/&quot; target=&quot;_blank&quot; style=&quot;background:#1877f2;color:#fff;padding:10px 12px;border-radius:10px;text-decoration:none;font-weight:700&quot;&gt;Facebook Page&lt;/a&gt;
    &lt;a href=&quot;https://wa.me/639166373872&quot; target=&quot;_blank&quot; style=&quot;background:#25d366;color:#000;padding:10px 12px;border-radius:10px;text-decoration:none;font-weight:700&quot;&gt;WhatsApp 0916-637-3872&lt;/a&gt;
    &lt;a href=&quot;https://wa.me/639513183794&quot; target=&quot;_blank&quot; style=&quot;background:#25d366;color:#000;padding:10px 12px;border-radius:10px;text-decoration:none;font-weight:700&quot;&gt;WhatsApp 0951-318-3794&lt;/a&gt;
    &lt;a href=&quot;viber://chat?number=%2B639166373872&quot; target=&quot;_blank&quot; style=&quot;background:#7360f2;color:#fff;padding:10px 12px;border-radius:10px;text-decoration:none;font-weight:700&quot;&gt;Viber 0916-637-3872&lt;/a&gt;
    &lt;a href=&quot;viber://chat?number=%2B639513183794&quot; target=&quot;_blank&quot; style=&quot;background:#7360f2;color:#fff;padding:10px 12px;border-radius:10px;text-decoration:none;font-weight:700&quot;&gt;Viber 0951-318-3794&lt;/a&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;/body&gt;
&lt;/html&gt;
" style="width:100%;min-height:1600px;border:0;display:block"></iframe>
</section>


<!-- Main Products ‚Äî Price Sheet (modal) -->
<div id="mpEditModal" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.45)">
  <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(1100px,95vw);
              max-height:82vh;overflow:auto;background:#fff;border:1px solid var(--bd);border-radius:14px;box-shadow:0 12px 30px rgba(0,0,0,.35)">
    <div style="position:sticky;top:0;background:#fff;z-index:1;border-bottom:1px solid var(--bd);
                display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 12px">
      <div style="font-weight:800;font-size:20px">Main Products ‚Äî Editable Price Sheet</div>
      <div style="display:flex;gap:8px">
        <button id="mpSave" class="btn" style="background:#16a34a;color:#fff">üíæ Save</button>
        <button id="mpRefresh" class="btn">‚Üª Refresh</button>
        <button id="mpClose" class="btn danger" style="color:#fff">‚úï</button>
      </div>
    </div>
    <div class="table-wrap" style="margin:12px">
      <table id="mpTable">
        <thead><tr><th>Product</th><th>Field</th><th>Value</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="muted" style="padding:0 12px 12px">Edits save to this browser and apply instantly to totals in the Main Products calculator.</div>
  </div>
</div>
<style>
#mpTable{width:100%;border-collapse:collapse;table-layout:auto}
#mpTable th,#mpTable td{border:1px solid var(--bd);padding:8px;text-align:left}
#mpTable th{background:#f3f4f6}
#mpTable input{width:160px;height:34px;border:1px solid var(--bd);border-radius:6px;padding:4px}
</style>


<script>
// ===== Main Products price sheet (wired to calculations) =====
window.MP_PRICING_DEFAULTS = {
  accordion: { rate_regular:220, rate_french:320, add_one_regular:1000, add_two_regular:2000, add_one_french:1200, add_two_french:2400, min_sqft:20 },
  polycarbonate: { rate:750, add_one_way:1200, add_two_way:3000, min_sqft:20 },
  pleated: { rate_one:350, rate_two:375, min_sqft:15 },
  t2b: { rate:250, min_sqft:15 },
  security: { rate_one:750, rate_two:780, two_way_add:3000, min_sqft:20 },
  honeycomb: { rate_one:390, rate_two:390, two_way_add:3000, rate_with_screen:410, min_sqft:20 }
};
function mp_load(){
  try{ const s = localStorage.getItem('GHD_MAIN_PRODUCTS_CFG');
       return s? Object.assign({}, MP_PRICING_DEFAULTS, JSON.parse(s)) : JSON.parse(JSON.stringify(MP_PRICING_DEFAULTS));
  }catch(e){ return JSON.parse(JSON.stringify(MP_PRICING_DEFAULTS)); }
}
function mp_save(cfg){ localStorage.setItem('GHD_MAIN_PRODUCTS_CFG', JSON.stringify(cfg)); }
let MP_CFG = mp_load();

function mp_render(){
  const rows = [
    ['accordion','rate_regular','Accordion ‚Äî Base rate (Regular)'],
    ['accordion','rate_french','Accordion ‚Äî Base rate (French)'],
    ['accordion','add_one_regular','Accordion ‚Äî Opening add (Regular, One-Way)'],
    ['accordion','add_two_regular','Accordion ‚Äî Opening add (Regular, Two-Way)'],
    ['accordion','add_one_french','Accordion ‚Äî Opening add (French, One-Way)'],
    ['accordion','add_two_french','Accordion ‚Äî Opening add (French, Two-Way)'],
    ['accordion','min_sqft','Accordion ‚Äî Minimum ft¬≤'],
    ['polycarbonate','rate','Polycarbonate ‚Äî Rate per ft¬≤'],
    ['polycarbonate','add_one_way','Polycarbonate ‚Äî Opening add (One-Way)'],
    ['polycarbonate','add_two_way','Polycarbonate ‚Äî Opening add (Two-Way)'],
    ['polycarbonate','min_sqft','Polycarbonate ‚Äî Minimum ft¬≤'],
    ['pleated','rate_one','Pleated ‚Äî Rate per ft¬≤ (One-Way)'],
    ['pleated','rate_two','Pleated ‚Äî Rate per ft¬≤ (Two-Way)'],
    ['pleated','min_sqft','Pleated ‚Äî Minimum ft¬≤'],
    ['t2b','rate','Top-to-Bottom ‚Äî Rate per ft¬≤'],
    ['t2b','min_sqft','Top-to-Bottom ‚Äî Minimum ft¬≤'],
    ['security','rate_one','Security ‚Äî Rate per ft¬≤ (One-Way)'],
    ['security','rate_two','Security ‚Äî Rate per ft¬≤ (Two-Way)'],
    ['security','two_way_add','Security ‚Äî Two-Way add (‚Ç±)'],
    ['security','min_sqft','Security ‚Äî Minimum ft¬≤'],
    ['honeycomb','rate_one','Honeycomb ‚Äî Rate per ft¬≤ (One-Way)'],
    ['honeycomb','rate_two','Honeycomb ‚Äî Rate per ft¬≤ (Two-Way)'],
    ['honeycomb','two_way_add','Honeycomb ‚Äî Two-Way add (‚Ç±)'],
    ['honeycomb','rate_with_screen','Honeycomb ‚Äî Rate per ft¬≤ (With Screen)'],
    ['honeycomb','min_sqft','Honeycomb ‚Äî Minimum ft¬≤']
  ];
  const tb = document.querySelector('#mpTable tbody');
  if(!tb) return;
  tb.innerHTML = '';
  rows.forEach(([g,k,label])=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${g}</td><td>${label}</td><td><input type="number" step="any" data-g="${g}" data-k="${k}" value="${MP_CFG[g][k]||0}"></td>`;
    tb.appendChild(tr);
  });
}

function mp_fmt(n){ return (Math.round((+n||0))).toLocaleString('en-PH'); }

// Apply prices to embedded calculator (iframe inside Main Products)
let __mp_ticking=false;function mp_apply_throttled(){if(__mp_ticking) return; __mp_ticking=true; requestAnimationFrame(()=>{try{mp_apply();}finally{__mp_ticking=false;}});} function mp_apply(){
  const frame = document.querySelector('#panel-other iframe');
  if(!frame) return;
  const win = frame.contentWindow, doc = frame.contentDocument || win.document;
  if(!doc) return;

  const val = id => { const el = doc.getElementById(id); return el ? el.value : ''; };
  const num = id => { const el = doc.getElementById(id); return el ? (+el.value||0) : 0; };
  const set = (id, peso)=>{ const el = doc.getElementById(id); if(el){ el.textContent = '‚Ç±' + mp_fmt(peso); } };

  const unit = val('unit'); const w = num('width'); const h = num('height');
  // conversions like in child
  function toInches(v,u){ u=(u||'').toLowerCase(); if(u==='mm') return v/25.4; if(u==='cm') return v/2.54; if(u==='m') return v*39.3700787; if(u==='ft') return v*12; return v; }
  function toMeters(v,u){ u=(u||'').toLowerCase(); if(u==='mm') return v/1000; if(u==='cm') return v/100; if(u==='m') return v; if(u==='in') return v*0.0254; if(u==='ft') return v*0.3048; return v*0.0254; }
  function sqft(wIn,hIn){ return (wIn*hIn)/144.0; }

  const wIn = toInches(w, unit), hIn = toInches(h, unit), area = sqft(wIn,hIn), mW = toMeters(w, unit);

  // Accordion ‚Äî mirror child's height rounding logic
  try{
    if(hIn > 120){ set('ad_total', 0); }
    else{
      let h_ft = hIn/12, adj_ft = (h_ft <=7 ? 7 : h_ft <=8 ? 8 : h_ft <=9 ? 9 : 10);
      const adj_in = adj_ft * 12;
      const areaAdj = (wIn * adj_in) / 144;
      const sqftCharge = Math.max(MP_CFG.accordion.min_sqft, areaAdj);
      const style = val('ad_style'), opening = val('ad_opening');
      const rate = (style==='french') ? MP_CFG.accordion.rate_french : MP_CFG.accordion.rate_regular;
      const add  = (style==='french')
        ? (opening==='two-way' ? MP_CFG.accordion.add_two_french : MP_CFG.accordion.add_one_french)
        : (opening==='two-way' ? MP_CFG.accordion.add_two_regular : MP_CFG.accordion.add_one_regular);
      set('ad_total', sqftCharge*rate + add);
    }
  }catch(e){}

  // Polycarbonate
  try{
    if(hIn > 120){ set('pc_total', 0); }
    else{
      let h_ft = hIn/12, adj_ft = (h_ft <=7 ? 7 : h_ft <=8 ? 8 : h_ft <=9 ? 9 : 10);
      const adj_in = adj_ft * 12;
      const areaAdj = (wIn * adj_in) / 144;
      const sqftCharge = Math.max(MP_CFG.polycarbonate.min_sqft, areaAdj);
      const opening = val('pc_opening');
      const rate = MP_CFG.polycarbonate.rate;
      const add  = (opening==='two-way') ? MP_CFG.polycarbonate.add_two_way : MP_CFG.polycarbonate.add_one_way;
      set('pc_total', sqftCharge*rate + add);
    }
  }catch(e){}

  // Pleated
  try{
    const two = (mW > 3) || (String(val('pl_type')).toLowerCase()==='two-way');
    const areaAdj = Math.max(MP_CFG.pleated.min_sqft, area);
    const rate = two ? MP_CFG.pleated.rate_two : MP_CFG.pleated.rate_one;
    set('pl_total', areaAdj*rate);
  }catch(e){}

  // Top-to-Bottom
  try{
    const areaAdj = Math.max(MP_CFG.t2b.min_sqft, area);
    set('t2b_total', areaAdj * MP_CFG.t2b.rate);
  }catch(e){}

  // Security
  try{
    if(hIn > 120){ set('sc_total', 0); }
    else{
      const two = (mW > 3) || (String(val('sc_type')).toLowerCase().includes('two'));
      const areaAdj = Math.max(MP_CFG.security.min_sqft, area);
      const rate = two ? MP_CFG.security.rate_two : MP_CFG.security.rate_one;
      const add  = two ? MP_CFG.security.two_way_add : 0;
      set('sc_total', areaAdj*rate + add);
    }
  }catch(e){}

  // Honeycomb
  try{
    const areaAdj = Math.max(MP_CFG.honeycomb.min_sqft, area);
    set('hc_one', areaAdj * MP_CFG.honeycomb.rate_one);
    set('hc_two', areaAdj * MP_CFG.honeycomb.rate_two + MP_CFG.honeycomb.two_way_add);
    set('hc_combo', areaAdj * MP_CFG.honeycomb.rate_with_screen);
  }catch(e){}

  // Update combined summary if the child exposes it
  try{
    win.buildCombined && win.buildCombined(unit, doc.getElementById('width')?.value || '', doc.getElementById('height')?.value || '');
  }catch(e){}
}

// Wire up the button, modal, and live apply
(function(){
  const btn = document.getElementById('mpFabBtn');
  const panel = document.getElementById('mpEditModal');
  if(btn){ btn.addEventListener('click', ()=>{ mp_render(); panel.style.display='block'; }); }
  document.getElementById('mpClose')?.addEventListener('click', ()=> panel.style.display='none');
  document.getElementById('mpRefresh')?.addEventListener('click', ()=> mp_render());
  document.getElementById('mpSave')?.addEventListener('click', ()=>{
    document.querySelectorAll('#mpTable input').forEach(inp=>{
      const g = inp.getAttribute('data-g'), k = inp.getAttribute('data-k');
      MP_CFG[g][k] = +inp.value;
    });
    mp_save(MP_CFG);
    mp_apply();
  });

  // Bind to child inputs so totals always reflect latest prices as you type
  const frame = document.querySelector('#panel-other iframe');
  function bindChildLight(){
    try{
      const doc = frame.contentDocument || frame.contentWindow.document;
      const ids = ['width','height','unit','ad_style','ad_opening','pc_opening','pc_type','pl_type','sc_type'];
      ids.forEach(id=>{
        const el = doc.getElementById(id);
        if(el && !el._mpBound){
          el.addEventListener('input', mp_apply_throttled, {passive:true});
          el.addEventListener('change', mp_apply_throttled);
          el._mpBound = true;
        }
      });
      mp_apply_throttled();
    }catch(e){}
  }
  frame?.addEventListener('load', bindChildLight);
  if(frame?.contentDocument && frame.contentDocument.readyState!=='loading'){ bindChildLight(); }
})();</script>


<script>
(function(){
  const panel = document.getElementById('ownerPanel');
  const maxBtn = document.getElementById('ownerMaxBtn');
  const minBtn = document.getElementById('ownerMinBtn');
  const closeBtn = document.getElementById('ownerClose');

  function ownerSetState(state){
    panel.classList.remove('max','min');
    if(state==='max'){ panel.classList.add('max'); if(maxBtn) maxBtn.textContent='‚§° Restore'; }
    else if(state==='min'){ panel.classList.add('min'); if(maxBtn) maxBtn.textContent='üóñ Maximize'; }
    else { if(maxBtn) maxBtn.textContent='üóñ Maximize'; }
    localStorage.setItem('ghd_owner_panel_state', state);
  }
  window.ownerSetState = ownerSetState;

  function ownerToggleMax(){
    const isMax = panel.classList.contains('max');
    ownerSetState(isMax ? 'normal' : 'max');
  }
  function ownerMinimize(){ ownerSetState('min'); }

  maxBtn && maxBtn.addEventListener('click', ownerToggleMax);
  minBtn && minBtn.addEventListener('click', ownerMinimize);
  // Clicking header in minimized state restores to normal
  const hdr = panel.querySelector('header');
  if(hdr){
    hdr.addEventListener('click', (e)=>{
      if(panel.classList.contains('min')){
        e.preventDefault();
        ownerSetState('normal');
      }
    });
  }
  // Restore last state when panel is opened
  const prevOpen = panel.style.display !== 'none';
  const origOpen = window.openOwnerPanel;
  window.openOwnerPanel = function(){
    if(typeof origOpen === 'function') origOpen();
    const st = localStorage.getItem('ghd_owner_panel_state') || 'normal';
    ownerSetState(st);
  }
  // If panel already visible at load (unlocked), apply stored state now
  if(prevOpen || panel.style.display === 'block'){
    const st = localStorage.getItem('ghd_owner_panel_state') || 'normal';
    ownerSetState(st);
  }
})();
</script>


<script>
function ghdDownloadExcel(filename, tableHtml){
  const tpl = `<!DOCTYPE html><html><head><meta charset="utf-8">
<style>
  #a-table td.sqft, #a-table td.line {
    text-align: right;
    white-space: nowrap;
    min-width: 80px;
  }
</style>

</head><body>${tableHtml}
<script>
document.getElementById('exportXLSX')?.addEventListener('click', ()=>{
  try{
    // Ensure latest edits are reflected by re-reading current master rows first
    const table = document.getElementById('masterTable');
    if(table){
      const trs = table.querySelectorAll('tbody tr');
      const newMaster = [];
      trs.forEach(tr=>{
        const get = sel => tr.querySelector(sel);
        const code = get('[data-k="code"]')?.value?.trim() || '';
        const base = +(get('[data-k="base"]')?.value || 0);
        const show = {
          combi:   !!get('[data-k="combi"]')?.checked,
          roller:  !!get('[data-k="roller"]')?.checked,
          pvc:     !!get('[data-k="pvc"]')?.checked,
          public:  !!get('[data-k="public"]')?.checked,
          synergy: !!get('[data-k="synergy"]')?.checked,
          shangrila: !!get('[data-k="shangrila"]')?.checked,
          venetian:  !!get('[data-k="venetian"]')?.checked,
          realwood:  !!get('[data-k="realwood"]')?.checked,
          curtains:  !!get('[data-k="curtains"]')?.checked,
        };
        if(code){ newMaster.push({code, base, show}); }
      });
      if(newMaster.length){ DATA.master = newMaster; saveData(DATA); }
    }

    // Build an Excel-friendly HTML table including Final (√ó2 + 20)
    let out = '<table border="1"><thead><tr>' +
              '<th>Code</th><th>Base ‚Ç±/ft¬≤</th><th>Final (√ó2 + 20)</th>' +
              '</tr></thead><tbody>';
    for(const row of DATA.master){
      const base = +row.base || 0;
      const final = finalFromBase(base); // base*2 + 20
      out += `<tr><td>${row.code}</td><td>${base}</td><td>${Math.round(final)}</td></tr>`;
    }
    out += '</tbody></table>';
    ghdDownloadExcel('Master_Codes_with_Final', out);
  }catch(err){
    alert('Export failed: ' + (err?.message||err));
  }
});
</script>


<script>
(function(){
  const btn = document.getElementById('exportFinal');
  if(!btn) return;
  btn.addEventListener('click', ()=>{
    const tbody = document.getElementById('masterTable')?.querySelector('tbody');
    if(!tbody){ alert('Master table not found'); return; }
    let out = '<table border="1"><thead><tr><th>Code</th><th>Base ‚Ç±/ft¬≤</th><th>Final (√ó2 + 20)</th></tr></thead><tbody>';
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      const code = tr.querySelector('[data-k="code"]')?.value?.trim() || '';
      const base = +(tr.querySelector('[data-k="base"]')?.value || 0);
      const final = (typeof finalFromBase==='function') ? finalFromBase(base) : (base*2 + 20);
      if(code){ out += `<tr><td>${code}</td><td>${base}</td><td>${Math.round(final)}</td></tr>`; }
    });
    out += '</tbody></table>';
    ghdDownloadExcel('Master_Codes_with_Final', out);
  });
})();
</script>


<script>
function ghdDownloadCSV(filename, rows){
  const lines = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(','));
  const blob = new Blob([lines.join('\r\n')], {type: 'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename.endsWith('.csv') ? filename : (filename + '.csv');
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
}
</script>


<script>
// GHD Quote v3 ‚Äî clean, hidden, robust
window.GHD = (function(){
  function peso(n){ return '‚Ç±'+(Math.round(+n||0)).toLocaleString('en-PH'); }
  function todayISO(){ const d=new Date(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}

function projectLocation(){
  var el = document.getElementById('projectLocationInput');
  return (el && el.value && el.value.trim()) ? el.value.trim() : '';
}
function validityPlus5(){
  var d = new Date();
  d.setDate(d.getDate() + 5);
  var y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), day=('0'+d.getDate()).slice(-2);
  return y+'-'+m+'-'+day;
}
-${mm}-${dd}`; }
  function txt(el){ return (el && (el.value!=null? el.value: el.textContent)||'').toString().trim(); }
  function num(s){ return parseFloat(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function pick(opt){ return opt ? (opt.selectedOptions?.[0]?.text || opt.value || '') : ''; }

  // Quote number auto-increment; starts Grayhome002
  function nextQuoteNo(){
    let seq = parseInt(localStorage.getItem('ghd_quote_seq')||'2',10);
    const no = 'Grayhome' + String(seq).padStart(3,'0');
    localStorage.setItem('ghd_quote_seq', String(seq+1));
    return no;
  }

  const MAP = {
    all:{panel:'#panel-all',table:'#a-table',cust:'#a-cust'},
    combi:{panel:'#panel-combi',table:'#c-table',cust:'#c-cust'},
    roller:{panel:'#panel-roller',table:'#r-table',cust:'#r-cust'},
    pvc:{panel:'#panel-pvc',table:'#p-table',cust:'#p-cust'},
    synergy:{panel:'#panel-synergy',table:'#s-table',cust:'#s-cust'},
    shangrila:{panel:'#panel-shangrila',table:'#g-table',cust:'#g-cust'},
    venetian:{panel:'#panel-venetian',table:'#v-table',cust:'#v-cust'},
    realwood:{panel:'#panel-realwood',table:'#rw-table',cust:'#rw-cust'},
    curtains:{panel:'#panel-curtains',table:'#ct-table',cust:'#ct-cust'}
  };

  function collect(tab){
    const cfg = MAP[tab]; if(!cfg) return {title:'',headers:[],rows:[],totals:{}};
    const panel = document.querySelector(cfg.panel);
    const table = panel && panel.querySelector(cfg.table);
    if(!table) return {title:'',headers:[],rows:[],totals:{}};
    const tbody = table.querySelector('tbody');
    const trs = Array.from(tbody?tbody.querySelectorAll('tr'):[]);

    function base(tr){
      const codeSel = tr.querySelector('select.code');
      const exact = tr.querySelector('.codeExact');
      const w = tr.querySelector('.width'); const h = tr.querySelector('.height');
      const units = tr.querySelectorAll('.unit');
      const size = (w&&h&&units.length>=2)? `${txt(w)} ${txt(units[0])} √ó ${txt(h)} ${txt(units[1])}` : '';
      return {
        code: codeSel? codeSel.value:'',
        exact: txt(exact),
        size,
        sqft: txt(tr.querySelector('.sqft')),
        amount: num(txt(tr.querySelector('.line'))),
        tr
      };
    }

    const headersAll = {
      all:['#','Type','Code','Exact Code','Area of House','Size (W√óH)','Sq Ft','Options','Amount'],
      combi:['#','Code','Exact Code','Size (W√óH)','Sq Ft','Options','Amount'],
      roller:['#','Code','Exact Code','Size (W√óH)','Sq Ft','Options','Amount'],
      pvc:['#','Code','Exact Code','Size (W√óH)','Sq Ft','Amount'],
      synergy:['#','Code','Exact Code','Size (W√óH)','Sq Ft','Amount'],
      shangrila:['#','Code','Exact Code','Size (W√óH)','Sq Ft','Amount'],
      venetian:['#','Code','Exact Code','Size (W√óH)','Sq Ft','Amount'],
      realwood:['#','Code','Exact Code','Size (W√óH)','Sq Ft','Amount'],
      curtains:['#','Code','Exact Code','Size (W√óH)','Sq Ft','Options','Amount']
    };
    const titleMap = {all:'All Products', combi:'Combi Blinds', roller:'Roller Blinds', pvc:'PVC Vertical & Other',
                      synergy:'Synergy Combi Vertical', shangrila:'Shangrila Blinds', venetian:'Venetian Blinds',
                      realwood:'Realwood Blinds', curtains:'Curtains - Fabric Registry'};
    let rows=[], sub=0, headers=headersAll[tab];
    trs.forEach((tr,i)=>{
      const b = base(tr); let opts='';
      if(tab==='all'){
        const type = tr.querySelector('.type')?.value || '';
        const room = txt(tr.querySelector('.room'));
        if(type==='Combi'){ if(tr.querySelector('.opt-combi .magic')?.checked) opts='Magic +20'; }
        else if(type==='Roller'){
          const chain=pick(tr.querySelector('.opt-roller .chain')); const bt=pick(tr.querySelector('.opt-roller .btube')); const mg = tr.querySelector('.opt-roller .magic')?.checked?'Magic +20':'';
          opts=[chain,bt,mg].filter(Boolean).join(' ‚Ä¢ ');
        } else if(type==='Curtains - Fabric Registry'){
          const finish=pick(tr.querySelector('.opt-curtains .finish')); if(finish) opts='Finish: '+finish;
        } else if(type==='Polycarbonate'){
          const opening=pick(tr.querySelector('.opening')); if(opening) opts='Opening: '+opening;
        }
        sub += b.amount;
        rows.push([i+1, type, b.code, b.exact, room, b.size, b.sqft, opts, (Math.round(b.amount)).toLocaleString('en-PH')]);
      } else {
        if(tab==='roller'){
          const chain=pick(tr.querySelector('.chain')); const bt=pick(tr.querySelector('.btube')); const mg=tr.querySelector('.magic')?.checked?'Magic +20':'';
          opts=[chain,bt,mg].filter(Boolean).join(' ‚Ä¢ ');
          rows.push([i+1, b.code, b.exact, b.size, b.sqft, opts, (Math.round(b.amount)).toLocaleString('en-PH')]);
        } else if(tab==='combi'){
          opts=tr.querySelector('.magic')?.checked?'Magic +20':'';
          rows.push([i+1, b.code, b.exact, b.size, b.sqft, opts, (Math.round(b.amount)).toLocaleString('en-PH')]);
        } else if(tab==='curtains'){
          const finish=pick(tr.querySelector('.finish')); opts=finish?('Finish: '+finish):'';
          rows.push([i+1, b.code, b.exact, b.size, b.sqft, opts, (Math.round(b.amount)).toLocaleString('en-PH')]);
        } else {
          rows.push([i+1, b.code, b.exact, b.size, b.sqft, (Math.round(b.amount)).toLocaleString('en-PH')]);
        }
        sub += b.amount;
      }
    });
    let totals={};
    if(tab==='all'){
      const vatPct = +(document.getElementById('a-vat')?.value||0);
      const discPct = +(document.getElementById('a-disc')?.value||0);
      const discAmt = sub*(discPct/100);
      const afterDisc = sub - discAmt;
      const vatAmt = afterDisc*(vatPct/100);
      const grand = afterDisc + vatAmt;
      totals = {sub, discPct, discAmt, vatPct, vatAmt, grand};
    } else {
      totals = {grand: sub};
    }
    return { title:titleMap[tab], headers, rows, totals, customer: txt(panel.querySelector(cfg.cust)) || '‚Äî' };
  }

  function buildPrintHTML(tab, qno){
    const data = collect(tab);
    

    // === Patch: Blank "Code" column for specific variants in PRINT (All Products) ===
    if (tab === 'all') {
      try {
        var __VARIANTS = [
          "Regular Accordion Door One Way",
          "Regular Accordion Door Two Way",
          "French Accordion Door One Way",
          "French Accordion Door Two Way",
          "Polycarbonate Accordion Door One Way",
          "Polycarbonate Accordion Door Two Way",
          "Pleated Mesh One Way",
          "Pleated Mesh Two Way",
          "Security Screen One Way",
          "Security Screen Two Way",
          "Top to Bottom Screen",
          "Honeycomb Only One way",
          "Honeycomb Only Two way",
          "Honeycomb Combination with Screen",
          // also cover title-cased versions to be safe
          "Honeycomb Only One Way",
          "Honeycomb Only Two Way"
        ].map(function(s){ return String(s).toLowerCase(); });
        (data.rows || []).forEach(function(r){
          // r[1] is "Type", r[2] is "Code" based on headers for tab==='all'
          var typeVal = String(r[1] || '').toLowerCase();
          if (__VARIANTS.indexOf(typeVal) !== -1) {
            r[2] = ''; // blank the Code cell
          }
        });
      } catch(__e) { /* no-op */ }
    }
const head = data.headers.map(h=>`<th>${h}</th>`).join('');
    const body = data.rows.map(r=>`<tr>${r.map((c,i)=>`<td${i===0?' class="idx"':''}>${c}</td>`).join('')}</tr>`).join('') || `<tr><td colspan="${data.headers.length}">No items</td></tr>`;
    const totals = (function(){
      const t=data.totals||{};
      if(tab==='all'){
        return `<table class="tot"><tr><th>Subtotal</th><td>${peso(t.sub||0)}</td></tr>${t.discPct?`<tr><th>Discount (${t.discPct}%)</th><td>- ${peso(t.discAmt||0)}</td></tr>`:''}${t.vatPct?`<tr><th>VAT (${t.vatPct}%)</th><td>${peso(t.vatAmt||0)}</td></tr>`:''}<tr class="grand"><th>Grand Total</th><td>${peso(t.grand||0)}</td></tr></table>`;
      }
      return `<table class="tot"><tr class="grand"><th>Grand Total</th><td>${peso(t.grand||0)}</td></tr></table>`;
    })();

    return `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Quotation ${qno}</title>
    <style>
      body{font-family:Arial,Helvetica,sans-serif;color:#111;margin:20px}
      .top{display:flex;justify-content:space-between;gap:20px}
      .brand h2{margin:0 0 6px}
      .brand .meta{font-size:12px;color:#555;line-height:1.5}
      .doc h3{margin:0}
      .doc table{font-size:12px}
      .doc th{padding-right:8px;text-align:left;color:#444}
      table.items{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px}
      table.items th,table.items td{border:1px solid #ddd;padding:6px 8px;text-align:left}
      table.items th{background:#f3f4f6}
      td.idx{text-align:center;width:36px}
      .totals{display:flex;justify-content:flex-end;margin-top:14px}
      .totals .tot{border-collapse:collapse;min-width:280px}
      .tot .grand th,.tot .grand td{font-weight:700}
      .sign{display:flex;gap:24px;margin-top:22px}
      .sign .line{margin-top:36px;border-top:1px solid #aaa;padding-top:4px;text-align:center;font-size:12px}
      @media print{ .noprint{display:none} body{margin:0} }
    </style>
<style>
  #a-table td.sqft, #a-table td.line {
    text-align: right;
    white-space: nowrap;
    min-width: 80px;
  }
</style>

</head><body>
      <div class="top">
        <div class="brand">
          <h2>GRAY HOME DECOR</h2>
          <div class="meta">[Address] ‚Ä¢ [Phone] ‚Ä¢ [Email] ‚Ä¢ TIN</div>
        </div>
        <div class="doc">
          <h3>QUOTATION</h3>
          <table>
            <tr><th>Quotation Ref</th><td>${qno}</td></tr>
<tr><th>Quotation Date</th><td>${todayISO()}</td></tr>
<tr><th>Quotation Validity</th><td>${validityPlus5()}</td></tr>
<tr><th>Client Name</th><td>${data.customer}</td></tr>
<tr><th>Project Location</th><td>${projectLocation() || "‚Äî"}</td></tr>
            <tr><th>Tab</th><td>${data.title||tab}</td></tr>
          </table>
        </div>
      </div>
      <table class="items"><thead><tr>${head}</tr></thead><tbody>${body}</tbody></table>
      <div class="totals">${totals}</div>
      <div class="sign">
        <div style="flex:1"><div class="line">Prepared By</div></div>
        <div style="flex:1"><div class="line">Approved By</div></div>
        <div style="flex:1"><div class="line">Customer Signature</div></div>
      </div>
      <div class="noprint" style="text-align:right;margin-top:10px"><button onclick="window.print()">Print</button></div>
    
<section class="panel theme-preset" id="panel-preset">
  <header class="panel-head">
    <h2>Preset Estimator (Wired to Main Products)</h2>
    <div class="row" style="gap:12px;align-items:center">
      <label>Customer: <input id="pre-cust" type="text" placeholder="Customer name"></label>
      <label>Discount %: <input id="pre-disc" type="number" value="0" step="any"></label>
      <label>VAT %: <input id="pre-vat" type="number" value="0" step="any"></label>
      <button id="pre-add" type="button">+ Add Item</button>
    </div>
  </header>
  <table id="pre-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Target</th>
        <th>Code</th>
        <th>Exact Code</th>
        <th>Room</th>
        <th>W</th>
        <th>Unit</th>
        <th>H</th>
        <th>Unit</th>
        <th>Sqft</th>
        <th>Options</th>
        <th>Total</th>
        <th>Remove</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <footer class="panel-foot">
    <div class="totals">
      <div>Subtotal: ‚Ç±<span id="pre-sub">0</span></div>
      <div>Discount: ‚Ç±<span id="pre-discAmt">0</span></div>
      <div>VAT: ‚Ç±<span id="pre-vatAmt">0</span></div>
      <div class="grand">Grand Total: ‚Ç±<span id="pre-grand">0</span></div>
      <div>Customer: <span id="pre-custOut">‚Äî</span></div>
    </div>
  </footer>
</section>


<script>
(function(){
  // Robust text extractor (non-invasive)
  function getCellText(td){
    if(!td) return '';
    var pt = td.querySelector('.print-text'); if (pt) return (pt.innerText||pt.textContent||'').trim();
    var sel = td.querySelector('select'); if (sel){ var opt = sel.options && sel.selectedIndex>=0 ? sel.options[sel.selectedIndex] : null; return ((opt && (opt.text||opt.innerText)) || sel.value || '').toString().trim(); }
    var inp = td.querySelector('input'); if (inp) return (inp.value||'').toString().trim();
    var ce  = td.querySelector('[contenteditable="true"]'); if (ce) return (ce.innerText||ce.textContent||'').trim();
    var disp= td.querySelector('[data-display],[data-value]'); if (disp) return (disp.getAttribute('data-display') || disp.getAttribute('data-value') || disp.innerText || disp.textContent || '').trim();
    var clone = td.cloneNode(true); clone.querySelectorAll('button,.btn,svg,i,.icon,[role="button"]').forEach(function(n){ n.remove(); });
    return (clone.innerText||clone.textContent||'').replace(/\s+/g,' ').trim();
  }
  function pad(n){return('0'+n).slice(-2);}
  function fmtDate(d){return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());}
  function dailyRef(){ const today=fmtDate(new Date()), k='ghd_ref_'+today; let n=+(localStorage.getItem(k)||0)+1; localStorage.setItem(k,n); return 'Grayhome'+String(n).padStart(3,'0'); }
  function textOf(id, fb){ const el=document.getElementById(id); return (el && el.value && el.value.trim())?el.value.trim():fb; }

  function buildPrintFromActive(tab){
    try{
      if (tab){
        const btn = document.querySelector('.tab-btn[data-tab="'+tab+'"]');
        if (btn) { try{ btn.click(); }catch(e){} }
      }
      const active = document.querySelector('.panel.active');
      const body = document.getElementById('ghd-print-body');
      if (!active || !body) return;
      body.innerHTML='';

      document.getElementById('ghdPH_client').textContent   = (active.querySelector('input[id$="-cust"]')?.value || textOf('a-cust','‚Äî'));
      document.getElementById('ghdPH_location').textContent = textOf('a-location','‚Äî');
      document.getElementById('ghdPF_material').textContent = textOf('a-material','‚Äî');
      document.getElementById('ghdPH_date').textContent     = fmtDate(new Date());
      document.getElementById('ghdPH_validity').textContent = fmtDate(new Date(Date.now()+5*864e5));
      document.getElementById('ghdPH_ref').textContent      = dailyRef();

      const srcTable = active.querySelector('table'); if (!srcTable) return;
      const clean = document.createElement('table');
      const thead = document.createElement('thead');
      const hrow = document.createElement('tr');
      [['SN','col-idx'],['Type','col-type'],['Code','col-code'],['Exact Code','col-code2'],['Area of House','col-room'],['Size (W √ó H)','col-size'],['Sq Ft','col-sqft'],['Options','col-opt'],['Total','col-total']]
      .forEach(function(h){ var th=document.createElement('th'); th.textContent=h[0]; th.className=h[1]; hrow.appendChild(th); });
      thead.appendChild(hrow); clean.appendChild(thead);
      const tbody = document.createElement('tbody');

      var rows = srcTable.querySelectorAll('tbody tr'); var sn=1;
      rows.forEach(function(tr){
        if (!tr.querySelector('td')) return;
        var cells = Array.from(tr.children);
        function by(cls){ return tr.querySelector('td.'+cls) || null; }
        var tdType  = by('col-type')  || cells[1] || null;
        var tdCode  = by('col-code')  || cells[2] || null;
        var tdCode2 = by('col-code2') || cells[3] || null;
        var tdRoom  = by('col-room')  || cells[4] || null;
        var tdW     = by('col-w');
        var tdH     = by('col-h');
        var tdUnit  = by('col-unit');
        var tdSqft  = by('col-sqft')  || null;
        var tdOpt   = by('col-opt')   || null;
        var tdTotal = by('col-total') || null;

        function readNum(cell){ if(!cell) return ''; var v=getCellText(cell).replace(/[^\d\.\-]/g,'').trim(); return v; }
        function readUnit(cell){
          if(!cell) return '';
          var sel = cell.querySelector('select'); if (sel){ var opt=sel.options && sel.selectedIndex>=0 ? sel.options[sel.selectedIndex] : null; return ((opt && (opt.text||opt.innerText)) || sel.value || '').toString().trim(); }
          return getCellText(cell);
        }
        var W=readNum(tdW), H=readNum(tdH), U=readUnit(tdUnit);
        var sizeTxt=(W&&H)?(W+' '+(U||'')+' √ó '+H+' '+(U||'')):'';

        var row=document.createElement('tr');
        function td(txt,cls){ var n=document.createElement('td'); n.textContent=(txt||'').toString(); if(cls) n.className=cls; return n; }
        var totalTxt=(getCellText(tdTotal)||'').replace(/‚Ç±/g,'P');
        row.appendChild(td(String(sn++),'col-idx'));
        row.appendChild(td(getCellText(tdType),'col-type'));
        row.appendChild(td(getCellText(tdCode),'col-code'));
        row.appendChild(td(getCellText(tdCode2),'col-code2'));
        row.appendChild(td(getCellText(tdRoom),'col-room'));
        row.appendChild(td(sizeTxt,'col-size'));
        row.appendChild(td(getCellText(tdSqft),'col-sqft'));
        row.appendChild(td(getCellText(tdOpt),'col-opt'));
        row.appendChild(td(totalTxt,'col-total'));

        var meaningful=[getCellText(tdType),getCellText(tdCode),getCellText(tdRoom),totalTxt].join('').trim();
        if (meaningful) tbody.appendChild(row);
      });

      clean.appendChild(tbody);
      body.appendChild(clean);

      var sub = active.querySelector('#a-subtotal, .subtotal, [data-total="subtotal"]');
      var grand = active.querySelector('#a-grandTotal, .grandtotal, [data-total="grand"]');
      var totalsDiv=document.createElement('div'); totalsDiv.style.cssText='margin-top:8px;text-align:right;';
      var subTxt=sub?(sub.textContent||sub.innerText||'').replace(/‚Ç±/g,'P').trim():'';
      var grandTxt=grand?(grand.textContent||grand.innerText||'').replace(/‚Ç±/g,'P').trim():'';
      if (subTxt && !/subtotal/i.test(subTxt)) subTxt='Subtotal: '+subTxt;
      if (grandTxt && !/grand/i.test(grandTxt)) grandTxt='Grand Total: '+grandTxt;
      totalsDiv.innerHTML='<div style="font-weight:600">'+(subTxt||'')+'</div><div style="font-weight:800">'+(grandTxt||'')+'</div>';
      body.appendChild(totalsDiv);
    }catch(e){ console.error('print build failed', e); }
  }

  // SAFE override: do not remove existing scripts, just provide our version last
  window.GHD = window.GHD || {};
  window.GHD.openQuote = function(tab){
    buildPrintFromActive(tab);
    window.print();
  };
})();
</script>


<script>
(function(){
  // ===== Enhanced robust text extractor =====
  function getVisibleDropdownText(root){
    // Common custom dropdown renderers
    var sel2 = root.querySelector('.select2-selection__rendered');
    if (sel2) return (sel2.title || sel2.innerText || sel2.textContent || '').trim();

    var choices = root.querySelector('.choices__item--selectable, .choices__item--selectable.is-highlighted');
    if (choices) return (choices.innerText || choices.textContent || '').trim();

    var combobox = root.querySelector('[role="combobox"]');
    if (combobox) return (combobox.getAttribute('aria-valuetext') || combobox.getAttribute('aria-label') || combobox.innerText || combobox.textContent || '').trim();

    var current = root.querySelector('.current, .selected, .ui-select-match-text, .dropdown-toggle[aria-expanded]');
    if (current) return (current.innerText || current.textContent || '').trim();

    // Data attributes often used by custom UIs
    var dataTxt = root.getAttribute('data-display') || root.getAttribute('data-value') || root.getAttribute('data-text');
    if (dataTxt) return dataTxt.trim();

    return '';
  }

  function getCellText(td){
    if(!td) return '';

    // Explicit print-only text override
    var pt = td.querySelector('.print-text');
    if (pt) return (pt.innerText||pt.textContent||'').trim();

    // Native select
    var sel = td.querySelector('select');
    if (sel) {
      var selection = '';
      if (sel.selectedOptions && sel.selectedOptions.length) {
        selection = Array.from(sel.selectedOptions).map(function(o){ return (o.text || o.innerText || o.value || '').trim(); }).join(', ');
      } else if (sel.options) {
        var opt = sel.querySelector('option[selected]');
        if (opt) selection = (opt.text || opt.innerText || opt.value || '').trim();
      }
      if (!selection) selection = sel.value || '';
      selection = selection.trim();
      if (selection) return selection;
      // If native select has no text, try visible custom widgets around it
      var v = getVisibleDropdownText(td);
      if (v) return v;
    }

    // Contenteditable
    var ce = td.querySelector('[contenteditable="true"]');
    if (ce) return (ce.innerText||ce.textContent||'').trim();

    // Input types
    var inp = td.querySelector('input, textarea');
    if (inp) return (inp.value||'').toString().trim();

    // Custom dropdowns (Select2/Choices/etc.) if present without a select
    var vdd = getVisibleDropdownText(td);
    if (vdd) return vdd;

    // Any element with data-display/value
    var disp = td.querySelector('[data-display],[data-value],[data-text]');
    if (disp) return (disp.getAttribute('data-display') || disp.getAttribute('data-value') || disp.getAttribute('data-text') || disp.innerText || disp.textContent || '').trim();

    // Fallback: text without buttons/icons
    var clone = td.cloneNode(true);
    clone.querySelectorAll('button,.btn,svg,i,.icon,[role="button"]').forEach(function(n){ n.remove(); });
    return (clone.innerText||clone.textContent||'').replace(/\s+/g,' ').trim();
  }

  function pad(n){return('0'+n).slice(-2);}
  function fmtDate(d){return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());}
  function dailyRef(){
    const today=fmtDate(new Date()), k='ghd_ref_'+today;
    let n = +(localStorage.getItem(k)||0)+1; localStorage.setItem(k,n);
    return 'Grayhome'+String(n).padStart(3,'0');
  }
  function textOf(id, fb){ const el=document.getElementById(id); return (el && el.value && el.value.trim())?el.value.trim():fb; }

  function buildPrintFromActive(tab){
    // Switch to requested tab (if any)
    if (tab){
      const btn = document.querySelector('.tab-btn[data-tab="'+tab+'"]');
      if (btn) { try { btn.click(); } catch(e){} }
    }
    const active = document.querySelector('.panel.active');
    const body = document.getElementById('ghd-print-body');
    if (!active || !body) return;
    body.innerHTML = '';

    // Header meta
    document.getElementById('ghdPH_client').textContent   = (active.querySelector('input[id$="-cust"]')?.value || textOf('a-cust','‚Äî'));
    document.getElementById('ghdPH_location').textContent = textOf('a-location','‚Äî');
    document.getElementById('ghdPF_material').textContent = textOf('a-material','‚Äî');
    document.getElementById('ghdPH_date').textContent     = fmtDate(new Date());
    document.getElementById('ghdPH_validity').textContent = fmtDate(new Date(Date.now()+5*864e5));
    document.getElementById('ghdPH_ref').textContent      = dailyRef();

    // Source table
    const srcTable = active.querySelector('table');
    if (!srcTable){ return; }

    // Build clean table
    const clean = document.createElement('table');
    const thead = document.createElement('thead');
    const hrow = document.createElement('tr');
    [['SN','col-idx'],['Type','col-type'],['Code','col-code'],['Exact Code','col-code2'],['Area of House','col-room'],['Size (W √ó H)','col-size'],['Sq Ft','col-sqft'],['Options','col-opt'],['Total','col-total']]
    .forEach(function(h){ var th=document.createElement('th'); th.textContent=h[0]; th.className=h[1]; hrow.appendChild(th); });
    thead.appendChild(hrow); clean.appendChild(thead);
    const tbody = document.createElement('tbody');

    var rows = srcTable.querySelectorAll('tbody tr'); var sn=1;
    rows.forEach(function(tr){
      if (!tr.querySelector('td')) return;

      function tdBy(cls){ return tr.querySelector('td.'+cls) || null; }
      var tdType  = tdBy('col-type')  || tr.children[1] || null;
      var tdCode  = tdBy('col-code')  || tr.children[2] || null;
      var tdCode2 = tdBy('col-code2') || tr.children[3] || null;
      var tdRoom  = tdBy('col-room')  || tr.children[4] || null;
      var tdW     = tdBy('col-w');
      var tdH     = tdBy('col-h');
      var tdUnit  = tdBy('col-unit');
      var tdSqft  = tdBy('col-sqft')  || null;
      var tdOpt   = tdBy('col-opt')   || null;
      var tdTotal = tdBy('col-total') || null;

      function readNum(cell){ if(!cell) return ''; var v=getCellText(cell).replace(/[^\d\.\-]/g,'').trim(); return v; }
      function readUnit(cell){
        if(!cell) return '';
        // prefer select/visible dropdown text
        var sel = cell.querySelector('select');
        if (sel) {
          var t = '';
          if (sel.selectedOptions && sel.selectedOptions.length) t = sel.selectedOptions[0].text;
          else t = sel.options && sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].text : sel.value;
          if (t) return (t || '').trim();
        }
        var v = getVisibleDropdownText(cell); if (v) return v;
        return getCellText(cell);
      }
      var W=readNum(tdW), H=readNum(tdH), U=readUnit(tdUnit);
      var sizeTxt=(W&&H)?(W+' '+(U||'')+' √ó '+H+' '+(U||'')):'';

      var row=document.createElement('tr');
      function td(txt,cls){ var n=document.createElement('td'); n.textContent=(txt==null?'':String(txt)); if(cls) n.className=cls; return n; }
      var typeTxt  = getCellText(tdType);
      var codeTxt  = getCellText(tdCode);
      var code2Txt = getCellText(tdCode2);
      var roomTxt  = getCellText(tdRoom);
      var sqftTxt  = getCellText(tdSqft);
      var optTxt   = getCellText(tdOpt);
      // Business rule: Only show Options if Type contains "Magic Blinds". Otherwise blank defaults like "Plastic (free)".
      var isMagic = /magic\s*blinds/i.test(typeTxt || '');
      if (!isMagic) {
        if (/plastic\s*\(free\)/i.test(optTxt)) optTxt = '';
        if (/^\s*[-‚Äì‚Äî]?\s*$/.test(optTxt)) optTxt = '';
      }
      var totalTxt = (getCellText(tdTotal)||'').replace(/‚Ç±/g,'P');

      row.appendChild(td(String(sn++),'col-idx'));
      row.appendChild(td(typeTxt,'col-type'));
      row.appendChild(td(codeTxt,'col-code'));
      row.appendChild(td(code2Txt,'col-code2'));
      row.appendChild(td(roomTxt,'col-room'));
      row.appendChild(td(sizeTxt,'col-size'));
      row.appendChild(td(sqftTxt,'col-sqft'));
      row.appendChild(td(optTxt,'col-opt'));
      row.appendChild(td(totalTxt,'col-total'));

      // Keep the row if it has any select/input or has any non-empty text (to avoid dropping real selections)
      var hasInteractive = tr.querySelector('select,input,textarea,[contenteditable="true"]');
      var hasText = [typeTxt,codeTxt,roomTxt,optTxt,totalTxt,sizeTxt,sqftTxt,code2Txt].some(function(t){ return (t||'').trim().length>0; });
      if (hasInteractive || hasText) tbody.appendChild(row);
    });

    clean.appendChild(tbody);
    body.appendChild(clean);

    // Subtotal & Grand Total
    var sub = active.querySelector('#a-subtotal, .subtotal, [data-total="subtotal"], .totals .subtotal');
    var grand = active.querySelector('#a-grandTotal, .grandtotal, [data-total="grand"], .totals .grandtotal');
    var totalsDiv=document.createElement('div'); totalsDiv.style.cssText='margin-top:8px;text-align:right;';
    var subTxt=sub?(sub.textContent||sub.innerText||'').replace(/‚Ç±/g,'P').trim():'';
    var grandTxt=grand?(grand.textContent||grand.innerText||'').replace(/‚Ç±/g,'P').trim():'';
    if (subTxt && !/subtotal/i.test(subTxt)) subTxt='Subtotal: '+subTxt;
    if (grandTxt && !/grand/i.test(grandTxt)) grandTxt='Grand Total: '+grandTxt;
    totalsDiv.innerHTML='<div style="font-weight:600">'+(subTxt||'')+'</div><div style="font-weight:800">'+(grandTxt||'')+'</div>';
    body.appendChild(totalsDiv);
  }

  // Override openQuote last
  window.GHD = window.GHD || {};
  window.GHD.openQuote = function(tab){
    buildPrintFromActive(tab);
    window.print();
  };
})();
</script>


<script>
(function(){
  function getVisibleDropdownText(root){
    var sel2 = root.querySelector('.select2-selection__rendered');
    if (sel2) return (sel2.title || sel2.innerText || sel2.textContent || '').trim();
    var choices = root.querySelector('.choices__item--selectable, .choices__item--selectable.is-highlighted');
    if (choices) return (choices.innerText || choices.textContent || '').trim();
    var combobox = root.querySelector('[role="combobox"]');
    if (combobox) return (combobox.getAttribute('aria-valuetext') || combobox.getAttribute('aria-label') || combobox.innerText || combobox.textContent || '').trim();
    var current = root.querySelector('.current, .selected, .ui-select-match-text, .dropdown-toggle[aria-expanded]');
    if (current) return (current.innerText || current.textContent || '').trim();
    var dataTxt = root.getAttribute('data-display') || root.getAttribute('data-value') || root.getAttribute('data-text');
    if (dataTxt) return dataTxt.trim();
    return '';
  }
  function getCellText(td){
    if(!td) return '';
    var pt = td.querySelector('.print-text');
    if (pt) return (pt.innerText||pt.textContent||'').trim();
    var sel = td.querySelector('select');
    if (sel) {
      var selection = '';
      if (sel.selectedOptions && sel.selectedOptions.length) {
        selection = Array.from(sel.selectedOptions).map(function(o){ return (o.text || o.innerText || o.value || '').trim(); }).join(', ');
      } else if (sel.options) {
        var opt = sel.querySelector('option[selected]');
        if (opt) selection = (opt.text || opt.innerText || opt.value || '').trim();
      }
      if (!selection) selection = sel.value || '';
      selection = selection.trim();
      if (selection) return selection;
      var v = getVisibleDropdownText(td);
      if (v) return v;
    }
    var ce = td.querySelector('[contenteditable="true"]');
    if (ce) return (ce.innerText||ce.textContent||'').trim();
    var inp = td.querySelector('input, textarea');
    if (inp) return (inp.value||'').toString().trim();
    var vdd = getVisibleDropdownText(td);
    if (vdd) return vdd;
    var disp = td.querySelector('[data-display],[data-value],[data-text]');
    if (disp) return (disp.getAttribute('data-display') || disp.getAttribute('data-value') || disp.getAttribute('data-text') || disp.innerText || disp.textContent || '').trim();
    var clone = td.cloneNode(true);
    clone.querySelectorAll('button,.btn,svg,i,.icon,[role="button"]').forEach(function(n){ n.remove(); });
    return (clone.innerText||clone.textContent||'').replace(/\s+/g,' ').trim();
  }
  function pad(n){return('0'+n).slice(-2);}
  function fmtDate(d){return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());}
  function dailyRef(){const today=fmtDate(new Date()), k='ghd_ref_'+today; let n=+(localStorage.getItem(k)||0)+1; localStorage.setItem(k,n); return 'Grayhome'+String(n).padStart(3,'0');}
  function textOf(id, fb){ const el=document.getElementById(id); return (el && el.value && el.value.trim())?el.value.trim():fb; }

  function buildPrintFromActive(tab){
    if (tab){
      const btn = document.querySelector('.tab-btn[data-tab="'+tab+'"]');
      if (btn) { try { btn.click(); } catch(e){} }
    }
    const active = document.querySelector('.panel.active');
    const body = document.getElementById('ghd-print-body');
    if (!active || !body) return;
    body.innerHTML = '';

    // Header meta
    document.getElementById('ghdPH_client').textContent   = (active.querySelector('input[id$="-cust"]')?.value || textOf('a-cust','‚Äî'));
    document.getElementById('ghdPH_location').textContent = textOf('a-location','‚Äî');
    document.getElementById('ghdPF_material').textContent = textOf('a-material','‚Äî');
    document.getElementById('ghdPH_date').textContent     = fmtDate(new Date());
    document.getElementById('ghdPH_validity').textContent = fmtDate(new Date(Date.now()+5*864e5));
    document.getElementById('ghdPH_ref').textContent      = dailyRef();

    const srcTable = active.querySelector('table'); if (!srcTable) return;

    // First pass: collect rows & detect whether Options column is needed
    var rows = Array.from(srcTable.querySelectorAll('tbody tr'));
    var prepared = [];
    var showOptions = false;
    var sn = 1;
    rows.forEach(function(tr){
      if (!tr.querySelector('td')) return;
      function tdBy(cls){ return tr.querySelector('td.'+cls) || null; }
      var tdType  = tdBy('col-type')  || tr.children[1] || null;
      var tdCode  = tdBy('col-code')  || tr.children[2] || null;
      var tdCode2 = tdBy('col-code2') || tr.children[3] || null;
      var tdRoom  = tdBy('col-room')  || tr.children[4] || null;
      var tdW     = tdBy('col-w');
      var tdH     = tdBy('col-h');
      var tdUnit  = tdBy('col-unit');
      var tdSqft  = tdBy('col-sqft')  || null;
      var tdOpt   = tdBy('col-opt')   || null;
      var tdTotal = tdBy('col-total') || null;

      function readNum(cell){ if(!cell) return ''; var v=getCellText(cell).replace(/[^\d\.\-]/g,'').trim(); return v; }
      function readUnit(cell){
        if(!cell) return '';
        var sel = cell.querySelector('select');
        if (sel) {
          var t = '';
          if (sel.selectedOptions && sel.selectedOptions.length) t = sel.selectedOptions[0].text;
          else t = sel.options && sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].text : sel.value;
          if (t) return (t || '').trim();
        }
        var v = getVisibleDropdownText(cell); if (v) return v;
        return getCellText(cell);
      }
      var W=readNum(tdW), H=readNum(tdH), U=readUnit(tdUnit);
      var sizeTxt=(W&&H)?(W+' '+(U||'')+' √ó '+H+' '+(U||'')):'';

      var typeTxt  = getCellText(tdType);
      var codeTxt  = getCellText(tdCode);
      var code2Txt = getCellText(tdCode2);
      var roomTxt  = getCellText(tdRoom);
      var sqftTxt  = getCellText(tdSqft);
      var optTxt   = getCellText(tdOpt);
      var totalTxt = (getCellText(tdTotal)||'').replace(/‚Ç±/g,'P');

      // Business rule: only show options for Magic Blinds; otherwise blank
      var isMagic = /magic\s*blinds/i.test(typeTxt || '');
      if (!isMagic) {
        if (/plastic\s*\(free\)/i.test(optTxt) || /^\s*[-‚Äì‚Äî]?\s*$/.test(optTxt)) optTxt = '';
      }
      if (isMagic && optTxt.trim().length>0) showOptions = true;

      var meaningful = [typeTxt,codeTxt,roomTxt,totalTxt,sizeTxt,sqftTxt,code2Txt,optTxt].join('').trim();
      if (!meaningful) return;

      prepared.push({sn: sn++, typeTxt, codeTxt, code2Txt, roomTxt, sizeTxt, sqftTxt, optTxt, totalTxt, isMagic});
    });

    // Build clean table
    const clean = document.createElement('table');
    const thead = document.createElement('thead');
    const hrow = document.createElement('tr');
    function addH(text, cls){ var th=document.createElement('th'); th.textContent=text; th.className=cls; hrow.appendChild(th); }
    addH('SN','col-idx');
    addH('Type','col-type');
    addH('Code','col-code');
    addH('Exact Code','col-code2');
    addH('Area of House','col-room');
    addH('Size (W √ó H)','col-size');
    addH('Sq Ft','col-sqft');
    if (showOptions) addH('Options','col-opt');
    addH('Total','col-total');
    thead.appendChild(hrow); clean.appendChild(thead);

    const tbody = document.createElement('tbody');
    prepared.forEach(function(r){
      var tr=document.createElement('tr');
      function td(txt,cls){ var n=document.createElement('td'); n.textContent=(txt==null?'':String(txt)); if(cls) n.className=cls; return n; }
      tr.appendChild(td(String(r.sn),'col-idx'));
      tr.appendChild(td(r.typeTxt,'col-type'));
      tr.appendChild(td(r.codeTxt,'col-code'));
      tr.appendChild(td(r.code2Txt,'col-code2'));
      tr.appendChild(td(r.roomTxt,'col-room'));
      tr.appendChild(td(r.sizeTxt,'col-size'));
      tr.appendChild(td(r.sqftTxt,'col-sqft'));
      if (showOptions) tr.appendChild(td(r.isMagic ? r.optTxt : '', 'col-opt'));
      tr.appendChild(td(r.totalTxt,'col-total'));
      tbody.appendChild(tr);
    });
    clean.appendChild(tbody);
    body.appendChild(clean);

    // Totals
    var sub = active.querySelector('#a-subtotal, .subtotal, [data-total="subtotal"], .totals .subtotal');
    var grand = active.querySelector('#a-grandTotal, .grandtotal, [data-total="grand"], .totals .grandtotal');
    var totalsDiv=document.createElement('div'); totalsDiv.style.cssText='margin-top:8px;text-align:right;';
    var subTxt=sub?(sub.textContent||sub.innerText||'').replace(/‚Ç±/g,'P').trim():'';
    var grandTxt=grand?(grand.textContent||grand.innerText||'').replace(/‚Ç±/g,'P').trim():'';
    if (subTxt && !/subtotal/i.test(subTxt)) subTxt='Subtotal: '+subTxt;
    if (grandTxt && !/grand/i.test(grandTxt)) grandTxt='Grand Total: '+grandTxt;
    totalsDiv.innerHTML='<div style="font-weight:600">'+(subTxt||'')+'</div><div style="font-weight:800">'+(grandTxt||'')+'</div>';
    body.appendChild(totalsDiv);
  }

  // Override openQuote last
  window.GHD = window.GHD || {};
  window.GHD.openQuote = function(tab){
    buildPrintFromActive(tab);
    window.print();
  };
})();
</script>


<script id="ghd-compute-total">
(function(){
  function parseAmt(txt){
    if(!txt) return 0;
    var v = String(txt).replace(/[^\d\-\.,]/g, '').replace(/,/g,'');
    var n = parseFloat(v);
    return isNaN(n) ? 0 : n;
  }
  function fmtPHP(n){
    try{
      return new Intl.NumberFormat('en-PH', {style:'currency', currency:'PHP', minimumFractionDigits:2}).format(n);
    }catch(e){
      var s = (Math.round(n*100)/100).toFixed(2);
      var parts = s.split('.'); parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      return '‚Ç±' + parts.join('.');
    }
  }
  function computeAndRender(){
    var root = document.getElementById('ghd-print-body');
    if(!root) return;
    var table = root.querySelector('table');
    if(!table) return;
    var rows = table.querySelectorAll('tbody tr');
    var total = 0;
    rows.forEach(function(tr){
      var td = tr.querySelector('.col-total') || tr.lastElementChild;
      if(!td) return;
      total += parseAmt(td.textContent||td.innerText||'');
    });
    var tf = table.querySelector('#ghd-totals-foot');
    if(!tf) {
      tf = document.createElement('tfoot');
      tf.id = 'ghd-totals-foot';
      table.appendChild(tf);
    }
    tf.innerHTML = '';
    var tr = document.createElement('tr');
    var head = table.querySelector('thead tr');
    var colCount = head ? head.children.length : 8;
    var label = document.createElement('td');
    label.colSpan = Math.max(1, colCount - 1);
    label.className = 'label';
    label.textContent = 'Grand Total:';
    var amt = document.createElement('td');
    amt.className = 'amount';
    amt.textContent = fmtPHP(total);
    tr.appendChild(label);
    tr.appendChild(amt);
    tf.appendChild(tr);
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', computeAndRender);
  } else {
    computeAndRender();
  }
  window.addEventListener('beforeprint', computeAndRender);
})();
</script>


<script id="ghd-inline-pl-and-autofill">
(function(){
  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function addDaysISO(n){ var d=new Date(); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }
  function nextGlobalSeq(){
    try{ var raw=localStorage.getItem('ghd_quote_seq'); var num=parseInt(raw||'0',10); if(isNaN(num)) num=0; num+=1; localStorage.setItem('ghd_quote_seq', String(num)); return num; }
    catch(e){ return Math.floor(Date.now()/1000); }
  }
  function buildRef(){ return 'GrayHome'+todayISO().replace(/-/g,'')+'-'+nextGlobalSeq(); }
  function setTxt(id,val){ var el=document.getElementById(id); if(el) el.textContent=val; }
  function getVal(sel){
    var el=null, list=[sel].flat();
    for (var i=0;i<list.length;i++){ try{ el=document.querySelector(list[i]); if(el) return (el.value||'').trim(); }catch(e){} }
    return '';
  }
  function findClientInput(){
    var selectors=['#clientName','#client-name','#customerName','#customer-name','input[name="client"]','input[name="customer"]','input[placeholder*="Client"]','input[placeholder*="Customer"]'];
    for (var i=0;i<selectors.length;i++){ try{ var el=document.querySelector(selectors[i]); if(el) return el; }catch(e){} }
    return null;
  }
  function injectProjectLocationInline(){
    if(document.getElementById('projectLocationInput')) return true;
    var client=findClientInput(); if(!client) return false;
    var wrap=document.createElement('span');
    wrap.id='ghd-inline-pl-wrap';
    wrap.style.cssText='display:inline-flex;align-items:center;gap:8px;margin-left:16px;';
    var label=document.createElement('label');
    label.setAttribute('for','projectLocationInput'); label.textContent='Project Location:'; label.style.fontWeight='600';
    var input=document.createElement('input');
    input.type='text'; input.id='projectLocationInput'; input.placeholder='Type project location‚Ä¶';
    input.style.cssText='min-width:260px;padding:6px 8px;border:1px solid #ccc;border-radius:6px;';
    wrap.appendChild(label); wrap.appendChild(input);
    if(client.parentNode) client.parentNode.insertBefore(wrap, client.nextSibling); else client.insertAdjacentElement('afterend', wrap);
    return true;
  }
  function fillMeta(){
    var pl = getVal('#projectLocationInput') || '‚Äî';
    setTxt('ghdPH_location', pl);
    setTxt('ghdPH_date', todayISO());
    setTxt('ghdPH_validity', addDaysISO(5));
    setTxt('ghdPH_ref', buildRef());
  }
  function wireFooterNotes(){
    function applyNotes(){
      var footer=document.getElementById('ghd-print-footer'); if(!footer) return;
      var box=footer.querySelector('#ghd-footer-notes');
      if(!box){ box=document.createElement('div'); box.id='ghd-footer-notes'; footer.appendChild(box); }
      var ta=document.getElementById('ghdFooterNotesInput');
      var txt=ta && ta.value ? ta.value.trim() : '';
      if(txt){ box.textContent=txt; box.style.display=''; } else { box.textContent=''; box.style.display='none'; }
    }
    document.addEventListener('input', function(e){ if(e && e.target && e.target.id==='ghdFooterNotesInput') applyNotes(); });
    window.addEventListener('beforeprint', applyNotes);
    applyNotes();
  }
  function init(){
    injectProjectLocationInline();
    wireFooterNotes();
    document.addEventListener('DOMContentLoaded', fillMeta);
    window.addEventListener('beforeprint', fillMeta);
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
})();
</script>


<script id="ghd-wire-pl-and-footer">
(function(){
  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function addDaysISO(n){ var d=new Date(); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }
  function nextGlobalSeq(){
    try{ var raw=localStorage.getItem('ghd_quote_seq'); var num=parseInt(raw||'0',10); if(isNaN(num)) num=0; num+=1; localStorage.setItem('ghd_quote_seq', String(num)); return num; }
    catch(e){ return Math.floor(Date.now()/1000); }
  }
  function buildRef(){ return 'GrayHome'+todayISO().replace(/-/g,'')+'-'+nextGlobalSeq(); }
  function setTxt(id, val){ var el=document.getElementById(id); if(el) el.textContent = val; }

  function applyProjectLocation(){
    var pl = document.getElementById('projectLocationInput');
    var txt = pl && pl.value.trim() ? pl.value.trim() : '‚Äî';
    setTxt('ghdPH_location', txt);
  }

  function applyFooterNotes(){
    var ta = document.getElementById('ghdFooterNotesInput');
    var txt = ta && ta.value ? ta.value.trim() : '';
    var footer = document.getElementById('ghd-print-footer');
    if(!footer) return;
    var box = footer.querySelector('#ghd-footer-notes');
    if(!box){
      box = document.createElement('div');
      box.id = 'ghd-footer-notes';
      footer.appendChild(box);
    }
    if(txt){
      box.textContent = txt;
      box.style.display = '';
      box.style.whiteSpace = 'pre-wrap';
    } else {
      box.textContent = '';
      box.style.display = 'none';
    }
  }

  function fillSystemMeta(){
    setTxt('ghdPH_date', todayISO());
    setTxt('ghdPH_validity', addDaysISO(5));
    setTxt('ghdPH_ref', buildRef());
  }

  function init(){
    // Live updates while typing (so user can preview on screen if desired)
    document.addEventListener('input', function(e){
      if(e.target && e.target.id === 'projectLocationInput'){ applyProjectLocation(); }
      if(e.target && e.target.id === 'ghdFooterNotesInput'){ applyFooterNotes(); }
    });
    // Initial population
    applyProjectLocation();
    applyFooterNotes();
    fillSystemMeta();
    // Ensure fresh values when printing
    window.addEventListener('beforeprint', function(){
      applyProjectLocation();
      applyFooterNotes();
      fillSystemMeta();
    });
  }
  if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
})();
</script>


<script id="ghd-red-notes-only">
(function(){
  "use strict";
  const norm = s => (s||"").toString().toLowerCase().replace(/[\s\-.]+/g,"").trim();
  const UNIT_TOKENS = new Set(["in","inch","inches","ft","foot","feet","cm","m","meter","metre","meters","metres"]);
  let SUPPRESS_MO = false; // prevent MO loops during our own updates

  function detectUnitFromSelect(sel){
    if(!sel) return null;
    const hasUnits = Array.from(sel.options||[]).some(o => UNIT_TOKENS.has(norm(o.value||o.textContent)));
    if(!hasUnits) return null;
    const opt = sel.options[sel.selectedIndex];
    const raw = (opt ? (opt.value||opt.textContent) : sel.value) || "";
    return norm(raw);
  }
  function detectUnitFromInput(input){
    if(!input) return null;
    const blob = [input.getAttribute("aria-label"), input.placeholder, input.name, input.getAttribute("data-k"), input.className].join(" ").toLowerCase();
    if(/\bcm\.?\b/.test(blob)) return "cm";
    if(/\bm\.?\b/.test(blob)) return "m";
    if(/\b(in|inch|inches)\.?\b/.test(blob)) return "in";
    if(/\b(ft|feet|foot)\.?\b/.test(blob)) return "ft";
    return null;
  }
  function toInches(value, unit){
    const v = parseFloat(value);
    if(!isFinite(v)) return null;
    const u = unit ? norm(unit) : null;
    if(!u) return null;
    if(u==="in"||u==="inch"||u==="inches") return v;
    if(u==="ft"||u==="foot"||u==="feet") return v*12;
    if(u==="cm") return v*0.3937007874;
    if(u==="m"||u==="meter"||u==="metre"||u==="meters"||u==="metres") return v*39.37007874;
    return null;
  }
  function toCentimeters(value, unit){
    const v = parseFloat(value);
    if(!isFinite(v)) return null;
    const u = unit ? norm(unit) : null;
    if(!u) return null;
    if(u==="cm") return v;
    if(u==="m"||u==="meter"||u==="metre"||u==="meters"||u==="metres") return v*100;
    if(u==="in"||u==="inch"||u==="inches") return v*2.54;
    if(u==="ft"||u==="foot"||u==="feet") return v*30.48;
    return null;
  }

  function findDimInput(tr, kind){
    const INPUTS = Array.from(tr.querySelectorAll('input'));
    const KW = kind==='w' ? /(width|^w$|\bw\b)/i : /(height|^h$|\bh\b)/i;
    const byAttr = INPUTS.find(inp=>{
      const attrs=[inp.getAttribute("data-k"),inp.name,inp.getAttribute("aria-label"),inp.placeholder,inp.className].join(" ").toLowerCase();
      return KW.test(attrs);
    });
    const inp = byAttr || (kind==='w'? INPUTS[0] : INPUTS[1]) || null;
    if(!inp) return {input:null, unitSel:null, unit:null};

    function nearestUnitSelect(from){
      let n=from.nextElementSibling; while(n){ if(n.tagName==="SELECT") return n; n=n.nextElementSibling; }
      n=from.previousElementSibling; while(n){ if(n.tagName==="SELECT") return n; n=n.previousElementSibling; }
      const td=from.closest("td")||from.closest("th");
      if(td){ const s=td.querySelector("select"); if(s) return s; }
      return Array.from(from.closest("tr").querySelectorAll("select")).find(s=>{
        return Array.from(s.options||[]).some(o=> UNIT_TOKENS.has(norm(o.value||o.textContent)));
      })||null;
    }
    const sel = nearestUnitSelect(inp);
    const unit = detectUnitFromSelect(sel) || detectUnitFromInput(inp);
    return { input: inp, unitSel: sel, unit };
  }

  function getType(tr){
    if(!tr || !tr.closest("#a-table")) return "";
    const sel = tr.querySelector("select"); return sel ? sel.value : "";
  }

  function optionsCell(tr){
    let td = tr.querySelector("td.col-opt");
    if(td) return td;
    const table = tr.closest("table"); if(!table) return null;
    const head = table.tHead || table.querySelector("thead");
    if(!head) return null;
    const ths = Array.from(head.querySelectorAll("th"));
    let idx = ths.findIndex(th => (th.textContent||"").toLowerCase().includes("options"));
    if(idx<0) return null;
    const cells = tr.children; return cells && cells[idx] ? cells[idx] : null;
  }

  function hideBlackNotes(td){
    if(!td) return;
    const KEYWORDS = /(exceed|height|width|cladding|inches|cm|meter|metre|m\b)/i;
    Array.from(td.childNodes).forEach(node=>{
      if(node.nodeType===3){
        const txt = String(node.textContent||"").trim();
        if(txt && KEYWORDS.test(txt)){
          SUPPRESS_MO = true;
          const span = document.createElement("span");
          span.style.display = "none";
          span.className = "ghd-legacy-note-muted";
          span.textContent = txt;
          node.parentNode.replaceChild(span, node);
          SUPPRESS_MO = false;
        }
        return;
      }
      if(node.nodeType===1){
        const el = node;
        if(el.classList && el.classList.contains("ghd-rule-note-red")) return;
        if(/^(INPUT|SELECT|TEXTAREA|BUTTON)$/.test(el.tagName)) return;
        const txt = (el.textContent||"").trim();
        if(txt && KEYWORDS.test(txt)){
          SUPPRESS_MO = true;
          el.style.display = "none";
          el.classList.add("ghd-legacy-note-muted");
          SUPPRESS_MO = false;
        }
      }
    });
  }

  function setNote(tr, text){
    const td = optionsCell(tr); if(!td) return;
    hideBlackNotes(td);
    let el = td.querySelector(".ghd-rule-note-red");
    if(text && !el){
      SUPPRESS_MO = true;
      el = document.createElement("div");
      el.className = "ghd-rule-note-red";
      el.setAttribute("style","color:#b91c1c;font-size:12px;line-height:1.2;margin-top:4px;white-space:normal;");
      td.appendChild(el);
      SUPPRESS_MO = false;
    }
    if(el){
      if(text){
        if(el.textContent !== text){
          SUPPRESS_MO = true;
          el.textContent = text;
          SUPPRESS_MO = false;
        }
      }else{
        SUPPRESS_MO = true;
        el.remove();
        SUPPRESS_MO = false;
      }
    }
  }

  function evaluate(tr){
    if(!tr || !tr.closest("#a-table")) return;
    const t = norm(getType(tr));
    const w = findDimInput(tr,"w");
    const h = findDimInput(tr,"h");

    const wCm = w.input ? toCentimeters(w.input.value, w.unit) : null;
    const hCm = h.input ? toCentimeters(h.input.value, h.unit) : null;
    const wIn = w.input ? toInches(w.input.value, w.unit) : null;
    const hIn = h.input ? toInches(h.input.value, h.unit) : null;

    let notes = [];

    // Polycarbonate Accordion
    if(t.includes("polycarbonate") && t.includes("accordiondoor")){
      const isOneWay = t.includes("oneway");
      const isTwoWay = t.includes("twoway");
      if(isOneWay){
        if(wCm!=null && wCm > 600) notes.push("width exceeds 600cm");
        if(hCm!=null && hCm > 304.8) notes.push('Exceeds "height 304.8 cm "');
      } else if(isTwoWay){
        if(wCm!=null && wCm > 600) notes.push("exceeds 600 cm width");
        if(hCm!=null && hCm > 305) notes.push("height exceeds 305 cm");
      } else {
        if(wCm!=null && wCm > 600) notes.push("exceeds 600 cm width");
        if(hCm!=null && hCm > 305) notes.push("height exceeds 305 cm");
      }
    }

    // Honeycomb
    if(t==="honeycombonlyoneway"){
      if(wCm!=null && wCm > 239) notes.push("exceeds 239 cm width");
      if(hCm!=null && hCm > 280) notes.push("height exceeds 280 cm");
    } else if(t==="honeycombonlytwoway"){
      if(wCm!=null && wCm > 480) notes.push("exceeds 480 cm width");
      if(hCm!=null && hCm > 280) notes.push("height exceeds 280 cm");
    } else if(t.includes("honeycomb") && (t.includes("combinationwithscreen") || t.includes("screen"))){
      if(wCm!=null && wCm > 239) notes.push("exceeds 239 cm width");
      if(hCm!=null && hCm > 280) notes.push("height exceeds 280 cm");
    }

    // Top to Bottom Screen (cm)
    if(t==="toptobottomscreen"){
      if(wCm!=null && wCm > 200) notes.push("exceeds 200 cm width");
      if(hCm!=null && hCm > 177.8) notes.push("height exceeds 177.8 cm");
    }

    
    // Security Screen (cm) ‚Äî One Way & Two Way share the same limits
    if(t==="securityscreenoneway" || t==="securityscreentwoway"){
      if(wCm!=null && wCm > 600) notes.push("exceeds 600 cm width");
      if(hCm!=null && hCm > 304.8) notes.push("height exceeds 304.8 cm");
    }
    // Roller & Combi (inches)
    if(t==="roller" || t==="combi"){
      if(wIn!=null && wIn > 78) notes.push("exceeds 78 inches width ‚Äî suggest cutting into 2 or 3 panels");
    }

    // Regular & French Accordion Door (inches)
    if(t.includes("regularaccordiondoor") || t.includes("frenchaccordiondoor")){
      if(hIn!=null && hIn > 120) notes.push("height exceeds 120 inches ‚Äî must add cladding (max height 120 inches)");
    }

    setNote(tr, notes.join(" ¬∑ "));
  }

  function applyAll(){ document.querySelectorAll("#a-table tbody tr").forEach(evaluate); }

  function init(){
    if(!document.getElementById("a-table")) return;
    applyAll();
    const tbl = document.getElementById("a-table");

    tbl.addEventListener("input", (e)=>{
      const tr = e.target && e.target.closest && e.target.closest("#a-table tr");
      if(tr) evaluate(tr);
    }, false);
    tbl.addEventListener("change", (e)=>{
      const tr = e.target && e.target.closest && e.target.closest("#a-table tr");
      if(tr) evaluate(tr);
    }, false);

    const tbody = tbl.querySelector("tbody");
    if(tbody){
      new MutationObserver((muts)=>{
        if(SUPPRESS_MO) return;
        const relevant = muts.some(m => Array.from(m.addedNodes||[]).some(n=> n.nodeType===1 && n.tagName==="TR") ||
                                         Array.from(m.removedNodes||[]).some(n=> n.nodeType===1 && n.tagName==="TR"));
        if(!relevant) return;
        (window.requestAnimationFrame||function(cb){return setTimeout(cb,0);})(applyAll);
      }).observe(tbody, {childList:true, subtree:false});
    }

    window.addEventListener("beforeprint", applyAll);
  }
  if(document.readyState!=="loading") init(); else document.addEventListener("DOMContentLoaded", init);
})();
</script>


<script id="ghd-force-cm-for-types">
(function(){
  "use strict";
  const norm = s => (s||"").toString().toLowerCase().replace(/[\s\-.]+/g,"").trim();
  const FORCE = new Set([
    norm("Polycarbonate Accordion Door One Way"),
    norm("Polycarbonate Accordion Door Two Way"),
    norm("Pleated Mesh One Way"),
    norm("Pleated Mesh Two Way"),
    norm("Security Screen One Way"),
    norm("Security Screen Two Way"),
    norm("Top to Bottom Screen"),
    norm("Honeycomb Only One way"),
    norm("Honeycomb Only Two way"),
    norm("Honeycomb Combination with Screen")
  ]);
  const UNIT_TOKENS = new Set(["in","inch","inches","ft","foot","feet","cm","m","meter","metre","meters","metres"]);
  let SUPPRESS_MO = false;

  function getType(tr){
    if(!tr || !tr.closest("#a-table")) return "";
    const sel = tr.querySelector("select"); return sel ? sel.value : "";
  }
  function isUnitSelect(sel){
    if(!sel) return false;
    const opts = Array.from(sel.options||[]);
    if(!opts.length) return false;
    const vals = opts.map(o => norm(o.value||o.textContent));
    return vals.some(v => UNIT_TOKENS.has(v));
  }
  function unitSelectsInRow(tr){
    const first = tr.querySelector("select");
    return Array.from(tr.querySelectorAll("select")).filter(s => s!==first && isUnitSelect(s));
  }
  function enforceCm(tr){
    const t = norm(getType(tr));
    if(!FORCE.has(t)) return;
    const sels = unitSelectsInRow(tr);
    sels.forEach(sel => {
      const cmOpt = Array.from(sel.options||[]).find(o => norm(o.value||o.textContent)==="cm");
      if(cmOpt && sel.value !== (cmOpt.value||"cm")){
        SUPPRESS_MO = true;
        sel.value = cmOpt.value || "cm";
        try{ sel.dispatchEvent(new Event("change", {bubbles:true})); }catch(_){}
        SUPPRESS_MO = false;
      }
    });
  }
  function applyAll(){ document.querySelectorAll("#a-table tbody tr").forEach(enforceCm); }
  function init(){
    if(!document.getElementById("a-table")) return;
    applyAll();
    document.getElementById("a-table").addEventListener("change", (e)=>{
      const tr = e.target && e.target.closest && e.target.closest("#a-table tr");
      if(tr) enforceCm(tr);
    }, false);
    const tbody = document.querySelector("#a-table tbody");
    if(tbody){
      new MutationObserver((muts)=>{
        if(SUPPRESS_MO) return;
        const relevant = muts.some(m => Array.from(m.addedNodes||[]).some(n=> n.nodeType===1 && n.tagName==="TR"));
        if(!relevant) return;
        (window.requestAnimationFrame||function(cb){return setTimeout(cb,0);})(applyAll);
      }).observe(tbody, {childList:true, subtree:false});
    }
    window.addEventListener("beforeprint", applyAll);
  }
  if(document.readyState!=="loading") init(); else document.addEventListener("DOMContentLoaded", init);
})();
</script>




<script id="ghd-main-prices-io-v2">
(function(){
  "use strict";
  function byId(id){ return document.getElementById(id); }
  function ready(fn){ if(document.readyState!=="loading") fn(); else document.addEventListener("DOMContentLoaded", fn); }
  function mkBtn(id, text){
    const b=document.createElement("button"); b.type="button"; b.id=id; b.className="btn"; b.textContent=text; return b;
  }
  function ensureHiddenInputs(){
    // JSON file input
    if(!byId("ghd-main-import-json")){
      const inj = document.createElement("input");
      inj.type="file"; inj.id="ghd-main-import-json"; inj.accept="application/json,.json"; inj.style.display="none";
      inj.addEventListener("change", async (e)=>{
        const f = e.target.files && e.target.files[0]; if(!f) return;
        try{
          const txt = await f.text();
          const data = JSON.parse(txt);
          if(typeof saveData === "function"){ saveData(data); }
          if(typeof window.DATA !== "undefined"){ window.DATA = data; }
          try{ if(typeof renderMaster === "function") renderMaster(); }catch(_){}
          try{ if(typeof rebuildAllDropdowns === "function") rebuildAllDropdowns(); }catch(_){}
          try{ if(typeof recalcAll === "function") recalcAll(); }catch(_){}
          alert("Imported JSON.");
        }catch(err){ alert("Invalid JSON"); }
        e.target.value = "";
      });
      document.body.appendChild(inj);
    }
    // Excel/CSV file input
    if(!byId("ghd-main-import-xlsx")){
      const inx = document.createElement("input");
      inx.type="file"; inx.id="ghd-main-import-xlsx"; inx.accept=".xlsx,.xls,.csv"; inx.style.display="none";
      inx.addEventListener("change", async (e)=>{
        const f = e.target.files && e.target.files[0]; if(!f) return;
        try{
          if(typeof importFromFile === "function"){ await importFromFile(f); alert("Imported spreadsheet."); }
          else{ alert("Excel import not available in this build."); }
        }finally{ e.target.value=""; }
      });
      document.body.appendChild(inx);
    }
  }
  function wireButtons(scopeDoc, ids){
    const expJSON = scopeDoc.getElementById(ids.expJSON);
    if(expJSON && !expJSON._wired){
      expJSON._wired = true;
      expJSON.addEventListener("click", ()=>{
        try{
          const data = (typeof window.DATA!=="undefined") ? window.DATA : (typeof loadData==="function" ? loadData() : null);
          if(!data) throw new Error("no_data");
          const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
          const a=scopeDoc.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ghd_estimator_data.json'; a.click();
          URL.revokeObjectURL(a.href);
        }catch(err){ alert("Unable to export JSON."); }
      });
    }
    const impJSON = scopeDoc.getElementById(ids.impJSON);
    if(impJSON && !impJSON._wired){
      impJSON._wired = true;
      impJSON.addEventListener("click", ()=> byId("ghd-main-import-json")?.click() );
    }
    const expXLSX = scopeDoc.getElementById(ids.expXLSX);
    if(expXLSX && !expXLSX._wired){
      expXLSX._wired = true;
      expXLSX.addEventListener("click", ()=>{
        try{
          if(typeof exportXLSX === "function"){ exportXLSX(); return; }
          if(typeof masterToRows === "function"){
            const rows = masterToRows();
            const csv = [Object.keys(rows[0]).join(','), ...rows.map(r=>Object.values(r).map(v => String(v).includes(',')?`"${String(v).replace(/"/g,'""')}"`:String(v)).join(','))].join('\n');
            const blob = new Blob([csv], {type:'text/csv'});
            const a=scopeDoc.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pricing.csv'; a.click();
            URL.revokeObjectURL(a.href);
            alert("Excel export not available; exported CSV instead.");
          }else{ alert("Excel export not available in this build."); }
        }catch(err){ alert("Export failed."); }
      });
    }
    const impXLSX = scopeDoc.getElementById(ids.impXLSX);
    if(impXLSX && !impXLSX._wired){
      impXLSX._wired = true;
      impXLSX.addEventListener("click", ()=> byId("ghd-main-import-xlsx")?.click() );
    }
  }
  function buildToolbar(doc, id){
    if(doc.getElementById(id)) return doc.getElementById(id);
    const wrap = doc.createElement("span");
    wrap.id = id;
    wrap.style.display = "inline-flex";
    wrap.style.gap = "8px";
    wrap.style.marginInlineStart = "8px";
    wrap.style.flexWrap = "wrap";
    const b1 = mkBtn(id+"-expjson", "‚¨á Export JSON");
    const b2 = mkBtn(id+"-impjson", "‚¨Ü Import JSON");
    const b3 = mkBtn(id+"-expxlsx", "‚¨á Export Excel (.xlsx)");
    const b4 = mkBtn(id+"-impxlsx", "‚¨Ü Import Excel/CSV");
    wrap.appendChild(b1); wrap.appendChild(b2); wrap.appendChild(b3); wrap.appendChild(b4);
    // Wire
    wireButtons(doc, {expJSON:b1.id, impJSON:b2.id, expXLSX:b3.id, impXLSX:b4.id});
    return wrap;
  }
  function mountInMainProducts(){
    const addBtn = byId("a-add");
    if(!addBtn) return;
    if(byId("ghd-toolbar-main")) return;
    const bar = buildToolbar(document, "ghd-toolbar-main");
    addBtn.insertAdjacentElement("afterend", bar);
  }
  function mountInOwnerPanel(){
    const panel = byId("ownerPanel");
    if(!panel) return;
    const header = panel.querySelector("header > div") || panel.querySelector("header");
    if(!header) return;
    if(byId("ghd-toolbar-owner")) return;
    const bar = buildToolbar(document, "ghd-toolbar-owner");
    header.appendChild(bar);
  }
  function mountInEditPricelistView(){
    // Look for a section that is shown when "Edit Prices" is clicked (could be a modal/panel).
    const label = Array.from(document.querySelectorAll("h1,h2,h3,h4,.title,.card h1")).find(e => /main product.*price/i.test(e.textContent||""));
    const host = label ? (label.parentElement || document.body) : null;
    if(!host) return;
    if(byId("ghd-toolbar-mpp")) return;
    const bar = buildToolbar(document, "ghd-toolbar-mpp");
    host.insertBefore(bar, label.nextSibling);
  }
  function observeOpenings(){
    // When owner panel toggles open
    const toggler = byId("ownerToggle");
    if(toggler && !toggler._wired){
      toggler._wired = true;
      toggler.addEventListener("click", ()=> setTimeout(mountInOwnerPanel, 50), false);
    }
    // Generic observer: on added nodes, try the mounts
    const mo = new MutationObserver(()=>{
      mountInOwnerPanel();
      mountInEditPricelistView();
    });
    mo.observe(document.body, {childList:true, subtree:true});
  }
  ready(function(){
    ensureHiddenInputs();
    mountInMainProducts();
    mountInOwnerPanel(); // in case panel is visible by default
    mountInEditPricelistView();
    observeOpenings();
  });
})();
</script>


<script id="ghd-edit-pricelist-import-export">
(function(){
  "use strict";
  function ready(fn){ if(document.readyState!=="loading") fn(); else document.addEventListener("DOMContentLoaded", fn); }
  function byId(id){ return document.getElementById(id); }
  function mkBtn(id, text){ const b=document.createElement("button"); b.type="button"; b.id=id; b.className="btn"; b.textContent=text; return b; }

  function ensureHiddenInputs(){
    // JSON hidden input
    if(!byId("ghd-ep-import-json")){
      const inj = document.createElement("input");
      inj.type = "file"; inj.accept = "application/json,.json"; inj.id="ghd-ep-import-json"; inj.style.display="none";
      inj.addEventListener("change", async (e)=>{
        const f = e.target.files && e.target.files[0]; if(!f) return;
        try{
          const txt = await f.text();
          const data = JSON.parse(txt);
          if(typeof saveData === "function"){ saveData(data); }
          if(typeof window.DATA !== "undefined"){ window.DATA = data; }
          try{ byId("mpRefresh")?.click(); }catch(_){}
          alert("Imported JSON.");
        }catch(err){ alert("Invalid JSON"); }
        e.target.value = "";
      });
      document.body.appendChild(inj);
    }
    // Excel hidden input
    if(!byId("ghd-ep-import-xlsx")){
      const inx = document.createElement("input");
      inx.type = "file"; inx.accept = ".xlsx,.xls,.csv"; inx.id="ghd-ep-import-xlsx"; inx.style.display="none";
      inx.addEventListener("change", async (e)=>{
        const f = e.target.files && e.target.files[0]; if(!f) return;
        try{
          if(typeof importFromFile === "function"){
            await importFromFile(f);
            try{ byId("mpRefresh")?.click(); }catch(_){}
            alert("Imported spreadsheet.");
          }else{
            alert("Excel import not available in this build.");
          }
        }finally{ e.target.value = ""; }
      });
      document.body.appendChild(inx);
    }
  }

  function injectToolbar(){
    // Locate the sticky header containing the title text
    const headers = Array.from(document.querySelectorAll('div'))
      .filter(d => d.style && /position:\s*sticky/i.test(d.getAttribute("style")||""))
      .filter(d => /Editable Price Sheet/i.test(d.textContent||""));
    // Fallback: broader search for any element containing the title text with nearby buttons
    const container = headers[0] || Array.from(document.querySelectorAll("div,header"))
      .find(el => /Main Products\s*‚Äî?\s*Editable Price Sheet/i.test(el.textContent||""));
    if(!container) return;

    // The right-side button group is the next div with display:flex;gap
    const groups = Array.from(container.querySelectorAll("div"));
    const btnGroup = groups.find(g => /display:\s*flex/i.test(g.getAttribute("style")||"") && g.querySelector("#mpSave"));
    if(!btnGroup) return;
    if(document.getElementById("ghd-ep-toolbar")) return;

    const wrap = document.createElement("div");
    wrap.id = "ghd-ep-toolbar";
    wrap.style.display = "flex";
    wrap.style.gap = "8px";
    wrap.style.marginRight = "auto"; // keep it near title if needed

    const bExpJSON = mkBtn("ep-exp-json","‚¨á Export JSON");
    const bImpJSON = mkBtn("ep-imp-json","‚¨Ü Import JSON");
    const bExpXLSX = mkBtn("ep-exp-xlsx","‚¨á Export Excel (.xlsx)");
    const bImpXLSX = mkBtn("ep-imp-xlsx","‚¨Ü Import Excel/CSV");

    // Wire handlers
    bExpJSON.addEventListener("click", ()=>{
      try{
        const data = (typeof window.DATA!=="undefined") ? window.DATA : (typeof loadData==="function" ? loadData() : null);
        if(!data) throw new Error("no_data");
        const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ghd_estimator_data.json'; a.click();
        URL.revokeObjectURL(a.href);
      }catch(err){ alert("Unable to export JSON."); }
    });
    bImpJSON.addEventListener("click", ()=> byId("ghd-ep-import-json")?.click() );
    bExpXLSX.addEventListener("click", ()=>{
      try{
        if(typeof exportXLSX === "function"){ exportXLSX(); return; }
        if(typeof masterToRows === "function"){
          const rows = masterToRows();
          if(!rows || !rows.length){ alert("No data to export."); return; }
          const csv = [Object.keys(rows[0]).join(','), ...rows.map(r=>Object.values(r).map(v => String(v).includes(',')?`"${String(v).replace(/"/g,'""')}"`:String(v)).join(','))].join('\\n');
          const blob = new Blob([csv], {type:'text/csv'});
          const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pricing.csv'; a.click();
          URL.revokeObjectURL(a.href);
          alert("Excel export not available; exported CSV instead.");
        }else{
          alert("Excel export not available in this build.");
        }
      }catch(err){ alert("Export failed."); }
    });
    bImpXLSX.addEventListener("click", ()=> byId("ghd-ep-import-xlsx")?.click() );

    // Insert toolbar before the right-side buttons (so it appears near the title)
    container.insertBefore(wrap, btnGroup);
    wrap.appendChild(bExpJSON);
    wrap.appendChild(bImpJSON);
    wrap.appendChild(bExpXLSX);
    wrap.appendChild(bImpXLSX);
  }

  function init(){
    ensureHiddenInputs();
    injectToolbar();
    // Watch for the edit price sheet to open later
    const mo = new MutationObserver(()=> injectToolbar());
    mo.observe(document.body, {childList:true, subtree:true});
  }
  ready(init);
})();
</script>


<script id="ghd-admin-lock-pricing">
(function(){
  "use strict";
  // -------- CONFIG --------
  const LOCK_TEXT = "Pricing locked. Admin unlock required.";
  // Key derivation params
  const PBKDF2_ITERS = 200000;
  const PBKDF2_HASH = "SHA-256";
  const AES = "AES-GCM";
  const SALT_BYTES = 16;
  const NONCE_BYTES = 12;

  // State
  let unlocked = false;
  let lastKey = null;

  function ready(fn){ if(document.readyState!=="loading") fn(); else document.addEventListener("DOMContentLoaded", fn); }
  function byId(id){ return document.getElementById(id); }
  function qs(sel, root){ return (root||document).querySelector(sel); }
  function qsa(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }
  function h(tag, props){ const el=document.createElement(tag); Object.assign(el, props||{}); return el; }

  // ---------- Crypto helpers ----------
  async function deriveKey(pass, salt){
    const enc = new TextEncoder();
    const k0 = await crypto.subtle.importKey("raw", enc.encode(pass), {name:"PBKDF2"}, false, ["deriveKey"]);
    const key = await crypto.subtle.deriveKey(
      {name:"PBKDF2", hash:PBKDF2_HASH, salt, iterations:PBKDF2_ITERS},
      k0,
      {name:AES, length:256},
      false,
      ["encrypt","decrypt"]
    );
    return key;
  }
  async function decryptBlob(file, pass){
    const buf = await file.arrayBuffer();
    const bytes = new Uint8Array(buf);
    if(bytes.length < SALT_BYTES + NONCE_BYTES + 16) throw new Error("blob_too_small");
    const salt = bytes.slice(0, SALT_BYTES);
    const nonce = bytes.slice(SALT_BYTES, SALT_BYTES + NONCE_BYTES);
    const ct = bytes.slice(SALT_BYTES + NONCE_BYTES);
    const key = await deriveKey(pass, salt);
    const pt = await crypto.subtle.decrypt({name:AES, iv:nonce}, key, ct).catch(()=>{ throw new Error("bad_password"); });
    lastKey = key;
    const txt = new TextDecoder().decode(pt);
    return JSON.parse(txt);
  }

  // ---------- UI helpers ----------
  function toast(msg){
    try{ alert(msg); }catch(_){}
  }
  function makeUnlockUI(){
    // Add a small key button in the top bar (near Save/Refresh if visible)
    if(byId("ghd-unlock-pricing")) return;
    const target = byId("mpSave")?.parentElement || qs("#ownerPanel header div") || qs(".topbar") || document.body;
    const wrap = h("span", {id:"ghd-unlock-pricing"});
    wrap.style.marginLeft = "8px";
    const btn = h("button", {type:"button", textContent:"üîê Unlock Pricing"});
    btn.className = "btn";
    btn.addEventListener("click", startUnlockFlow);
    wrap.appendChild(btn);
    target && target.appendChild(wrap);

    // Hidden file input for encrypted pack
    if(!byId("ghd-enc-file")){
      const fi = h("input", {type:"file", id:"ghd-enc-file"});
      fi.accept = ".enc,.bin,.json,.dat,application/octet-stream";
      fi.style.display = "none";
      fi.addEventListener("change", async (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        try{
          const pass = sessionStorage.getItem("ghd_unlock_pass") || "";
          if(!pass){ toast("No passphrase. Click Unlock again."); return; }
          const data = await decryptBlob(f, pass);
          // Merge into app DATA (replace pricing parts only if present)
          if(typeof window.DATA === "object" && data && typeof data === "object"){
            // Prefer full replace
            window.DATA = Object.assign({}, window.DATA, data);
          }else{
            window.DATA = data;
          }
          // Attempt UI refreshes
          try{ byId("mpRefresh")?.click(); }catch(_){}
          try{ if(typeof renderMaster==="function") renderMaster(); }catch(_){}
          try{ if(typeof rebuildAllDropdowns==="function") rebuildAllDropdowns(); }catch(_){}
          try{ if(typeof recalcAll==="function") recalcAll(); }catch(_){}
          unlocked = true;
          sessionStorage.removeItem("ghd_unlock_pass");
          removeLocks();
          toast("Pricing loaded.");
        }catch(err){
          toast(err && err.message==="bad_password" ? "Incorrect passphrase." : "Failed to load encrypted pricing.");
        }finally{
          e.target.value = "";
        }
      });
      document.body.appendChild(fi);
    }
  }

  function startUnlockFlow(){
    const pass = prompt("Enter admin passphrase to load encrypted pricing:");
    if(!pass){ return; }
    sessionStorage.setItem("ghd_unlock_pass", pass);
    byId("ghd-enc-file").click();
  }

  // ---------- Locking behaviors ----------
  function hideOwnerPanelControls(){
    // Hide any export/import JSON/Excel UI unless unlocked
    const ids = ["ghd-toolbar-main","ghd-toolbar-owner","ghd-toolbar-mpp","ghd-ep-toolbar",
                 "ghd-btn-export-json","ghd-btn-import-json","ghd-btn-export-xlsx","ghd-btn-import-xlsx",
                 "ep-exp-json","ep-imp-json","ep-exp-xlsx","ep-imp-xlsx"];
    ids.forEach(id=>{
      const el = byId(id);
      if(el) el.style.display = unlocked ? "" : "none";
    });
  }
  function guardEditPriceSheet(){
    // Add a translucent overlay over the "Editable Price Sheet" header if locked
    const titleEl = Array.from(document.querySelectorAll("div,header,h1,h2,h3"))
      .find(el => /Main Products\s*(‚Äî|--)?\s*Editable Price Sheet/i.test(el.textContent||""));
    if(!titleEl) return;
    let veil = byId("ghd-price-lock-veil");
    if(!unlocked){
      if(!veil){
        veil = h("div", {id:"ghd-price-lock-veil"});
        Object.assign(veil.style, {
          position: "sticky",
          top: "0",
          left: "0",
          right: "0",
          padding: "8px 12px",
          background: "rgba(255,255,255,0.9)",
          border: "1px solid #eee",
          color: "#111",
          zIndex: "1000",
          marginBottom: "8px",
          borderRadius: "8px"
        });
        veil.textContent = LOCK_TEXT + "  (Click üîê Unlock Pricing to proceed)";
        titleEl.parentNode.insertBefore(veil, titleEl.nextSibling);
      }
    }else if(veil){
      veil.remove();
    }
  }
  function interceptOwnerPanel(){
    const btn = byId("ownerToggle") || byId("mpFabBtn");
    if(!btn || btn._ghdLockWired) return;
    btn._ghdLockWired = true;
    btn.addEventListener("click", (e)=>{
      if(!unlocked){
        e.stopPropagation(); e.preventDefault();
        toast(LOCK_TEXT);
        makeUnlockUI();
      }
    }, true);
  }
  function removeLocks(){
    hideOwnerPanelControls();
    guardEditPriceSheet();
  }
  function applyLocks(){
    if(unlocked) return;
    hideOwnerPanelControls();
    guardEditPriceSheet();
    interceptOwnerPanel();
  }

  function observe(){
    const mo = new MutationObserver(()=>{
      applyLocks();
    });
    mo.observe(document.body, {childList:true, subtree:true});
  }

  function init(){
    makeUnlockUI();
    applyLocks();
    observe();
    // Shortcut
    window.addEventListener("keydown", (e)=>{
      if((e.ctrlKey||e.metaKey) && e.shiftKey && e.key.toLowerCase()==="l"){
        e.preventDefault();
        makeUnlockUI();
        startUnlockFlow();
      }
    }, false);
  }

  ready(init);
})();
</script>








<script id="ghd-viol-all-products">
(function(){
  const ROW_CACHE = new WeakMap(); // tr -> {msgs:[], lastViol:ts}
  const CLEAR_GRACE_MS = 800;

  function norm(s){ return String(s||"").toLowerCase().trim(); }
  function toCm(v, unit){
    var x = parseFloat(v); if (!isFinite(x)) return null;
    unit = norm(unit);
    if (unit==="cm") return x;
    if (unit==="mm") return x/10;
    if (unit==="m" || unit==="meter" || unit==="metre" || unit==="meters" || unit==="metres") return x*100;
    if (unit==="in" || unit==="inch" || unit==="inches") return x*2.54;
    if (unit==="ft" || unit==="foot" || unit==="feet") return x*30.48;
    return null;
  }

  function q(root, sel){ return (root||document).querySelector(sel); }
  function qa(root, sel){ return Array.from((root||document).querySelectorAll(sel)); }

  function closestUnitFor(input, tr){
    var units = qa(tr, 'select.unit, select[name*="unit" i]');
    if (!units.length) return null;
    if (!input) return units[0];
    var best = units[0], bestDist = 1e9;
    units.forEach(function(sel){
      var a = sel.getBoundingClientRect ? sel.getBoundingClientRect() : {x:0};
      var b = input.getBoundingClientRect ? input.getBoundingClientRect() : {x:0};
      var dx = Math.abs((a.x||0) - (b.x||0));
      if (dx < bestDist){ bestDist = dx; best = sel; }
    });
    return best;
  }
  function getTypeText(tr){
    var sel = q(tr,'select.type');
    if (sel){
      var txt = sel.value || (sel.options[sel.selectedIndex] && sel.options[sel.selectedIndex].textContent) || "";
      return txt;
    }
    return "";
  }
  function getProductText(tr){
    var sel = q(tr,'select[name*="product"], select[name*="target"], select.target, select.product');
    if (sel){
      var opt = sel.options[sel.selectedIndex];
      return (opt && (opt.textContent||opt.innerText)) || '';
    }
    var td = tr.querySelector('td, th');
    return td ? td.textContent : '';
  }
  function findW(tr){
    return q(tr,'.width') ||
           q(tr,'input[name*="width" i]') ||
           q(tr,'input[id*="width" i]') ||
           q(tr,'input[name*="w" i]') ||
           q(tr,'input[id*="w" i]') ||
           q(tr,'input[aria-label*="width" i]') ||
           q(tr,'input[placeholder*="width" i]') ||
           q(tr,'input[type="number"]') ||
           q(tr,'input[type="text"]');
  }
  function findH(tr){
    return q(tr,'.height') ||
           q(tr,'input[name*="height" i]') ||
           q(tr,'input[id*="height" i]') ||
           q(tr,'input[name*="h" i]') ||
           q(tr,'input[id*="h" i]') ||
           q(tr,'input[aria-label*="height" i]') ||
           q(tr,'input[placeholder*="height" i]') ||
           (function(){ var nums = tr.querySelectorAll('input[type="number"], input[type="text"]'); return nums.length>1 ? nums[1] : null; })();
  }

  function flagsFrom(tr){
    var tType = norm(getTypeText(tr));
    var tProd = norm(getProductText(tr));
    var oneAbbr = /(\bmesh\s*o\b|\(\s*o\s*\)|\bo\b(?![a-z]))/.test(tType);
    var twoAbbr = /(\bmesh\s*t\b|\(\s*t\s*\)|\bt\b(?![a-z]))/.test(tType);
    return {
      isPleated: /pleated/.test(tProd) || /pleated/.test(tType),
      isSecurity: /security/.test(tProd) || /security/.test(tType),
      isOne: /(one\s*way|1\s*[- ]?\s*way)/.test(tType) || oneAbbr,
      isTwo: /(two\s*way|2\s*[- ]?\s*way)/.test(tType) || twoAbbr
    };
  }

  function optionsCell(tr){
    var td = tr.querySelector('.col-opt');
    if (!td){
      var table = tr.closest('table'), head = table && (table.tHead || table.querySelector('thead'));
      if (head){
        var ths = qa(head,'th');
        var idx = ths.findIndex(function(th){ return norm(th.textContent).includes('options'); });
        if (idx>=0 && tr.children[idx]) td = tr.children[idx];
      }
    }
    return td || tr.lastElementChild;
  }

  // === Shadow host creation ===
  function ensureHost(tr){
    var td = optionsCell(tr); if (!td) return null;
    var host = td.querySelector('.mp-viol-host');
    if (!host){
      host = document.createElement('div');
      host.className = 'mp-viol-host';
      td.appendChild(host);
      // Attach shadow root so outer innerHTML rewrites won't affect our notes
      try {
        if (!host.shadowRoot){ host.attachShadow({mode:'open'}); }
      } catch(e){ /* older browsers: ignore */ }
    } else {
      try { if (!host.shadowRoot){ host.attachShadow({mode:'open'}); } } catch(e){}
    }
    return host;
  }

  function writeNotes(tr, msgs){
    var host = ensureHost(tr); if (!host) return;
    var target = host.shadowRoot || host; // prefer shadow
    var html = msgs.length ? '<div class="mp-viol">'+msgs.map(function(m){return '‚Ä¢ '+m;}).join('<br>')+'</div>' : '';
    if (target.innerHTML !== html) target.innerHTML = html;
  }

  function computeMsgs(tr){
    var F = flagsFrom(tr), msgs = [];
    if (!(F.isPleated || F.isSecurity)) return [];
    var wIn = findW(tr), hIn = findH(tr);
    var wcm = toCm(wIn && wIn.value, closestUnitFor(wIn,tr)&&closestUnitFor(wIn,tr).value);
    var hcm = toCm(hIn && hIn.value, closestUnitFor(hIn,tr)&&closestUnitFor(hIn,tr).value);

    if (F.isOne && wcm!=null && wcm>300) msgs.push('To recommend 2-way if site permits (width > 300 cm).');
    if (F.isTwo && wcm!=null && wcm>600) msgs.push('Exceeds 600 cm width.');
    if (F.isPleated && hcm!=null && hcm>304.8) msgs.push('Height exceeded 304.8 cm.');

    return msgs;
  }

  function tickRow(tr){
    var msgs = computeMsgs(tr);
    var entry = ROW_CACHE.get(tr) || {msgs:[], lastViol:0};
    if (msgs.length){
      entry.msgs = msgs;
      entry.lastViol = Date.now();
      writeNotes(tr, entry.msgs);
    } else {
      if (Date.now() - entry.lastViol > CLEAR_GRACE_MS){
        entry.msgs = [];
        writeNotes(tr, []);
      } else {
        // still within grace -> keep showing last violation
        writeNotes(tr, entry.msgs);
      }
    }
    ROW_CACHE.set(tr, entry);
  }

  function updateAll(){
    var table = document.getElementById('a-table'); if (!table) return;
    qa(table,'tbody tr').forEach(tickRow);
  }

  // Hook helper (gray notes) so our notes render after it executes
  function hookHelper(){
    var w = window, fn = w.checkNotes;
    if (typeof fn === 'function' && !fn.__mp_hooked){
      var wrapped = function(){
        try { return fn.apply(this, arguments); }
        finally { setTimeout(updateAll, 0); }
      };
      wrapped.__mp_hooked = true;
      try { w.checkNotes = wrapped; } catch(e){}
    }
  }

  function boot(){
    updateAll();
    document.addEventListener('input', function(e){ if (e.target.closest('#a-table')) setTimeout(updateAll, 80); }, true);
    document.addEventListener('change', function(e){ if (e.target.closest('#a-table')) setTimeout(updateAll, 80); }, true);
    var table = document.getElementById('a-table');
    if (table){
      new MutationObserver(function(){ setTimeout(updateAll, 80); }).observe(table, {childList:true, subtree:true, characterData:true});
    }
    // Frequent refresh so even aggressive re-renders won't hide notes
    setInterval(function(){ hookHelper(); updateAll(); }, 120);
    hookHelper();
  }

  if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', boot); } else { boot(); }
})();
</script>

<script id="ghd-viol-all-products">
(function(){
  const ROW_CACHE = new WeakMap();
  const CLEAR_GRACE_MS = 800;
  function norm(s){ return String(s||"").toLowerCase().trim(); }
  function toCm(v, unit){
    var x = parseFloat(v); if (!isFinite(x)) return null;
    unit = norm(unit);
    if (unit==="cm") return x;
    if (unit==="mm") return x/10;
    if (unit==="m" || unit==="meter" || unit==="metre" || unit==="meters" || unit==="metres") return x*100;
    if (unit==="in" || unit==="inch" || unit==="inches") return x*2.54;
    if (unit==="ft" || unit==="foot" || unit==="feet") return x*30.48;
    return null;
  }
  function qa(root, sel){ return Array.from((root||document).querySelectorAll(sel)); }
  function q(root, sel){ return (root||document).querySelector(sel); }
  function closestUnitFor(input, tr){
    var units = qa(tr, 'select.unit, select[name*="unit" i]');
    if (!units.length) return null;
    if (!input) return units[0];
    var best = units[0], bestDist = 1e9;
    units.forEach(function(sel){
      var a = sel.getBoundingClientRect ? sel.getBoundingClientRect() : {x:0};
      var b = input.getBoundingClientRect ? input.getBoundingClientRect() : {x:0};
      var dx = Math.abs((a.x||0) - (b.x||0));
      if (dx < bestDist){ bestDist = dx; best = sel; }
    });
    return best;
  }
  function getTypeText(tr){
    var sel = q(tr,'select.type');
    if (sel){
      var txt = sel.value || (sel.options[sel.selectedIndex] && sel.options[sel.selectedIndex].textContent) || "";
      return txt;
    }
    return "";
  }
  function getProductText(tr){
    var sel = q(tr,'select[name*="product"], select[name*="target"], select.target, select.product');
    if (sel){
      var opt = sel.options[sel.selectedIndex];
      return (opt && (opt.textContent||opt.innerText)) || '';
    }
    var td = tr.querySelector('td, th');
    return td ? td.textContent : '';
  }
  function findW(tr){
    return q(tr,'.width') ||
           q(tr,'input[name*="width" i]') ||
           q(tr,'input[id*="width" i]') ||
           q(tr,'input[name*="w" i]') ||
           q(tr,'input[id*="w" i]') ||
           q(tr,'input[aria-label*="width" i]') ||
           q(tr,'input[placeholder*="width" i]') ||
           q(tr,'input[type="number"]') ||
           q(tr,'input[type="text"]');
  }
  function findH(tr){
    return q(tr,'.height') ||
           q(tr,'input[name*="height" i]') ||
           q(tr,'input[id*="height" i]') ||
           q(tr,'input[name*="h" i]') ||
           q(tr,'input[id*="h" i]') ||
           q(tr,'input[aria-label*="height" i]') ||
           q(tr,'input[placeholder*="height" i]') ||
           (function(){ var nums = tr.querySelectorAll('input[type="number"], input[type="text"]'); return nums.length>1 ? nums[1] : null; })();
  }
  function flagsFrom(tr){
    var tType = (getTypeText(tr)||'').toLowerCase();
    var tProd = (getProductText(tr)||'').toLowerCase();
    var oneAbbr = /(\bmesh\s*o\b|\(\s*o\s*\)|\bo\b(?![a-z]))/.test(tType);
    var twoAbbr = /(\bmesh\s*t\b|\(\s*t\s*\)|\bt\b(?![a-z]))/.test(tType);
    return {
      isPleated: /pleated/.test(tProd) || /pleated/.test(tType),
      isSecurity: /security/.test(tProd) || /security/.test(tType),
      isOne: /(one\s*way|1\s*[- ]?\s*way)/.test(tType) || oneAbbr,
      isTwo: /(two\s*way|2\s*[- ]?\s*way)/.test(tType) || twoAbbr
    };
  }
  function optionsCell(tr){
    var td = tr.querySelector('.col-opt');
    if (!td){
      var table = tr.closest('table'), head = table && (table.tHead || table.querySelector('thead'));
      if (head){
        var ths = Array.from(head.querySelectorAll('th'));
        var idx = ths.findIndex(function(th){ return (th.textContent||'').toLowerCase().includes('options'); });
        if (idx>=0 && tr.children[idx]) td = tr.children[idx];
      }
    }
    return td || tr.lastElementChild;
  }
  function ensureHost(tr){
    var td = optionsCell(tr); if (!td) return null;
    var host = td.querySelector('.mp-viol-host');
    if (!host){
      host = document.createElement('div');
      host.className = 'mp-viol-host';
      td.appendChild(host);
      try { if (!host.shadowRoot) host.attachShadow({mode:'open'}); } catch(e){}
    } else {
      try { if (!host.shadowRoot) host.attachShadow({mode:'open'}); } catch(e){}
    }
    return host;
  }
  function writeNotes(tr, msgs){
    var host = ensureHost(tr); if (!host) return;
    var target = host.shadowRoot || host;
    var style = '<style>.mp-viol{color:#d00 !important;font-weight:600 !important;font-size:0.95em;line-height:1.2}</style>';
    var html = msgs.length ? style + '<div class="mp-viol">'+msgs.map(function(m){return '‚Ä¢ '+m;}).join('<br>')+'</div>' : '';
    if (target.innerHTML !== html) target.innerHTML = html;
  }
  function computeMsgs(tr){
    var F = flagsFrom(tr), msgs = [];
    if (!(F.isPleated || F.isSecurity)) return [];
    var wIn = findW(tr), hIn = findH(tr);
    var wcm = toCm(wIn && wIn.value, (closestUnitFor(wIn,tr)||{}).value);
    var hcm = toCm(hIn && hIn.value, (closestUnitFor(hIn,tr)||{}).value);
    if (F.isOne && wcm!=null && wcm>300) msgs.push('To recommend 2-way if site permits (width > 300 cm).');
    if (F.isTwo && wcm!=null && wcm>600) msgs.push('Exceeds 600 cm width.');
    if (F.isPleated && hcm!=null && hcm>304.8) msgs.push('Height exceeded 304.8 cm.');
    return msgs;
  }
  function tickRow(tr){
    var msgs = computeMsgs(tr);
    var entry = ROW_CACHE.get(tr) || {msgs:[], lastViol:0};
    if (msgs.length){
      entry.msgs = msgs; entry.lastViol = Date.now();
      writeNotes(tr, entry.msgs);
    } else {
      if (Date.now() - entry.lastViol > CLEAR_GRACE_MS){
        entry.msgs = []; writeNotes(tr, []);
      } else {
        writeNotes(tr, entry.msgs);
      }
    }
    ROW_CACHE.set(tr, entry);
  }
  function updateAll(){
    var table = document.getElementById('a-table'); if (!table) return;
    Array.from(table.querySelectorAll('tbody tr')).forEach(tickRow);
  }
  function hookHelper(){
    var w = window, fn = w.checkNotes;
    if (typeof fn === 'function' && !fn.__mp_hooked){
      var wrapped = function(){ try { return fn.apply(this, arguments); } finally { setTimeout(updateAll, 0); } };
      wrapped.__mp_hooked = true;
      try { w.checkNotes = wrapped; } catch(e){}
    }
  }
  function boot(){
    updateAll(); hookHelper();
    document.addEventListener('input', function(e){ if (e.target.closest('#a-table')) setTimeout(updateAll, 80); }, true);
    document.addEventListener('change', function(e){ if (e.target.closest('#a-table')) setTimeout(updateAll, 80); }, true);
    var table = document.getElementById('a-table');
    if (table){
      new MutationObserver(function(){ setTimeout(updateAll, 80); }).observe(table, {childList:true, subtree:true, characterData:true});
    }
    setInterval(function(){ hookHelper(); updateAll(); }, 150);
  }
  if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', boot); } else { boot(); }
})();
</script>
</body></html>`</script>


<script>
document.getElementById('exportXLSX')?.addEventListener('click', ()=>{
  try{
    // Ensure latest edits are reflected by re-reading current master rows first
    const table = document.getElementById('masterTable');
    if(table){
      const trs = table.querySelectorAll('tbody tr');
      const newMaster = [];
      trs.forEach(tr=>{
        const get = sel => tr.querySelector(sel);
        const code = get('[data-k="code"]')?.value?.trim() || '';
        const base = +(get('[data-k="base"]')?.value || 0);
        const show = {
          combi:   !!get('[data-k="combi"]')?.checked,
          roller:  !!get('[data-k="roller"]')?.checked,
          pvc:     !!get('[data-k="pvc"]')?.checked,
          public:  !!get('[data-k="public"]')?.checked,
          synergy: !!get('[data-k="synergy"]')?.checked,
          shangrila: !!get('[data-k="shangrila"]')?.checked,
          venetian:  !!get('[data-k="venetian"]')?.checked,
          realwood:  !!get('[data-k="realwood"]')?.checked,
          curtains:  !!get('[data-k="curtains"]')?.checked,
        };
        if(code){ newMaster.push({code, base, show}); }
      });
      if(newMaster.length){ DATA.master = newMaster; saveData(DATA); }
    }

    // Build an Excel-friendly HTML table including Final (√ó2 + 20)
    let out = '<table border="1"><thead><tr>' +
              '<th>Code</th><th>Base ‚Ç±/ft¬≤</th><th>Final (√ó2 + 20)</th>' +
              '</tr></thead><tbody>';
    for(const row of DATA.master){
      const base = +row.base || 0;
      const final = finalFromBase(base); // base*2 + 20
      out += `<tr><td>${row.code}</td><td>${base}</td><td>${Math.round(final)}</td></tr>`;
    }
    out += '</tbody></table>';
    ghdDownloadExcel('Master_Codes_with_Final', out);
  }catch(err){
    alert('Export failed: ' + (err?.message||err));
  }
});
</script>


<script>
(function(){
  const btn = document.getElementById('exportFinal');
  if(!btn) return;
  btn.addEventListener('click', ()=>{
    const tbody = document.getElementById('masterTable')?.querySelector('tbody');
    if(!tbody){ alert('Master table not found'); return; }
    let out = '<table border="1"><thead><tr><th>Code</th><th>Base ‚Ç±/ft¬≤</th><th>Final (√ó2 + 20)</th></tr></thead><tbody>';
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      const code = tr.querySelector('[data-k="code"]')?.value?.trim() || '';
      const base = +(tr.querySelector('[data-k="base"]')?.value || 0);
      const final = (typeof finalFromBase==='function') ? finalFromBase(base) : (base*2 + 20);
      if(code){ out += `<tr><td>${code}</td><td>${base}</td><td>${Math.round(final)}</td></tr>`; }
    });
    out += '</tbody></table>';
    ghdDownloadExcel('Master_Codes_with_Final', out);
  });
})();
</script>


<script>
function ghdDownloadCSV(filename, rows){
  const lines = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(','));
  const blob = new Blob([lines.join('\r\n')], {type: 'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename.endsWith('.csv') ? filename : (filename + '.csv');
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
}
</script>


<script>
// GHD Quote v3 ‚Äî clean, hidden, robust
window.GHD = (function(){
  function peso(n){ return '‚Ç±'+(Math.round(+n||0)).toLocaleString('en-PH'); }
  function todayISO(){ const d=new Date(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${mm}-${dd}`; }
  function txt(el){ return (el && (el.value!=null? el.value: el.textContent)||'').toString().trim(); }
  function num(s){ return parseFloat(String(s||'').replace(/[^0-9.\-]/g,''))||0; }
  function pick(opt){ return opt ? (opt.selectedOptions?.[0]?.text || opt.value || '') : ''; }

  // Quote number auto-increment; starts Grayhome002
  function nextQuoteNo(){
    let seq = parseInt(localStorage.getItem('ghd_quote_seq')||'2',10);
    const no = 'Grayhome' + String(seq).padStart(3,'0');
    localStorage.setItem('ghd_quote_seq', String(seq+1));
    return no;
  }

  const MAP = {
    all:{panel:'#panel-all',table:'#a-table',cust:'#a-cust'},
    combi:{panel:'#panel-combi',table:'#c-table',cust:'#c-cust'},
    roller:{panel:'#panel-roller',table:'#r-table',cust:'#r-cust'},
    pvc:{panel:'#panel-pvc',table:'#p-table',cust:'#p-cust'},
    synergy:{panel:'#panel-synergy',table:'#s-table',cust:'#s-cust'},
    shangrila:{panel:'#panel-shangrila',table:'#g-table',cust:'#g-cust'},
    venetian:{panel:'#panel-venetian',table:'#v-table',cust:'#v-cust'},
    realwood:{panel:'#panel-realwood',table:'#rw-table',cust:'#rw-cust'},
    curtains:{panel:'#panel-curtains',table:'#ct-table',cust:'#ct-cust'}
  };

  function collect(tab){
    const cfg = MAP[tab]; if(!cfg) return {title:'',headers:[],rows:[],totals:{}};
    const panel = document.querySelector(cfg.panel);
    const table = panel && panel.querySelector(cfg.table);
    if(!table) return {title:'',headers:[],rows:[],totals:{}};
    const tbody = table.querySelector('tbody');
    const trs = Array.from(tbody?tbody.querySelectorAll('tr'):[]);

    function base(tr){
      const codeSel = tr.querySelector('select.code');
      const exact = tr.querySelector('.codeExact');
      const w = tr.querySelector('.width'); const h = tr.querySelector('.height');
      const units = tr.querySelectorAll('.unit');
      const size = (w&&h&&units.length>=2)? `${txt(w)} ${txt(units[0])} √ó ${txt(h)} ${txt(units[1])}` : '';
      return {
        code: codeSel? codeSel.value:'',
        exact: txt(exact),
        size,
        sqft: txt(tr.querySelector('.sqft')),
        amount: num(txt(tr.querySelector('.line'))),
        tr
      };
    }

    const headersAll = {
      all:['#','Type','Code','Exact Code','Area of House','Size (W√óH)','Sq Ft','Options','Amount'],
      combi:['#','Code','Exact Code','Size (W√óH)','Sq Ft','Options','Amount'],
      roller:['#','Code','Exact Code','Size (W√óH)','Sq Ft','Options','Amount'],
      pvc:['#','Code','Exact Code','Size (W√óH)','Sq Ft','Amount'],
      synergy:['#','Code','Exact Code','Size (W√óH)','Sq Ft','Amount'],
      shangrila:['#','Code','Exact Code','Size (W√óH)','Sq Ft','Amount'],
      venetian:['#','Code','Exact Code','Size (W√óH)','Sq Ft','Amount'],
      realwood:['#','Code','Exact Code','Size (W√óH)','Sq Ft','Amount'],
      curtains:['#','Code','Exact Code','Size (W√óH)','Sq Ft','Options','Amount']
    };
    const titleMap = {all:'All Products', combi:'Combi Blinds', roller:'Roller Blinds', pvc:'PVC Vertical & Other',
                      synergy:'Synergy Combi Vertical', shangrila:'Shangrila Blinds', venetian:'Venetian Blinds',
                      realwood:'Realwood Blinds', curtains:'Curtains - Fabric Registry'};
    let rows=[], sub=0, headers=headersAll[tab];
    trs.forEach((tr,i)=>{
      const b = base(tr); let opts='';
      if(tab==='all'){
        const type = tr.querySelector('.type')?.value || '';
        const room = txt(tr.querySelector('.room'));
        if(type==='Combi'){ if(tr.querySelector('.opt-combi .magic')?.checked) opts='Magic +20'; }
        else if(type==='Roller'){
          const chain=pick(tr.querySelector('.opt-roller .chain')); const bt=pick(tr.querySelector('.opt-roller .btube')); const mg = tr.querySelector('.opt-roller .magic')?.checked?'Magic +20':'';
          opts=[chain,bt,mg].filter(Boolean).join(' ‚Ä¢ ');
        } else if(type==='Curtains - Fabric Registry'){
          const finish=pick(tr.querySelector('.opt-curtains .finish')); if(finish) opts='Finish: '+finish;
        } else if(type==='Polycarbonate'){
          const opening=pick(tr.querySelector('.opening')); if(opening) opts='Opening: '+opening;
        }
        sub += b.amount;
        rows.push([i+1, type, b.code, b.exact, room, b.size, b.sqft, opts, (Math.round(b.amount)).toLocaleString('en-PH')]);
      } else {
        if(tab==='roller'){
          const chain=pick(tr.querySelector('.chain')); const bt=pick(tr.querySelector('.btube')); const mg=tr.querySelector('.magic')?.checked?'Magic +20':'';
          opts=[chain,bt,mg].filter(Boolean).join(' ‚Ä¢ ');
          rows.push([i+1, b.code, b.exact, b.size, b.sqft, opts, (Math.round(b.amount)).toLocaleString('en-PH')]);
        } else if(tab==='combi'){
          opts=tr.querySelector('.magic')?.checked?'Magic +20':'';
          rows.push([i+1, b.code, b.exact, b.size, b.sqft, opts, (Math.round(b.amount)).toLocaleString('en-PH')]);
        } else if(tab==='curtains'){
          const finish=pick(tr.querySelector('.finish')); opts=finish?('Finish: '+finish):'';
          rows.push([i+1, b.code, b.exact, b.size, b.sqft, opts, (Math.round(b.amount)).toLocaleString('en-PH')]);
        } else {
          rows.push([i+1, b.code, b.exact, b.size, b.sqft, (Math.round(b.amount)).toLocaleString('en-PH')]);
        }
        sub += b.amount;
      }
    });
    let totals={};
    if(tab==='all'){
      const vatPct = +(document.getElementById('a-vat')?.value||0);
      const discPct = +(document.getElementById('a-disc')?.value||0);
      const discAmt = sub*(discPct/100);
      const afterDisc = sub - discAmt;
      const vatAmt = afterDisc*(vatPct/100);
      const grand = afterDisc + vatAmt;
      totals = {sub, discPct, discAmt, vatPct, vatAmt, grand};
    } else {
      totals = {grand: sub};
    }
    return { title:titleMap[tab], headers, rows, totals, customer: txt(panel.querySelector(cfg.cust)) || '‚Äî' };
  }

  function buildPrintHTML(tab, qno){
    const data = collect(tab);
    const head = data.headers.map(h=>`<th>${h}</th>`).join('');
    const body = data.rows.map(r=>`<tr>${r.map((c,i)=>`<td${i===0?' class="idx"':''}>${c}</td>`).join('')}</tr>`).join('') || `<tr><td colspan="${data.headers.length}">No items</td></tr>`;
    const totals = (function(){
      const t=data.totals||{};
      if(tab==='all'){
        return `<table class="tot"><tr><th>Subtotal</th><td>${peso(t.sub||0)}</td></tr>${t.discPct?`<tr><th>Discount (${t.discPct}%)</th><td>- ${peso(t.discAmt||0)}</td></tr>`:''}${t.vatPct?`<tr><th>VAT (${t.vatPct}%)</th><td>${peso(t.vatAmt||0)}</td></tr>`:''}<tr class="grand"><th>Grand Total</th><td>${peso(t.grand||0)}</td></tr></table>`;
      }
      return `<table class="tot"><tr class="grand"><th>Grand Total</th><td>${peso(t.grand||0)}</td></tr></table>`;
    })();

    return `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Quotation ${qno}</title>
    <style>
      body{font-family:Arial,Helvetica,sans-serif;color:#111;margin:20px}
      .top{display:flex;justify-content:space-between;gap:20px}
      .brand h2{margin:0 0 6px}
      .brand .meta{font-size:12px;color:#555;line-height:1.5}
      .doc h3{margin:0}
      .doc table{font-size:12px}
      .doc th{padding-right:8px;text-align:left;color:#444}
      table.items{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px}
      table.items th,table.items td{border:1px solid #ddd;padding:6px 8px;text-align:left}
      table.items th{background:#f3f4f6}
      td.idx{text-align:center;width:36px}
      .totals{display:flex;justify-content:flex-end;margin-top:14px}
      .totals .tot{border-collapse:collapse;min-width:280px}
      .tot .grand th,.tot .grand td{font-weight:700}
      .sign{display:flex;gap:24px;margin-top:22px}
      .sign .line{margin-top:36px;border-top:1px solid #aaa;padding-top:4px;text-align:center;font-size:12px}
      @media print{ .noprint{display:none} body{margin:0} }
    </style>
<style>
  #a-table td.sqft, #a-table td.line {
    text-align: right;
    white-space: nowrap;
    min-width: 80px;
  }
</style>


<style id="ghd-toolbar-visibility-fix">
@media screen {
  #ghd-screen-toolbar { display: flex !important; }
  #ghd-footer-notes-toolbar { display: block !important; }
  #ghd-screen-toolbar label,
  #ghd-footer-notes-toolbar label { font-size: 14px !important; }
  #projectLocationInput,
  #ghdFooterNotesInput { font-size: 14px !important; line-height: 1.4 !important; }
}
</style>

<style id="ghd-print-row-keep">
@media print {
  /* Keep rows and cells intact across page breaks */
  #ghd-print-body table,
  #ghd-print-body thead,
  #ghd-print-body tbody,
  #ghd-print-body tr,
  #ghd-print-body th,
  #ghd-print-body td {
    break-inside: avoid !important;
    page-break-inside: avoid !important;
  }

  /* Force solid borders so lines are complete */
  #ghd-print-body table {
    width: 100% !important;
    border-collapse: collapse !important;
    table-layout: fixed !important;
  }
  #ghd-print-body th, #ghd-print-body td {
    border: 1px solid #000 !important;
  }

  /* Ensure header repeats and has clear separation */
  #ghd-print-body thead { display: table-header-group !important; }

  /* Give the print body enough top margin to clear any fixed header */
  #ghd-print-body { margin-top: 160px !important; }

  /* Tweak paddings for clearer grid lines */
  #ghd-print-body th, #ghd-print-body td {
    padding-top: 6px !important;
    padding-bottom: 6px !important;
    line-height: 1.2 !important;
  }
}
</style>

<style id="ghd-print-solid-gridlines">
@media print {
  /* Use separate model to avoid collapsed-border gaps in some PDF printers */
  #ghd-print-body table {
    border-collapse: separate !important;
    border-spacing: 0 !important;
    table-layout: fixed !important;
    width: 100% !important;
  }

  /* Draw a single continuous grid */
  #ghd-print-body th, #ghd-print-body td {
    border: none !important;
    border-right: 1px solid #000 !important;
    border-bottom: 1px solid #000 !important;
    empty-cells: show !important;
    padding: 6px 8px !important;
    line-height: 1.2 !important;
    background-clip: padding-box !important; /* prevents antialias gaps */
  }

  /* Top and left outer borders */
  #ghd-print-body table thead th {
    border-top: 1px solid #000 !important;
  }
  #ghd-print-body table tr > *:first-child {
    border-left: 1px solid #000 !important;
  }

  /* Ensure footer totals row keeps its border top thick */
  #ghd-totals-foot tr td {
    border-top: 2px solid #000 !important;
  }
}
</style>

<style id="ghd-print-header-borders">
@media print {
  /* Ensure column header (names) have full box borders */
  #ghd-print-body thead th {
    border: 1px solid #000 !important;           /* all sides */
    background-clip: padding-box !important;
  }
  #ghd-print-body thead th:first-child {
    border-left: 1px solid #000 !important;
  }
  #ghd-print-body thead th:last-child {
    border-right: 1px solid #000 !important;
  }

  /* Make sure first body row has a solid top line under the header */
  #ghd-print-body tbody tr:first-child td {
    border-top: 1px solid #000 !important;
  }

  /* Redundant guard to keep the last column line solid across rows */
  #ghd-print-body table tr > *:last-child {
    border-right: 1px solid #000 !important;
  }
}
</style>

<style id="ghd-print-header-strong-borders">
@media print {
  #ghd-print-body table,
  #ghd-print-body th,
  #ghd-print-body td {
    border: 1px solid #000 !important;
    border-collapse: collapse !important;
  }

  #ghd-print-body table {
    border-collapse: collapse !important;
    border-spacing: 0 !important;
    table-layout: fixed !important;
    width: 100% !important;
  }

  #ghd-print-body thead th {
    border: 1px solid #000 !important;
    background-color: #fff !important;
    -webkit-print-color-adjust: exact;
  }

  #ghd-print-body tr th,
  #ghd-print-body tr td {
    padding: 6px 8px !important;
    line-height: 1.2 !important;
  }

  /* Ensure full box on thead row */
  #ghd-print-body thead tr {
    border-top: 2px solid #000 !important;
    border-bottom: 2px solid #000 !important;
  }

  /* Ensure last row of body has full bottom border */
  #ghd-print-body tbody tr:last-child td {
    border-bottom: 1px solid #000 !important;
  }
}
</style>

<style id="ghd-print-header-ultimate-borders">
@media print {
  #ghd-print-body table {
    border-collapse: collapse !important;
    border-spacing: 0 !important;
    table-layout: fixed !important;
    width: 100% !important;
  }
  #ghd-print-body th, #ghd-print-body td {
    border: 1px solid #000 !important;
    padding: 6px 8px !important;
    line-height: 1.2 !important;
  }
  #ghd-print-body thead th {
    border: 1px solid #000 !important;
    background-color: #fff !important;
    font-weight: bold !important;
    -webkit-print-color-adjust: exact;
  }
  #ghd-print-body thead tr {
    border-top: 2px solid #000 !important;
    border-bottom: 2px solid #000 !important;
  }
  /* Force explicit borders for each header cell to ensure visibility */
  #ghd-print-body thead th:first-child { border-left: 1px solid #000 !important; }
  #ghd-print-body thead th:last-child  { border-right: 1px solid #000 !important; }
}
</style>

<style id="ghd-print-full-grid">
@media print {
  #ghd-print-body table {
    border-collapse: collapse !important;
    border-spacing: 0 !important;
    width: 100% !important;
    table-layout: fixed !important;
    empty-cells: show !important;
  }
  #ghd-print-body th,
  #ghd-print-body td {
    border: 1px solid #000 !important;
    padding: 6px 8px !important;
    line-height: 1.2 !important;
  }
  #ghd-print-body thead tr {
    border-top: 2px solid #000 !important;
    border-bottom: 2px solid #000 !important;
  }
  #ghd-print-body thead th {
    border: 1px solid #000 !important;
    font-weight: bold !important;
    background-color: #fff !important;
    -webkit-print-color-adjust: exact;
  }
  #ghd-print-body tbody tr:last-child td {
    border-bottom: 1px solid #000 !important;
  }
  #ghd-totals-foot tr td {
    border-top: 2px solid #000 !important;
    font-weight: bold !important;
  }
}
</style>

<style id="ghd-print-narrow-margins">
@media print {
  @page {
    margin: 10mm !important;  /* Narrow margins to maximize printable area */
  }
  body {
    margin: 10mm !important;
  }
  #ghd-print-body {
    margin: 0 !important;
    padding: 0 !important;
  }
}
</style>

<style id="ghd-print-force-borders">
@media print {
  #ghd-print-body table {
    border-collapse: collapse !important;
    border-spacing: 0 !important;
    width: 100% !important;
  }
  #ghd-print-body th,
  #ghd-print-body td {
    border: 1px solid #000 !important;
    padding: 6px 8px !important;
    line-height: 1.2 !important;
  }
  #ghd-print-body thead th {
    font-weight: bold !important;
    background: #fff !important;
  }
  #ghd-print-body thead tr {
    border-top: 2px solid #000 !important;
    border-bottom: 2px solid #000 !important;
  }
  #ghd-print-body tbody tr:last-child td {
    border-bottom: 1px solid #000 !important;
  }
}
</style>

<style id="ghd-print-override-borders-columns">
@media print {
  /* Always draw full grid */
  #ghd-print-body table {
    border-collapse: collapse !important;
    border-spacing: 0 !important;
    width: 100% !important;
    table-layout: fixed !important;
    empty-cells: show !important;
  }
  #ghd-print-body th, #ghd-print-body td {
    border: 1px solid #000 !important;
    padding: 6px 8px !important;
    line-height: 1.2 !important;
    background-clip: padding-box !important;
  }
  #ghd-print-body thead th {
    border: 1px solid #000 !important;
  }
  #ghd-print-body thead tr {
    border-top: 2px solid #000 !important;
    border-bottom: 2px solid #000 !important;
  }
  #ghd-print-body tbody tr:last-child td {
    border-bottom: 1px solid #000 !important;
  }

  /* Make "Exact Code" column significantly narrower across all tables */
  #ghd-print-body th.col-code2, #ghd-print-body td.col-code2 {
    width: 70px !important;
    max-width: 70px !important;
    word-break: break-word !important;
    overflow-wrap: anywhere !important;
    white-space: normal !important;
  }

  /* Keep SN on one line and centered */
  #ghd-print-body th.col-idx, #ghd-print-body td.col-idx {
    min-width: 28px !important;
    white-space: nowrap !important;
    text-align: center !important;
  }
}
</style>

<style id="ghd-print-sn-and-borders-final">
@media print {
  /* Slightly wider margins and a tiny inner padding to prevent outer border clipping */
  @page { margin: 12mm; }
  #ghd-print-body { padding: 0 2mm !important; }

  /* Single, complete grid on every cell */
  #ghd-print-body table {
    border-collapse: collapse !important;
    border-spacing: 0 !important;
    width: 100% !important;
    table-layout: fixed !important;
    empty-cells: show !important;
    outline: 1px solid #000 !important;   /* outer frame guard */
    outline-offset: -1px !important;
  }
  #ghd-print-body thead { display: table-header-group !important; }
  #ghd-print-body table,
  #ghd-print-body thead,
  #ghd-print-body tbody,
  #ghd-print-body tr,
  #ghd-print-body th,
  #ghd-print-body td {
    break-inside: avoid !important;
    page-break-inside: avoid !important;
  }
  #ghd-print-body th, #ghd-print-body td {
    border: 1px solid #000 !important;
    padding: 6px 8px !important;
    line-height: 1.2 !important;
    white-space: normal;
    word-break: break-word !important;
    overflow-wrap: anywhere !important;
    background-clip: padding-box !important;
  }

  /* SN column: keep on one line and give enough width */
  #ghd-print-body th.col-idx, #ghd-print-body td.col-idx {
    white-space: nowrap !important;
    min-width: 32px !important;
    width: 32px !important;
    text-align: center !important;
  }
}
</style>
</head><body>
      <div class="top">
        <div class="brand">
          <h2>GRAY HOME DECOR</h2>
          <div class="meta">[Address] ‚Ä¢ [Phone] ‚Ä¢ [Email] ‚Ä¢ TIN</div>
        </div>
        <div class="doc">
          <h3>QUOTATION</h3>
          <table>
            <tr><th>Quotation Ref</th><td>${qno}</td></tr>
<tr><th>Quotation Date</th><td>${todayISO()}</td></tr>
<tr><th>Quotation Validity</th><td>${validityPlus5()}</td></tr>
<tr><th>Client Name</th><td>${data.customer}</td></tr>
<tr><th>Project Location</th><td>${projectLocation() || "‚Äî"}</td></tr>
            <tr><th>Tab</th><td>${data.title||tab}</td></tr>
          </table>
        </div>
      </div>
      <table class="items"><thead><tr>${head}</tr></thead><tbody>${body}</tbody></table>
      <div class="totals">${totals}</div>
      <div class="sign">
        <div style="flex:1"><div class="line">Prepared By</div></div>
        <div style="flex:1"><div class="line">Approved By</div></div>
        <div style="flex:1"><div class="line">Customer Signature</div></div>
      </div>
      <div class="noprint" style="text-align:right;margin-top:10px"><button onclick="window.print()">Print</button></div>
    
<section class="panel" id="panel-preset" style="display:none">
  <header class="panel-head">
    <h2>Preset Estimator (Wired to Main Products)</h2>
    <div class="row" style="gap:12px;align-items:center">
      <label>Customer: <input id="pre-cust" type="text" placeholder="Customer name"></label>
      <label>Discount %: <input id="pre-disc" type="number" value="0" step="any"></label>
      <label>VAT %: <input id="pre-vat" type="number" value="0" step="any"></label>
      <button id="pre-add" type="button">+ Add Item</button>
    </div>
  </header>
  <table id="pre-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Target</th>
        <th>Code</th>
        <th>Exact Code</th>
        <th>Room</th>
        <th>W</th>
        <th>Unit</th>
        <th>H</th>
        <th>Unit</th>
        <th>Sqft</th>
        <th>Options</th>
        <th>Total</th>
        <th>Remove</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <footer class="panel-foot">
    <div class="totals">
      <div>Subtotal: ‚Ç±<span id="pre-sub">0</span></div>
      <div>Discount: ‚Ç±<span id="pre-discAmt">0</span></div>
      <div>VAT: ‚Ç±<span id="pre-vatAmt">0</span></div>
      <div class="grand">Grand Total: ‚Ç±<span id="pre-grand">0</span></div>
      <div>Customer: <span id="pre-custOut">‚Äî</span></div>
    </div>
  </footer>
</section>

</body></html>`;
  }

  function openQuote(tab){
    try{
      const qno = nextQuoteNo();
      const w = window.open('', '_blank');
      w.document.open();
      w.document.write(buildPrintHTML(tab, qno));
      w.document.close();
      try{ w.focus(); }catch(e){}
    }catch(err){ alert('Print preview failed.'); }
  }

  function exportQuote(tab){
    try{
      const data = collect(tab);
      const qno = nextQuoteNo();
      const rows = [data.headers].concat(data.rows);
      // prepend doc meta
      rows.unshift(['Quotation No.', qno, 'Date', todayISO(), 'Customer', data.customer, 'Tab', data.title||tab]);
      rows.push([]);
      if(tab==='all'){
        rows.push(['Subtotal','','','','','','','', data.totals.sub||0]);
        if((data.totals.discPct||0)>0) rows.push([`Discount (${data.totals.discPct}%)`,'','','','','','', '', -(data.totals.discAmt||0)]);
        if((data.totals.vatPct||0)>0) rows.push([`VAT (${data.totals.vatPct}%)`,'','','','','','', '', (data.totals.vatAmt||0)]);
        rows.push(['Grand Total','','','','','','','', data.totals.grand||0]);
      } else {
        rows.push(['Grand Total','','','','','', data.totals.grand||0]);
      }
      // export xlsx (SheetJS assumed) with CSV fallback
      try{
        if(typeof XLSX==='undefined') throw new Error('no_xlsx');
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, 'Quotation');
        const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
        const blob = new Blob([wbout], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Quote_${qno}_${(data.title||tab).replace(/\s+/g,'_')}.xlsx`; a.click(); URL.revokeObjectURL(a.href);
      }catch(e){
        const csv = rows.map(r=>r.map(x=>String(x||'')).join(',')).join('\\n');
        const blob = new Blob([csv], {type:'text/csv'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Quote_${qno}_${(data.title||tab).replace(/\s+/g,'_')}.csv`; a.click(); URL.revokeObjectURL(a.href);
        alert('Excel library offline; CSV downloaded instead.');
      }
    }catch(err){ alert('Export failed.'); }
  }

  return { openQuote, exportQuote };
})();


<script>
/* ==== UPGRADE: All Products mixed tab supports ALL items ==== */

// Replace/extend code sourcing for mixed rows
function allGetCodesFor(product){
  let codes = [];
  const M = DATA.master || [];
  if(product==='Combi')  codes = M.filter(m => m.show && m.show.combi).map(m=>m.code);
  else if(product==='Roller') codes = M.filter(m => m.show && m.show.roller).map(m=>m.code);
  else if(product==='PVC')    codes = M.filter(m => m.show && m.show.pvc).map(m=>m.code);
  else if(product==='Synergy Combi Vertical') codes = M.filter(m => m.show && m.show.synergy).map(m=>m.code);
  else if(product==='Shangrila Blinds') codes = M.filter(m => m.show && m.show.shangrila).map(m=>m.code);
  else if(product==='Venetian Blinds') codes = M.filter(m => m.show && m.show.venetian).map(m=>m.code);
  else if(product==='Realwood Blinds') codes = M.filter(m => m.show && m.show.realwood).map(m=>m.code);
  else if(product==='Curtains - Fabric Registry') codes = M.filter(m => m.show && m.show.curtains).map(m=>m.code);
  else if(product==='Polycarbonate' || product==='Polycarbonate Accordion' || product==='Pleated Screen' || product==='Security Screen (Lock Included)' || product==='Top-to-Bottom Screen' || product==='Honeycomb'){
    // No dedicated flags in master table; allow all codes so user can still pick a code
    codes = M.map(m=>m.code);
  }
  // Fallback: if no code visible for a category, expose all codes to avoid blocking onsite quoting
  if(!codes || codes.length===0) codes = M.map(m=>m.code);
  return codes;
}

function allShowOptions(tr, product){
  // Hide all option groups first
  tr.querySelectorAll('.opts > *').forEach(x=> x.style.display='none');
  // Per-type visibility
  if(product==='Combi'){ const n=tr.querySelector('.opt-combi'); if(n) n.style.display='inline-flex'; }
  if(product==='Roller'){ ['.opt-roller'].forEach(sel=>{ const n=tr.querySelector(sel); if(n) n.style.display='grid'; }); }
  if(product==='Polycarbonate'){ const n=tr.querySelector('.opt-polycarb'); if(n) n.style.display='grid'; }
  if(product==='Polycarbonate Accordion'){ const n=tr.querySelector('.opt-accordion'); if(n) n.style.display='grid'; }
  if(product==='Pleated Screen'){ const n=tr.querySelector('.opt-pleated'); if(n) n.style.display='grid'; }
  if(product==='Security Screen (Lock Included)'){ const n=tr.querySelector('.opt-security'); if(n) n.style.display='grid'; }
  if(product==='Top-to-Bottom Screen'){ const n=tr.querySelector('.opt-t2b'); if(n) n.style.display='grid'; }
  if(product==='Honeycomb'){ const n=tr.querySelector('.opt-honey'); if(n) n.style.display='grid'; }
  if(product==='Curtains - Fabric Registry'){ const n=tr.querySelector('.opt-curtains'); if(n) n.style.display='grid'; }
}

function buildAllRow(){
  const unitSel = `<select class="unit"><option>in</option><option>cm</option><option>mm</option><option>ft</option><option>m</option></select>`;
  const typeSel = `<select class="type">
    <option>Combi</option>
    <option>Roller</option>
    <option>PVC</option>
    <option>Polycarbonate</option>
    <option>Polycarbonate Accordion</option>
    <option>Pleated Screen</option>
    <option>Security Screen (Lock Included)</option>
    <option>Top-to-Bottom Screen</option>
    <option>Honeycomb</option>
    <option>Synergy Combi Vertical</option>
    <option>Shangrila Blinds</option>
    <option>Venetian Blinds</option>
    <option>Realwood Blinds</option>
    <option>Curtains - Fabric Registry</option>
  </select>`;
  const codeSel = `<select class="code"></select>`;

  const opts = `<div class="opts">
    <!-- Combi options -->
    <label class="opt-combi" style="display:none"><input type="checkbox" class="magic"> Magic (+‚Ç±<span class="magicv">${(DATA.globals&&DATA.globals.magic_add_per_sqft)||20}</span>/ft¬≤)</label>
    <!-- Roller options -->
    <div class="opt-roller row" style="gap:6px; display:none; grid-template-columns:1fr 1fr 1fr">
      <select class="chain">
        <option value="0">Plastic (free)</option>
        <option value="20">Brass +20/ft¬≤</option>
        <option value="20">Stainless +20/ft¬≤</option>
      </select>
      <select class="btube">
        <option value="0">20mm Round (free / standard)</option>
        <option value="30">Hot Press close wrap + weight +30/ft¬≤</option>
        <option value="20">Hot Press open wrap no weight +20/ft¬≤</option>
        <option value="0">Rectangular BT (0)</option>
        <option value="4">Capsule no wrap +4/ft¬≤</option>
        <option value="20">Capsule full wrap +20/ft¬≤</option>
        <option value="30">62mm Oblong full wrap +30/ft¬≤</option>
        <option value="20">62mm Oblong no wrap +20/ft¬≤</option>
      </select>
      <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" class="magic"> Magic</label>
    </div>
    <!-- Polycarbonate options -->
    <div class="opt-polycarb row" style="gap:6px; display:none">
      <label></label>
    </div>
    <!-- Accordion options -->
    <div class="opt-accordion row" style="gap:6px; display:none">
      <label>Style 
        <select class="acc-style">
          <option value="regular">Regular</option>
          <option value="french">French</option>
        </select>
      </label>
      <label></label>
      <label><input type="checkbox" class="lock"> Lock (+‚Ç±1,000)</label>
    </div>
    <!-- Pleated options -->
    <div class="opt-pleated row" style="gap:6px; display:none">
      <label>Type 
        <select class="pl-type">
          <option>One-Way</option>
          <option>Two-Way</option>
        </select>
      </label>
    </div>
    <!-- Security options -->
    <div class="opt-security row" style="gap:6px; display:none">
      <label>Type 
        <select class="sec-type">
          <option>One-Way</option>
          <option>Two-Way</option>
        </select>
      </label>
      <span class="muted">(Lock included)</span>
    </div>
    <!-- T2B options -->
    <div class="opt-t2b row" style="gap:6px; display:none">
      <span class="muted">Top-to-Bottom screen</span>
    </div>
    <!-- Honeycomb options -->
    <div class="opt-honey row" style="gap:6px; display:none">
      <label>Type 
        <select class="hc-type">
          <option>One-Way</option>
          <option>Two-Way</option>
          <option>With Screen</option>
        </select>
      </label>
    </div>
    <!-- Curtains options -->
    <div class="opt-curtains row" style="gap:6px; display:none">
      <label>Finish 
        <select class="finish">
          <option>Pleated</option>
          <option>Ring</option>
          <option>S fold</option>
        </select>
      </label>
    </div>
  </div>`;

  return `
  <tr>
    <td class="col-idx"></td>
    <td class="col-type">${typeSel}</td>
    <td class="col-code">${codeSel}</td>
    <td class="col-code2"><input type="text" class="codeExact" placeholder="Exact code (optional)"></td>
    <td class="col-room"><input type="text" class="room" placeholder="Area of house (optional)"></td>
    <td class="col-w"><input type="number" class="width" value="50" step="any"></td>
    <td class="col-unit">${unitSel}</td>
    <td class="col-h"><input type="number" class="height" value="72" step="any"></td>
    <td class="col-unit">${unitSel}</td>
    <td class="col-sqft sqft"></td>
    <td class="col-opt">${opts}</td>
    <td class="col-total line"></td>
    <td class="col-remove"><button class="btn">‚úï</button></td>
  </tr>`;
}

function allRebuildCode(tr){
  const type = tr.querySelector('.type')?.value || '';
  const codes = allGetCodesFor(type);
  const sel = tr.querySelector('select.code');
  if(sel){ sel.innerHTML = codes.map(c=>`<option value="${c}">${c}</option>`).join(''); }
}

function recalcAllMixed(){
  const minSq = DATA.globals.min_sqft, minH = DATA.globals.min_height_in, addMagic = DATA.globals.magic_add_per_sqft;
  const tbody = document.querySelector('#a-table tbody');
  let i=0, sub=0;
  const vatPct = +(document.getElementById('a-vat')?.value||0);
  const discPct = +(document.getElementById('a-disc')?.value||0);

  tbody.querySelectorAll('tr').forEach(tr=>{
    tr.querySelector('.col-idx').textContent = (++i);
    const type = tr.querySelector('.type').value;
    const w = +(tr.querySelector('.width')?.value||0);
    const wu = tr.querySelectorAll('.unit')[0].value;
    const h = +(tr.querySelector('.height')?.value||0);
    const hu = tr.querySelectorAll('.unit')[1].value;
    const code = tr.querySelector('select.code')?.value || '';
    const final = getFinal(code);
    let area = 0, line = 0;

    if(type==='Combi'){
      area = Math.max(minSq, sqftFromWH(w,wu,h,hu,minH));
      const magic = tr.querySelector('.opt-combi .magic')?.checked;
      line = area * ( final + (magic?addMagic:0) );
    }
    else if(type==='Roller'){
      area = Math.max(minSq, sqftFromWH(w,wu,h,hu,minH));
      const chain = +(tr.querySelector('.opt-roller .chain')?.value||0);
      const btube = +(tr.querySelector('.opt-roller .btube')?.value||0);
      const magic = tr.querySelector('.opt-roller .magic')?.checked;
      line = area * ( final + chain + btube + (magic?addMagic:0) );
    }
    else if(type==='PVC' || type==='Synergy Combi Vertical' || type==='Shangrila Blinds' || type==='Venetian Blinds' || type==='Realwood Blinds'){
      area = Math.max(minSq, sqftFromWH(w,wu,h,hu,minH));
      line = area * final;
    }
    else if(type==='Curtains - Fabric Registry'){
      area = Math.max(28, sqftFromWH(w,wu,h,hu,0));
      const finish = tr.querySelector('.opt-curtains .finish')?.value || 'Pleated';
      line = area * final; // finish currently not adding fees
    }
    else if(type==='Polycarbonate'){
      area = Math.max(20, sqftFromWH(w,wu,h,hu,0));
      const open = tr.querySelector('.opt-polycarb .opening')?.value||'one-way';
      const openFee = (open==='two-way') ? 3000 : 1000;
      line = area * final + openFee;
    }
    else if(type==='Polycarbonate Accordion'){
      const Hi = toInches(h,hu);
      let Huse = 84; if(Hi<=84) Huse=84; else if(Hi<=96) Huse=96; else if(Hi<=108) Huse=108; else Huse=120;
      area = Math.max(20, (toInches(w,wu)*Huse)/144.0);
      const style = tr.querySelector('.opt-accordion .acc-style')?.value||'regular';
      const opening = tr.querySelector('.opt-accordion .opening')?.value||'one-way';
      let openFee = 0;
      if(opening==='one-way') openFee = (style==='french')?1200:1000; else openFee = (style==='french')?2400:2000;
      const lockFee = tr.querySelector('.opt-accordion .lock')?.checked ? 1000 : 0;
      line = area * final + openFee + lockFee;
    }
    else if(type==='Pleated Screen'){
      area = Math.max(15, sqftFromWH(w,wu,h,hu,0));
      line = area * final;
    }
    else if(type==='Security Screen (Lock Included)'){
      area = Math.max(20, sqftFromWH(w,wu,h,hu,0));
      const t = tr.querySelector('.opt-security .sec-type')?.value||'Two-Way';
      const twoWayFee = (t==='Two-Way') ? 3000 : 0;
      line = area * final + twoWayFee;
    }
    else if(type==='Top-to-Bottom Screen'){
      area = Math.max(15, sqftFromWH(w,wu,h,hu,0));
      line = area * final;
    }
    else if(type==='Honeycomb'){
      area = Math.max(20, sqftFromWH(w,wu,h,hu,0));
      const mode = tr.querySelector('.opt-honey .hc-type')?.value||'One-Way';
      line = area * final; // hook for future surcharges per mode
    }

    const sqftCell = tr.querySelector('.sqft');
    if(sqftCell) sqftCell.textContent = area ? area.toFixed(2) : '';
    tr.querySelector('.line').textContent = '‚Ç±'+fmt(line);
    sub += line;
  });

  const discAmt = sub * (discPct/100);
  const vatAmt = (sub - discAmt) * (vatPct/100);
  const grand = sub - discAmt + vatAmt;

  document.getElementById('a-sub').textContent = fmt(sub);
  document.getElementById('a-discAmt').textContent = fmt(discAmt);
  document.getElementById('a-vatAmt').textContent = fmt(vatAmt);
  document.getElementById('a-grand').textContent = fmt(grand);
  document.getElementById('a-custOut').textContent = document.getElementById('a-cust').value || '‚Äî';
}

function addMixedRow(){
  const tbody = document.querySelector('#a-table tbody');
  tbody.insertAdjacentHTML('beforeend', buildAllRow());
  const tr = tbody.lastElementChild;
  // Init
  allShowOptions(tr, tr.querySelector('.type').value);
  allRebuildCode(tr);
  // Bind change events
  tr.addEventListener('input', recalcAllMixed);
  tr.querySelector('.type').addEventListener('change', (e)=>{ allShowOptions(tr, e.target.value); allRebuildCode(tr); recalcAllMixed(); });
  tr.querySelector('.btn').addEventListener('click', ()=>{ tr.remove(); recalcAllMixed(); });
  recalcAllMixed();
}

// Hook All Products buttons (id=a-add) safely (avoid duplicate bindings)
(function(){
  const addBtn = document.getElementById('a-add');
  if(addBtn && !addBtn.__mixedBound){
    addBtn.__mixedBound = true;
    addBtn.addEventListener('click', addMixedRow);
    // Ensure VAT / Discount / Customer inputs recalc
    document.getElementById('a-vat')?.addEventListener('input', recalcAllMixed);
    document.getElementById('a-disc')?.addEventListener('input', recalcAllMixed);
    document.getElementById('a-cust')?.addEventListener('input', recalcAllMixed);
    // Auto add a starting row for convenience
    try{ addMixedRow(); }catch(e){}
  }
})();

// Guard any lingering Public tab code
(()=>{
  const pubAdd = document.getElementById('pub-add');
  if(pubAdd && !pubAdd.__guarded){
    pubAdd.__guarded = true;
    pubAdd.addEventListener('click', ()=> addRow(document.getElementById('pub-table'),'public',{magic:false,width:false,height:false,sqft:false}));
  }
})();
</script>


<script>
/* ===== Preset Estimator Tab (wired to Main Products pricing) ===== */

// Mapping from human-friendly preset => product + option defaults
function preMapLabel(label){
  switch(label){
    case 'Regular Accordion Door One Way': return {product:'Polycarbonate Accordion', style:'regular', opening:'one-way'};
    case 'Regular Accordion Door Two Way': return {product:'Polycarbonate Accordion', style:'regular', opening:'two-way'};
    case 'French Accordion Door One Way':  return {product:'Polycarbonate Accordion', style:'french',  opening:'one-way'};
    case 'French Accordion Door Two Way':  return {product:'Polycarbonate Accordion', style:'french',  opening:'two-way'};
    case 'Polycarbonate Accordion Door One Way': return {product:'Polycarbonate Accordion', style:'regular', opening:'one-way'};
    case 'Polycarbonate Accordion Door Two Way': return {product:'Polycarbonate Accordion', style:'regular', opening:'two-way'};
    case 'Pleated Mesh One Way':  return {product:'Pleated Screen', plType:'One-Way'};
    case 'Pleated Mesh Two Way':  return {product:'Pleated Screen', plType:'Two-Way'};
    case 'Security Screen One Way': return {product:'Security Screen (Lock Included)', secType:'One-Way'};
    case 'Security Screen Two Way': return {product:'Security Screen (Lock Included)', secType:'Two-Way'};
    case 'Top to Bottom Screen':   return {product:'Top-to-Bottom Screen'};
    case 'Honeycomb Only One way': return {product:'Honeycomb', hcType:'One-Way'};
    case 'Honeycomb Only Two way': return {product:'Honeycomb', hcType:'Two-Way'};
    case 'Honeycomb Combination with Screen': return {product:'Honeycomb', hcType:'With Screen'};
    default: return {product:'Polycarbonate Accordion', style:'regular', opening:'one-way'};
  }
}

// Codes per product using the same master table flags used elsewhere
function preGetCodesFor(product){
  if (typeof allGetCodesFor === 'function') return allGetCodesFor(product);
  const M = DATA.master || [];
  let codes = [];
  if(product==='Combi')  codes = M.filter(m => m.show && m.show.combi).map(m=>m.code);
  else if(product==='Roller') codes = M.filter(m => m.show && m.show.roller).map(m=>m.code);
  else if(product==='PVC')    codes = M.filter(m => m.show && m.show.pvc).map(m=>m.code);
  else if(product==='Synergy Combi Vertical') codes = M.filter(m => m.show && m.show.synergy).map(m=>m.code);
  else if(product==='Shangrila Blinds') codes = M.filter(m => m.show && m.show.shangrila).map(m=>m.code);
  else if(product==='Venetian Blinds') codes = M.filter(m => m.show && m.show.venetian).map(m=>m.code);
  else if(product==='Realwood Blinds') codes = M.filter(m => m.show && m.show.realwood).map(m=>m.code);
  else if(product==='Curtains - Fabric Registry') codes = M.filter(m => m.show && m.show.curtains).map(m=>m.code);
  else codes = M.map(m=>m.code);
  return (codes && codes.length)? codes : M.map(m=>m.code);
}

function preShowOptions(tr, product){
  tr.querySelectorAll('.opts > *').forEach(x=> x.style.display='none');
  if(product==='Polycarbonate Accordion'){ tr.querySelector('.opt-accordion')?.style.setProperty('display','grid'); }
  if(product==='Pleated Screen'){ tr.querySelector('.opt-pleated')?.style.setProperty('display','grid'); }
  if(product==='Security Screen (Lock Included)'){ tr.querySelector('.opt-security')?.style.setProperty('display','grid'); }
  if(product==='Top-to-Bottom Screen'){ tr.querySelector('.opt-t2b')?.style.setProperty('display','grid'); }
  if(product==='Honeycomb'){ tr.querySelector('.opt-honey')?.style.setProperty('display','grid'); }
}

function preBuildRow(){
  const unitSel = `<select class="unit"><option>in</option><option>cm</option><option>mm</option><option>ft</option><option>m</option></select>`;
  const targetSel = `<select class="target">
    <option>Regular Accordion Door One Way</option>
    <option>Regular Accordion Door Two Way</option>
    <option>French Accordion Door One Way</option>
    <option>French Accordion Door Two Way</option>
    <option>Polycarbonate Accordion Door One Way</option>
    <option>Polycarbonate Accordion Door Two Way</option>
    <option>Pleated Mesh One Way</option>
    <option>Pleated Mesh Two Way</option>
    <option>Security Screen One Way</option>
    <option>Security Screen Two Way</option>
    <option>Top to Bottom Screen</option>
    <option>Honeycomb Only One way</option>
    <option>Honeycomb Only Two way</option>
    <option>Honeycomb Combination with Screen</option>
  </select>`;
  const codeSel = `<select class="code"></select>`;
  const opts = `<div class="opts">
    <div class="opt-accordion row" style="gap:6px; display:none">
      <label>Style 
        <select class="acc-style">
          <option value="regular">Regular</option>
          <option value="french">French</option>
        </select>
      </label>
      <label></label>
      <label><input type="checkbox" class="lock"> Lock (+‚Ç±1,000)</label>
    </div>
    <div class="opt-pleated row" style="gap:6px; display:none">
      <label>Type <select class="pl-type">
        <option>One-Way</option>
        <option>Two-Way</option>
      </select></label>
    </div>
    <div class="opt-security row" style="gap:6px; display:none">
      <label>Type <select class="sec-type">
        <option>One-Way</option>
        <option>Two-Way</option>
      </select></label>
    </div>
    <div class="opt-t2b row" style="gap:6px; display:none">
      <span class="muted">Top-to-Bottom screen</span>
    </div>
    <div class="opt-honey row" style="gap:6px; display:none">
      <label>Type <select class="hc-type">
        <option>One-Way</option>
        <option>Two-Way</option>
        <option>With Screen</option>
      </select></label>
    </div>
  </div>`;
  return `
  <tr>
    <td class="col-idx"></td>
    <td class="col-target">${targetSel}</td>
    <td class="col-code">${codeSel}</td>
    <td class="col-code2"><input type="text" class="codeExact" placeholder="Exact code (optional)"></td>
    <td class="col-room"><input type="text" class="room" placeholder="Area of house (optional)"></td>
    <td class="col-w"><input type="number" class="width" value="50" step="any"></td>
    <td class="col-unit">${unitSel}</td>
    <td class="col-h"><input type="number" class="height" value="72" step="any"></td>
    <td class="col-unit">${unitSel}</td>
    <td class="col-sqft sqft"></td>
    <td class="col-opt">${opts}</td>
    <td class="col-total line"></td>
    <td class="col-remove"><button class="btn">‚úï</button></td>
  </tr>`;
}

function preRebuildCode(tr){
  const target = tr.querySelector('.target')?.value || '';
  const map = preMapLabel(target);
  const codes = preGetCodesFor(map.product);
  const sel = tr.querySelector('select.code');
  if(sel){ sel.innerHTML = codes.map(c=>`<option value="${c}">${c}</option>`).join(''); }
}

function preApplyDefaults(tr){
  const target = tr.querySelector('.target')?.value || '';
  const map = preMapLabel(target);
  preShowOptions(tr, map.product);
  if(map.style)   tr.querySelector('.acc-style')?.value = map.style;
  if(map.opening) tr.querySelector('.opening')?.value = map.opening;
  if(map.plType)  tr.querySelector('.pl-type')?.value = map.plType;
  if(map.secType) tr.querySelector('.sec-type')?.value = map.secType;
  if(map.hcType)  tr.querySelector('.hc-type')?.value = map.hcType;
}

function recalcPreset(){
  const minSq = DATA.globals.min_sqft, minH = DATA.globals.min_height_in, addMagic = DATA.globals.magic_add_per_sqft;
  const tbody = document.querySelector('#pre-table tbody');
  let i=0, sub=0;
  const vatPct = +(document.getElementById('pre-vat')?.value||0);
  const discPct = +(document.getElementById('pre-disc')?.value||0);

  tbody.querySelectorAll('tr').forEach(tr=>{
    tr.querySelector('.col-idx').textContent = (++i);
    const target = tr.querySelector('.target').value;
    const map = preMapLabel(target);
    const product = map.product;
    const w = +(tr.querySelector('.width')?.value||0);
    const wu = tr.querySelectorAll('.unit')[0].value;
    const h = +(tr.querySelector('.height')?.value||0);
    const hu = tr.querySelectorAll('.unit')[1].value;
    const code = tr.querySelector('select.code')?.value || '';
    const final = getFinal(code);
    let area = 0, line = 0;

    if(product==='Polycarbonate Accordion'){
      const Hi = toInches(h,hu);
      let Huse = 84; if(Hi<=84) Huse=84; else if(Hi<=96) Huse=96; else if(Hi<=108) Huse=108; else Huse=120;
      area = Math.max(20, (toInches(w,wu)*Huse)/144.0);
      const style = map.style || tr.querySelector('.acc-style')?.value || 'regular';
      const opening = map.opening || tr.querySelector('.opening')?.value || 'one-way';
      let openFee = 0;
      if(opening==='one-way') openFee = (style==='french')?1200:1000; else openFee = (style==='french')?2400:2000;
      const lockFee = tr.querySelector('.opt-accordion .lock')?.checked ? 1000 : 0;
      line = area * final + openFee + lockFee;
    }
    else if(product==='Pleated Screen'){
      area = Math.max(15, sqftFromWH(w,wu,h,hu,0));
      line = area * final;
    }
    else if(product==='Security Screen (Lock Included)'){
      area = Math.max(20, sqftFromWH(w,wu,h,hu,0));
      const t = map.secType || tr.querySelector('.opt-security .sec-type')?.value || 'Two-Way';
      const twoWayFee = (t==='Two-Way') ? 3000 : 0;
      line = area * final + twoWayFee;
    }
    else if(product==='Top-to-Bottom Screen'){
      area = Math.max(15, sqftFromWH(w,wu,h,hu,0));
      line = area * final;
    }
    else if(product==='Honeycomb'){
      area = Math.max(20, sqftFromWH(w,wu,h,hu,0));
      line = area * final; // hook for 'With Screen' surcharge if you want later
    }
    else {
      // default fallback (shouldn't hit)
      area = Math.max(minSq, sqftFromWH(w,wu,h,hu,minH));
      line = area * final;
    }

    const sqftCell = tr.querySelector('.sqft');
    if(sqftCell) sqftCell.textContent = area ? area.toFixed(2) : '';
    tr.querySelector('.line').textContent = '‚Ç±'+fmt(line);
    sub += line;
  });

  const discAmt = sub * (discPct/100);
  const vatAmt = (sub - discAmt) * (vatPct/100);
  const grand = sub - discAmt + vatAmt;

  document.getElementById('pre-sub').textContent = fmt(sub);
  document.getElementById('pre-discAmt').textContent = fmt(discAmt);
  document.getElementById('pre-vatAmt').textContent = fmt(vatAmt);
  document.getElementById('pre-grand').textContent = fmt(grand);
  document.getElementById('pre-custOut').textContent = document.getElementById('pre-cust').value || '‚Äî';
}

function preAddRow(){
  const tbody = document.querySelector('#pre-table tbody');
  tbody.insertAdjacentHTML('beforeend', preBuildRow());
  const tr = tbody.lastElementChild;
  // initialize
  preRebuildCode(tr);
  preApplyDefaults(tr);
  // bind
  tr.addEventListener('input', recalcPreset);
  tr.querySelector('.target').addEventListener('change', ()=>{ preRebuildCode(tr); preApplyDefaults(tr); recalcPreset(); });
  tr.querySelector('.btn').addEventListener('click', ()=>{ tr.remove(); recalcPreset(); });
  // ensure options visibility reflects mapped product
  const map = preMapLabel(tr.querySelector('.target').value);
  preShowOptions(tr, map.product);
  recalcPreset();
}

// Hook buttons/inputs for the Preset tab
(function(){
  const addBtn = document.getElementById('pre-add');
  if(addBtn && !addBtn.__bound){
    addBtn.__bound = true;
    addBtn.addEventListener('click', preAddRow);
    document.getElementById('pre-vat')?.addEventListener('input', recalcPreset);
    document.getElementById('pre-disc')?.addEventListener('input', recalcPreset);
    document.getElementById('pre-cust')?.addEventListener('input', recalcPreset);
    try{ preAddRow(); }catch(e){}
  }
})();

// Add a tab button if it wasn't injected server-side
(function(){
  const tabs = document.querySelector('.tabs');
  if(tabs && !tabs.querySelector('[data-tab="preset"]')){
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'tab-btn';
    btn.dataset.tab = "preset";
    btn.textContent = 'Preset Estimator';
    tabs.appendChild(btn);
  }
})();
</script>
</script>


<section class="panel" id="panel-preset" style="display:none">
  <header class="panel-head">
    <h2>Preset Estimator (Wired to Main Products)</h2>
    <div class="row" style="gap:12px;align-items:center">
      <label>Customer: <input id="pre-cust" type="text" placeholder="Customer name"></label>
      <label>Discount %: <input id="pre-disc" type="number" value="0" step="any"></label>
      <label>VAT %: <input id="pre-vat" type="number" value="0" step="any"></label>
      <button id="pre-add" type="button">+ Add Item</button>
    </div>
  </header>
  <table id="pre-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Target</th>
        <th>Code</th>
        <th>Exact Code</th>
        <th>Room</th>
        <th>W</th>
        <th>Unit</th>
        <th>H</th>
        <th>Unit</th>
        <th>Sqft</th>
        <th>Options</th>
        <th>Total</th>
        <th>Remove</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <footer class="panel-foot">
    <div class="totals">
      <div>Subtotal: ‚Ç±<span id="pre-sub">0</span></div>
      <div>Discount: ‚Ç±<span id="pre-discAmt">0</span></div>
      <div>VAT: ‚Ç±<span id="pre-vatAmt">0</span></div>
      <div class="grand">Grand Total: ‚Ç±<span id="pre-grand">0</span></div>
      <div>Customer: <span id="pre-custOut">‚Äî</span></div>
    </div>
  </footer>
</section>


<!-- GHD: FORCE-WIRE client/location/ref/date/validity + footer notes into PRINT -->
<script>
(function(){
  function getActiveCustomerName(){
    var active = document.querySelector('.panel.active');
    var el = active && active.querySelector('input[id$="-cust"]');
    if (el && el.value && el.value.trim()) return el.value.trim();
    var ids = ['a-cust','c-cust','r-cust','p-cust','s-cust','g-cust','v-cust','rw-cust','ct-cust'];
    for (var i=0;i<ids.length;i++){
      var e = document.getElementById(ids[i]);
      if (e && e.value && e.value.trim()) return e.value.trim();
    }
    return '';
  }
  function getProjectLocation(){
    var el = document.getElementById('projectLocationInput');
    return (el && el.value) ? el.value.trim() : '';
  }
  function getFooterNotes(){
    var el = document.getElementById('ghdFooterNotesInput');
    return (el && el.value) ? el.value.trim() : '';
  }
  function formatPH(d){
    return d.toLocaleDateString('en-PH',{year:'numeric',month:'short',day:'numeric'});
  }
  function nextQuoteRef(){
    try{
      var d=new Date(), y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
      var key='ghd_ref_counter_'+y+m+day;
      var n=parseInt(localStorage.getItem(key)||'0',10)+1;
      localStorage.setItem(key,String(n));
      return 'Q-'+y+'-'+m+'-'+day+'-'+String(n).padStart(3,'0');
    }catch(e){ return 'Q-'+Date.now(); }
  }
  var lastRef = null;

  function buildMetaValues(){
    var client = getActiveCustomerName() || '‚Äî';
    var loc    = getProjectLocation() || '‚Äî';
    var notes  = getFooterNotes() || '';
    var today  = new Date();
    var validity = new Date(today); validity.setDate(validity.getDate()+5);
    if (!lastRef) lastRef = nextQuoteRef();
    return {
      client: client,
      location: loc,
      notes: notes,
      date: formatPH(today),
      validity: formatPH(validity),
      ref: lastRef
    };
  }

  function updateOnPagePrintRoot(){
    var v = buildMetaValues();
    document.querySelectorAll('#ghdPH_client').forEach(function(el){ el.textContent = v.client; });
    document.querySelectorAll('#ghdPH_location').forEach(function(el){ el.textContent = v.location; });
    document.querySelectorAll('#ghdPH_ref').forEach(function(el){ el.textContent = v.ref; });
    document.querySelectorAll('#ghdPH_date').forEach(function(el){ el.textContent = v.date; });
    document.querySelectorAll('#ghdPH_validity').forEach(function(el){ el.textContent = v.validity; });
    var fn = document.getElementById('ghd-footer-notes');
    if (fn) fn.textContent = v.notes;
  }

  function wrapBuildPrintHTML(){
    if (!window.GHD || typeof window.GHD.buildPrintHTML !== 'function' || window.GHD.__wrappedBPH) return;
    var _orig = window.GHD.buildPrintHTML;
    window.GHD.buildPrintHTML = function(tab, qno){
      var html = _orig.call(window.GHD, tab, qno);
      var v = buildMetaValues();
      function repSpan(id, val){
        var re = new RegExp('(<span\\s+id=[\\"\']'+id+'[\\"\'][^>]*>)(.*?)(<\\/span>)','ig');
        return function(s){ return s.replace(re, '$1'+val+'$3'); };
      }
      html = repSpan('ghdPH_client', v.client)(html);
      html = repSpan('ghdPH_location', v.location)(html);
      html = repSpan('ghdPH_ref', v.ref)(html);
      html = repSpan('ghdPH_date', v.date)(html);
      html = repSpan('ghdPH_validity', v.validity)(html);
      // Footer notes
      try{
        var reNotes = new RegExp('(<[^>]*id=[\\"\']ghd-footer-notes[\\"\'][^>]*>)(.*?)(<[^>]+>)','i');
        html = html.replace(reNotes, '$1'+(v.notes||'')+'$3');
      }catch(e){}
      // Fallback inject
      if (!/ghdPH_client/i.test(html)){
        var metaBlock = ''
          + '<div style="margin:10px 0 14px 0;font-size:11pt;">'
          + '<div><strong>Client Name:</strong> '+v.client+'</div>'
          + '<div><strong>Project Location:</strong> '+v.location+'</div>'
          + '<div><strong>Quotation Ref:</strong> '+v.ref+'</div>'
          + '<div><strong>Quotation Date:</strong> '+v.date+'</div>'
          + '<div><strong>Quotation Validity:</strong> '+v.validity+'</div>'
          + '</div>';
        html = html.replace(/(<div[^>]*class=["\']ghd-title["\'][^>]*>[\s\S]*?<\/div>)/i, '$1'+metaBlock);
      }
      return html;
    };
    window.GHD.__wrappedBPH = true;
  }

  function wrapOpenQuote(){
    if (!window.GHD) window.GHD = {};
    if (typeof window.GHD.openQuote === 'function' && !window.GHD.__wrappedOQ){
      var _old = window.GHD.openQuote;
      window.GHD.openQuote = function(tab){
        updateOnPagePrintRoot();
        return _old.call(window.GHD, tab);
      };
      window.GHD.__wrappedOQ = true;
    } else if (typeof window.GHD.openQuote !== 'function'){
      window.GHD.openQuote = function(){
        updateOnPagePrintRoot();
        window.print();
      };
      window.GHD.__wrappedOQ = true;
    }
  }

  function bindLive(){
    var ids = ['projectLocationInput','ghdFooterNotesInput','a-cust','c-cust','r-cust','p-cust','s-cust','g-cust','v-cust','rw-cust','ct-cust'];
    ids.forEach(function(id){
      var el = document.getElementById(id);
      if (el && !el.__ghdBound){
        el.addEventListener('input', updateOnPagePrintRoot);
        el.__ghdBound = true;
      }
    });
  }
  window.addEventListener('beforeprint', updateOnPagePrintRoot);

  document.addEventListener('DOMContentLoaded', function(){
    bindLive();
    updateOnPagePrintRoot();
    wrapBuildPrintHTML();
    wrapOpenQuote();
  });
  var mo = new MutationObserver(function(){
    bindLive();
    wrapBuildPrintHTML();
    wrapOpenQuote();
  });
  mo.observe(document.documentElement, {childList:true, subtree:true});
})();
</script>

<!-- GHD: META WIRING (client/location/ref/date/validity + footer notes) -->
<script>
(function(){
  function getActiveCustomerName(){
    var active = document.querySelector('.panel.active');
    var el = active && active.querySelector('input[id$="-cust"]');
    if (el && el.value && el.value.trim()) return el.value.trim();
    var ids = ['a-cust','c-cust','r-cust','p-cust','s-cust','g-cust','v-cust','rw-cust','ct-cust'];
    for (var i=0;i<ids.length;i++){
      var e = document.getElementById(ids[i]);
      if (e && e.value && e.value.trim()) return e.value.trim();
    }
    return '';
  }
  function getProjectLocation(){
    var el = document.getElementById('projectLocationInput');
    return (el && el.value) ? el.value.trim() : '';
  }
  function getFooterNotes(){
    var el = document.getElementById('ghdFooterNotesInput');
    return (el && el.value) ? el.value.trim() : '';
  }
  function formatPH(d){
    return d.toLocaleDateString('en-PH',{year:'numeric',month:'short',day:'numeric'});
  }
  function nextQuoteRef(){
    try{
      var d=new Date(), y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
      var key='ghd_ref_counter_'+y+m+day;
      var n=parseInt(localStorage.getItem(key)||'0',10)+1;
      localStorage.setItem(key,String(n));
      return 'Q-'+y+'-'+m+'-'+day+'-'+String(n).padStart(3,'0');
    }catch(e){ return 'Q-'+Date.now(); }
  }
  var lastRef = null;

  function buildMetaValues(){
    var client = getActiveCustomerName() || '‚Äî';
    var loc    = getProjectLocation() || '‚Äî';
    var notes  = getFooterNotes() || '';
    var today  = new Date();
    var validity = new Date(today); validity.setDate(validity.getDate()+5);
    if (!lastRef) lastRef = nextQuoteRef();
    return {
      client: client,
      location: loc,
      notes: notes,
      date: formatPH(today),
      validity: formatPH(validity),
      ref: lastRef
    };
  }

  function updateOnPagePrintRoot(){
    var v = buildMetaValues();
    document.querySelectorAll('#ghdPH_client').forEach(function(el){ el.textContent = v.client; });
    document.querySelectorAll('#ghdPH_location').forEach(function(el){ el.textContent = v.location; });
    document.querySelectorAll('#ghdPH_ref').forEach(function(el){ el.textContent = v.ref; });
    document.querySelectorAll('#ghdPH_date').forEach(function(el){ el.textContent = v.date; });
    document.querySelectorAll('#ghdPH_validity').forEach(function(el){ el.textContent = v.validity; });
    var fn = document.getElementById('ghd-footer-notes');
    if (fn) fn.textContent = v.notes;
  }

  function wrapBuildPrintHTML(){
    if (!window.GHD || typeof window.GHD.buildPrintHTML !== 'function' || window.GHD.__wrappedBPH) return;
    var _orig = window.GHD.buildPrintHTML;
    window.GHD.buildPrintHTML = function(tab, qno){
      var html = _orig.call(window.GHD, tab, qno);
      var v = buildMetaValues();
      function repSpan(id, val){
        var re = new RegExp('(<span\\\\s+id=[\\\\\"\\\']'+id+'[\\\\\"\\\'][^>]*>)(.*?)(<\\\\/span>)','ig');
        return function(s){ return s.replace(re, '$1'+val+'$3'); };
      }
      html = repSpan('ghdPH_client', v.client)(html);
      html = repSpan('ghdPH_location', v.location)(html);
      html = repSpan('ghdPH_ref', v.ref)(html);
      html = repSpan('ghdPH_date', v.date)(html);
      html = repSpan('ghdPH_validity', v.validity)(html);
      // Footer notes
      try{
        var reNotes = new RegExp('(<[^>]*id=[\\\\\"\\\']ghd-footer-notes[\\\\\"\\\'][^>]*>)(.*?)(<[^>]+>)','i');
        html = html.replace(reNotes, '$1'+(v.notes||'')+'$3');
      }catch(e){}
      // Fallback injection if placeholders not present
      if (!/ghdPH_client/i.test(html)){
        var metaBlock = ''
          + '<div style="margin:10px 0 14px 0;font-size:11pt;">'
          + '<div><strong>Client Name:</strong> '+v.client+'</div>'
          + '<div><strong>Project Location:</strong> '+v.location+'</div>'
          + '<div><strong>Quotation Ref:</strong> '+v.ref+'</div>'
          + '<div><strong>Quotation Date:</strong> '+v.date+'</div>'
          + '<div><strong>Quotation Validity:</strong> '+v.validity+'</div>'
          + '</div>';
        html = html.replace(/(<div[^>]*class=["\\']ghd-title["\\'][^>]*>[\\s\\S]*?<\\/div>)/i, '$1'+metaBlock);
      }
      return html;
    };
    window.GHD.__wrappedBPH = true;
  }

  function wrapOpenQuote(){
    if (!window.GHD) window.GHD = {};
    if (typeof window.GHD.openQuote === 'function' && !window.GHD.__wrappedOQ){
      var _old = window.GHD.openQuote;
      window.GHD.openQuote = function(tab){
        updateOnPagePrintRoot();
        return _old.call(window.GHD, tab);
      };
      window.GHD.__wrappedOQ = true;
    } else if (typeof window.GHD.openQuote !== 'function'){
      window.GHD.openQuote = function(){
        updateOnPagePrintRoot();
        window.print();
      };
      window.GHD.__wrappedOQ = true;
    }
  }

  function bindLive(){
    var ids = ['projectLocationInput','ghdFooterNotesInput','a-cust','c-cust','r-cust','p-cust','s-cust','g-cust','v-cust','rw-cust','ct-cust'];
    ids.forEach(function(id){
      var el = document.getElementById(id);
      if (el && !el.__ghdBound){
        el.addEventListener('input', updateOnPagePrintRoot);
        el.__ghdBound = true;
      }
    });
  }
  window.addEventListener('beforeprint', updateOnPagePrintRoot);

  document.addEventListener('DOMContentLoaded', function(){
    bindLive();
    updateOnPagePrintRoot();
    wrapBuildPrintHTML();
    wrapOpenQuote();
  });
  var mo = new MutationObserver(function(){
    bindLive();
    wrapBuildPrintHTML();
    wrapOpenQuote();
  });
  mo.observe(document.documentElement, {childList:true, subtree:true});
})();
</script>

<script id="ghd-print-sn-fix">
(function(){
  function normalizeSN(root){
    try {
      var cells = (root || document).querySelectorAll('#ghd-print-body thead th.col-idx');
      cells.forEach(function(th){ th.textContent = 'SN'; });
    } catch(e) {}
  }

  document.addEventListener('DOMContentLoaded', function(){
    normalizeSN(document);
  });
  window.addEventListener('beforeprint', function(){
    normalizeSN(document);
  });

  // If the app builds a new window's HTML, patch the generated HTML too
  function wrapBuildPrintHTML(){
    if (!window.GHD || typeof window.GHD.buildPrintHTML !== 'function' || window.GHD.__wrappedSNFix) return;
    var _old = window.GHD.buildPrintHTML;
    window.GHD.buildPrintHTML = function(tab, qno){
      var html = _old.call(window.GHD, tab, qno);
      try {
        // Replace S<br>N or multi-line SN with SN
        html = html.replace(/(<th[^>]*class=["'][^"']*col-idx[^"']*["'][^>]*>)[\s\S]*?(<\/th>)/ig, function(_, a, b){
          return a + 'SN' + b;
        });
        // Also replace bare # header with SN
        html = html.replace(/(<th[^>]*class=["'][^"']*col-idx[^"']*["'][^>]*>)\s*#\s*(<\/th>)/ig, '$1SN$2');
      } catch(e) {}
      return html;
    };
    window.GHD.__wrappedSNFix = true;
  }
  document.addEventListener('DOMContentLoaded', wrapBuildPrintHTML);
  new MutationObserver(wrapBuildPrintHTML).observe(document.documentElement, {childList:true, subtree:true});
})();
</script>

<script id="ghd-force-sn-final">
(function(){
  function forceSN(root){
    (root||document).querySelectorAll('#ghd-print-body thead th.col-idx').forEach(function(th){
      th.textContent = 'SN';
      th.style.whiteSpace = 'nowrap';
    });
  }

  document.addEventListener('DOMContentLoaded', function(){
    forceSN(document);
  });
  window.addEventListener('beforeprint', function(){
    forceSN(document);
  });

  // If the app generates a new window's HTML for printing, patch that too
  function wrapBuildPrintHTML(){
    if (!window.GHD || typeof window.GHD.buildPrintHTML !== 'function' || window.GHD.__wrappedForceSN) return;
    var _orig = window.GHD.buildPrintHTML;
    window.GHD.buildPrintHTML = function(tab, qno){
      var html = _orig.call(window.GHD, tab, qno);
      try {
        // Replace any content inside the index header cell with SN
        html = html.replace(/(<th\b[^>]*class="[^"]*col-idx[^"]*"[^>]*>)[\s\S]*?(<\/th>)/ig, '$1SN$2');
        // Ensure nowrap on SN in the generated print
        if (!/ghd-print-sn-nowrap-final/.test(html)){
          html = html.replace(/<\/head>/i, '<style id="ghd-print-sn-nowrap-final">@media print{ th.col-idx{white-space:nowrap!important;min-width:32px!important;width:32px!important;} }</style>
<style id="ghd-print-trim-and-no-fixed-footer">
@media print {
  /* Trim size to avoid edge clipping */
  @page { margin: 12mm; }
  #ghd-print-root { font-size: 9pt !important; }
  #ghd-print-body table {
    width: 94% !important;
    margin: 0 auto !important;
    border-collapse: collapse !important;
    table-layout: fixed !important;
    outline: 1px solid #000 !important;
    outline-offset: -1px !important;
  }
  #ghd-print-body th, #ghd-print-body td {
    border: 1px solid #000 !important;
    padding: 5px 7px !important;
    line-height: 1.2 !important;
    overflow: visible !important;
    text-overflow: clip !important;
    white-space: normal !important;
  }

  /* Hide common fixed footer containers if present */
  #ghd-print-footer,
  .ghd-print-footer,
  .print-footer,
  footer.print-footer,
  #print-footer {
    display: none !important;
  }

  /* SN must not wrap or ellipsize */
  th.col-idx, td.col-idx {
    white-space: nowrap !important;
    overflow: visible !important;
    text-overflow: clip !important;
    min-width: 34px !important;
    width: 34px !important;
    text-align: center !important;
  }
}
</style>

<style id="ghd-footer-notes-textbox-16px">
@media screen {
  #ghdFooterNotesInput { font-size: 16px !important; line-height: 1.35 !important; }
  label[for="ghdFooterNotesInput"] { font-size: 16px !important; }
}
</style>

<style id="ghd-footer-notes-print-style-21">
@media print {
  #ghd-footer-notes-print { white-space: pre-wrap; }
}
</style>

<style id="ghd-footer-notes-input-16">
@media screen {
  #ghdFooterNotesInput { font-size: 16px !important; line-height: 1.35 !important; }
  label[for="ghdFooterNotesInput"] { font-size: 16px !important; }
}
</style>

<style id="ghd-print-landscape-and-grid">
@media print {
  /* Force landscape and give generous margins */
  @page { size: A4 landscape; margin: 12mm; }
  /* Some engines only honor generic 'landscape' */
  @page { size: landscape; }

  /* Make table fit cleanly in landscape */
  #ghd-print-root { font-size: 10pt !important; }
  #ghd-print-body table {
    width: 96% !important;
    margin-left: auto !important;
    margin-right: auto !important;
    border-collapse: collapse !important;
    border-spacing: 0 !important;
    table-layout: fixed !important;
    outline: 1px solid #000 !important;   /* outer frame guard */
    outline-offset: -1px !important;
  }
  #ghd-print-body, #ghd-print-root { padding: 0 2mm !important; }

  /* Solid grid on all cells */
  #ghd-print-body th, #ghd-print-body td {
    border: 1px solid #000 !important;
    padding: 5px 7px !important;
    line-height: 1.2 !important;
    background-clip: padding-box !important;
    overflow: visible !important;
    text-overflow: clip !important;
    white-space: normal !important;
    word-break: break-word !important;
    overflow-wrap: anywhere !important;
  }
  #ghd-print-body thead { display: table-header-group !important; }
  #ghd-print-body table, #ghd-print-body thead, #ghd-print-body tbody, #ghd-print-body tr, #ghd-print-body th, #ghd-print-body td {
    break-inside: avoid !important;
    page-break-inside: avoid !important;
  }

  /* SN cell: keep "SN" side by side */
  #ghd-print-body th.col-idx, #ghd-print-body td.col-idx {
    white-space: nowrap !important;
    min-width: 34px !important;
    width: 34px !important;
    text-align: center !important;
  }

  /* Footer notes block styling */
  #ghd-footer-notes-print { 
    white-space: pre-wrap !important;
    font-size: 12pt !important;
    margin-top: 10mm !important;
    padding-top: 4mm !important;
    border-top: 1px solid #000 !important;
  }
}
</style>
</head>');
        }
      } catch(e){}
      return html;
    };
    window.GHD.__wrappedForceSN = true;
  }
  document.addEventListener('DOMContentLoaded', wrapBuildPrintHTML);
  new MutationObserver(wrapBuildPrintHTML).observe(document.documentElement, {childList:true, subtree:true});
})();
</script>

<script id="ghd-remove-disclaimer-and-force-sn">
(function(){
  var PHRASES = [
    "Delivery is 7‚Äì14 days from the date of Down Payment",
    "Payment Terms: 50% advance, 50% upon installation",
    "BDO:", "BPI:", "GCash:", "Material Used:"
  ];

  function removeDisclaimerBlocks(root){
    var scope = root || document;
    // Try remove obvious footer containers first
    scope.querySelectorAll('#ghd-print-footer,.ghd-print-footer,.print-footer,#print-footer').forEach(function(el){
      el.remove();
    });
    // Fallback: scan for phrases and remove their nearest footer-like parent
    var walker = document.createTreeWalker(scope.body || scope, NodeFilter.SHOW_TEXT, null);
    var toRemove = new Set();
    while (walker.nextNode()){
      var t = walker.currentNode.nodeValue;
      if (!t) continue;
      for (var i=0;i<PHRASES.length;i++){
        if (t.indexOf(PHRASES[i]) !== -1){
          var el = walker.currentNode.parentElement;
          var parent = el && el.closest('footer,[id*="foot" i],[class*="foot" i],[class*="note" i],[id*="note" i],[class*="term" i],[id*="term" i]');
          toRemove.add(parent || el);
          break;
        }
      }
    }
    toRemove.forEach(function(el){ try{ el.remove(); }catch(e){} });
  }

  function ensureSN(root){
    (root||document).querySelectorAll('th.col-idx').forEach(function(th){
      th.textContent = 'SN';
      th.style.whiteSpace = 'nowrap';
    });
  }

  // Insert a simple customer signature line near the end of print body (only once)
  function insertCustomerSign(){
    var root = document.getElementById('ghd-print-body') || document.getElementById('ghd-print-root') || document.body;
    if (!root) return;
    if (document.getElementById('ghd-customer-sign-print')) return;
    var wrap = document.createElement('div');
    wrap.id = 'ghd-customer-sign-print';
    wrap.setAttribute('style','page-break-inside:avoid;margin-top:10mm;padding-top:4mm;width:100%;font-size:12px;');
    wrap.innerHTML = '<div style="display:flex;gap:24px;align-items:flex-end;width:100%;">'
      + '<div style="flex:1;"><div style="border-bottom:1px solid #000;height:24px;"></div><div style="margin-top:4px;">Customer Signature</div></div>'
      + '</div>';
    root.appendChild(wrap);
  }

  document.addEventListener('DOMContentLoaded', function(){
    ensureSN(document);
  });

  window.addEventListener('beforeprint', function(){
    removeDisclaimerBlocks(document);
    ensureSN(document);
    insertCustomerSign();
  });

  // Patch new-window print HTML
  function wrapBuildPrintHTML(){
    if (!window.GHD || typeof window.GHD.buildPrintHTML !== 'function' || window.GHD.__wrappedFooterClean) return;
    var _old = window.GHD.buildPrintHTML;
    window.GHD.buildPrintHTML = function(tab, qno){
      var html = _old.call(window.GHD, tab, qno);
      try {
        // Strip fixed footer containers by id/class
        html = html.replace(/<footer[^>]*class=["'][^"']*(?:print-footer|ghd-print-footer)[^"']*["'][\s\S]*?<\/footer>/ig, '');
        html = html.replace(/<div[^>]*id=["']ghd-print-footer["'][\s\S]*?<\/div>/ig, '');
        html = html.replace(/<div[^>]*class=["'][^"']*(?:print-footer|ghd-print-footer)[^"']*["'][\s\S]*?<\/div>/ig, '');
        // Remove lines containing phrases (crude but effective)
        html = html.replace(/.*(Delivery is 7‚Äì14 days|Payment Terms:|BDO:|BPI:|GCash:|Material Used:).*?\n/ig, '');
        // Force SN
        html = html.replace(/(<th\b[^>]*class="[^"]*col-idx[^"]*"[^>]*>)[\s\S]*?(<\/th>)/ig, '$1SN$2');
      } catch(e){}
      return html;
    };
    window.GHD.__wrappedFooterClean = true;
  }
  document.addEventListener('DOMContentLoaded', wrapBuildPrintHTML);
  new MutationObserver(wrapBuildPrintHTML).observe(document.documentElement, {childList:true, subtree:true});
})();
</script>

<script id="ghd-link-footer-notes-to-print-21">
(function(){
  function getFooterNotes(){
    var el = document.getElementById('ghdFooterNotesInput');
    return (el && el.value) ? el.value.trim() : '';
  }
  function containerRoot(){
    return document.getElementById('ghd-print-body') || document.getElementById('ghd-print-root') || document.body;
  }
  function ensureFooterNotesAndSignature(){
    var root = containerRoot();
    if (!root) return;

    // ----- Footer Notes block at bottom -----
    var notes = getFooterNotes();
    var existingNotes = document.getElementById('ghd-footer-notes-print');
    if (notes){
      if (!existingNotes){
        existingNotes = document.createElement('div');
        existingNotes.id = 'ghd-footer-notes-print';
        existingNotes.setAttribute('style',
          'page-break-inside:avoid;margin-top:10mm;padding-top:4mm;width:100%;font-size:12pt;');
        root.appendChild(existingNotes);
      }
      existingNotes.textContent = notes;
    } else if (existingNotes){
      existingNotes.remove();
    }

    // ----- Compact Customer Signature (short underline only) -----
    var oldSig = document.getElementById('ghd-customer-sign-print');
    if (oldSig) oldSig.remove();

    var sigWrap = document.createElement('div');
    sigWrap.id = 'ghd-customer-sign-print';
    sigWrap.setAttribute('style','page-break-inside:avoid;margin-top:8mm;width:100%;font-size:12px;display:flex;');

    var sigInner = document.createElement('div');
    // Short underline ~ fits the phrase "Customer Signature"
    sigInner.setAttribute('style','display:inline-block;min-width:180px;max-width:220px;');
    sigInner.innerHTML = '<div style="border-bottom:1px solid #000;height:22px;width:100%;"></div>' +
                         '<div style="margin-top:4px;text-align:left;">Customer Signature</div>';

    sigWrap.appendChild(sigInner);
    root.appendChild(sigWrap);
  }

  // Only inject right before printing (keeps screen clean)
  window.addEventListener('beforeprint', ensureFooterNotesAndSignature);

  // Also patch generated print HTML (buildPrintHTML) so the bottom blocks appear in the print window
  function wrapBuildPrintHTML(){
    if (!window.GHD || typeof window.GHD.buildPrintHTML !== 'function' || window.GHD.__wrapFooterNotes21) return;
    var _old = window.GHD.buildPrintHTML;
    window.GHD.buildPrintHTML = function(tab, qno){
      var html = _old.call(window.GHD, tab, qno);
      try {
        var notes = (document.getElementById('ghdFooterNotesInput')||{}).value || '';
        // Append footer notes + compact signature right before </body>
        var inject = '<div id="ghd-footer-notes-print" style="page-break-inside:avoid;margin-top:10mm;padding-top:4mm;width:100%;font-size:12pt;">'
                   + (notes? notes.replace(/</g,'&lt;').replace(/>/g,'&gt;') : '')
                   + '</div>'
                   + '<div id="ghd-customer-sign-print" style="page-break-inside:avoid;margin-top:8mm;width:100%;font-size:12px;display:flex;">'
                   + '  <div style="display:inline-block;min-width:180px;max-width:220px;">'
                   + '    <div style="border-bottom:1px solid #000;height:22px;width:100%;"></div>'
                   + '    <div style="margin-top:4px;text-align:left;">Customer Signature</div>'
                   + '  </div>'
                   + '</div>';
        html = html.replace(/<\/body>/i, inject + '</body>');
      } catch(e){}
      return html;
    };
    window.GHD.__wrapFooterNotes21 = true;
  }
  document.addEventListener('DOMContentLoaded', wrapBuildPrintHTML);
  new MutationObserver(wrapBuildPrintHTML).observe(document.documentElement, {childList:true, subtree:true});
})();
</script>

<script id="ghd-wire-footer-notes-and-landscape">
(function(){
  function getFooterNotes(){
    var el = document.getElementById('ghdFooterNotesInput');
    return (el && el.value) ? el.value.trim() : '';
  }
  function rootEl(){
    return document.getElementById('ghd-print-body') || document.getElementById('ghd-print-root') || document.body;
  }

  function injectFooterNotesAndSignature(root){
    var container = rootEl();
    if (!container) return;

    // ----- Footer Notes (linked from textbox) -----
    var notes = getFooterNotes();
    var notesBlock = container.querySelector('#ghd-footer-notes-print');
    if (!notesBlock){
      notesBlock = document.createElement('div');
      notesBlock.id = 'ghd-footer-notes-print';
      container.appendChild(notesBlock);
    }
    // escape angle brackets but keep line breaks via textContent
    notesBlock.textContent = notes;

    // ----- Compact Customer Signature (short underline only) -----
    var sig = container.querySelector('#ghd-customer-sign-print');
    if (!sig){
      sig = document.createElement('div');
      sig.id = 'ghd-customer-sign-print';
      sig.style.pageBreakInside = 'avoid';
      sig.style.marginTop = '8mm';
      sig.style.fontSize = '12px';
      sig.style.display = 'flex';
      var inner = document.createElement('div');
      inner.style.display = 'inline-block';
      inner.style.minWidth = '180px';
      inner.style.maxWidth = '220px';
      inner.innerHTML = '<div style="border-bottom:1px solid #000;height:22px;width:100%;"></div>'
                      + '<div style="margin-top:4px;text-align:left;">Customer Signature</div>';
      sig.appendChild(inner);
      container.appendChild(sig);
    }
  }

  // Keep SN horizontally on the page DOM
  function forceSN(){
    document.querySelectorAll('#ghd-print-body thead th.col-idx').forEach(function(th){
      th.textContent = 'SN';
      th.style.whiteSpace = 'nowrap';
    });
  }

  // Wire beforeprint for current page
  window.addEventListener('beforeprint', function(){
    forceSN();
    injectFooterNotesAndSignature(document);
  });

  // Also patch the generated print HTML (new window) so it has notes + signature + SN
  function wrapBuildPrintHTML(){
    if (!window.GHD || typeof window.GHD.buildPrintHTML !== 'function' || window.GHD.__wrapFN22) return;
    var _old = window.GHD.buildPrintHTML;
    window.GHD.buildPrintHTML = function(tab, qno){
      var html = _old.call(window.GHD, tab, qno);
      try {
        var notes = (document.getElementById('ghdFooterNotesInput')||{}).value || '';
        // ensure SN stays horizontal
        html = html.replace(/(<th\b[^>]*class="[^"]*col-idx[^"]*"[^>]*>)[\s\S]*?(<\/th>)/ig, '$1SN$2');
        // add footer notes + compact signature before </body>
        var inject = ''
          + '<div id="ghd-footer-notes-print" style="white-space:pre-wrap;font-size:12pt;margin-top:10mm;padding-top:4mm;border-top:1px solid #000;">'
          + (notes ? (notes.replace(/</g,'&lt;').replace(/>/g,'&gt;')) : '')
          + '</div>'
          + '<div id="ghd-customer-sign-print" style="page-break-inside:avoid;margin-top:8mm;font-size:12px;display:flex;">'
          + '  <div style="display:inline-block;min-width:180px;max-width:220px;">'
          + '    <div style="border-bottom:1px solid #000;height:22px;width:100%;"></div>';
        inject += '    <div style="margin-top:4px;text-align:left;">Customer Signature</div>';
        inject += '  </div></div>';
        html = html.replace(/<\/body>/i, inject + '</body>');

        // ensure print CSS in the child also uses landscape/table grid
        if (!/ghd-print-landscape-and-grid/.test(html)){
          html = html.replace(/<\/head>/i, '<style id="ghd-print-landscape-and-grid">@media print {  /* Force landscape and give generous margins */  @page { size: A4 landscape; margin: 12mm; }  /* Some engines only honor generic \'landscape\' */  @page { size: landscape; }  /* Make table fit cleanly in landscape */  #ghd-print-root { font-size: 10pt !important; }  #ghd-print-body table {    width: 96% !important;    margin-left: auto !important;    margin-right: auto !important;    border-collapse: collapse !important;    border-spacing: 0 !important;    table-layout: fixed !important;    outline: 1px solid #000 !important;   /* outer frame guard */    outline-offset: -1px !important;  }  #ghd-print-body, #ghd-print-root { padding: 0 2mm !important; }  /* Solid grid on all cells */  #ghd-print-body th, #ghd-print-body td {    border: 1px solid #000 !important;    padding: 5px 7px !important;    line-height: 1.2 !important;    background-clip: padding-box !important;    overflow: visible !important;    text-overflow: clip !important;    white-space: normal !important;    word-break: break-word !important;    overflow-wrap: anywhere !important;  }  #ghd-print-body thead { display: table-header-group !important; }  #ghd-print-body table, #ghd-print-body thead, #ghd-print-body tbody, #ghd-print-body tr, #ghd-print-body th, #ghd-print-body td {    break-inside: avoid !important;    page-break-inside: avoid !important;  }  /* SN cell: keep "SN" side by side */  #ghd-print-body th.col-idx, #ghd-print-body td.col-idx {    white-space: nowrap !important;    min-width: 34px !important;    width: 34px !important;    text-align: center !important;  }  /* Footer notes block styling */  #ghd-footer-notes-print {     white-space: pre-wrap !important;    font-size: 12pt !important;    margin-top: 10mm !important;    padding-top: 4mm !important;    border-top: 1px solid #000 !important;  }}</style>
<style id="ghd-landscape-toggle-style">
@media screen {
  #ghdLandscapeWrap {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin-left: 12px;
    font-size: 14px;
  }
  #ghdLandscapeToggle {
    transform: translateY(1px);
  }
}
</style>
</head>');
        }
      } catch(e){}
      return html;
    };
    window.GHD.__wrapFN22 = true;
  }
  document.addEventListener('DOMContentLoaded', wrapBuildPrintHTML);
  new MutationObserver(wrapBuildPrintHTML).observe(document.documentElement, {childList:true, subtree:true});
})();
</script>

<script id="ghd-landscape-toggle-script">
(function(){
  var KEY = 'ghd_landscape_pref';

  function insertToggle(){
    if (document.getElementById('ghdLandscapeWrap')) return;
    var container = document.getElementById('ghd-screen-toolbar')
                  || document.getElementById('ghd-footer-notes-toolbar')
                  || document.querySelector('.toolbar')
                  || document.body;
    var wrap = document.createElement('label');
    wrap.id = 'ghdLandscapeWrap';
    wrap.innerHTML = '<input type="checkbox" id="ghdLandscapeToggle"> <span>Landscape (A4)</span>';
    try { if (localStorage.getItem(KEY) === '1') wrap.querySelector('#ghdLandscapeToggle').checked = true; } catch(e){}
    container.appendChild(wrap);

    var cb = wrap.querySelector('#ghdLandscapeToggle');
    cb.addEventListener('change', function(){
      try { localStorage.setItem(KEY, cb.checked ? '1' : '0'); } catch(e){}
    });
  }

  function ensureOrientation(){
    var cb = document.getElementById('ghdLandscapeToggle');
    var want = !!(cb && cb.checked);
    if (!want){
      try { want = (localStorage.getItem(KEY) === '1'); } catch(e){}
    }
    var tag = document.getElementById('ghd-orientation-style');
    if (want){
      if (!tag){
        tag = document.createElement('style');
        tag.id = 'ghd-orientation-style';
        tag.textContent = '@media print{ @page{ size: A4 landscape; margin: 12mm; } @page{ size: landscape; } }';
        document.head.appendChild(tag);
      }
    } else {
      if (tag) tag.remove();
    }
  }

  // Wrap buildPrintHTML to inject orientation into the print window
  function wrapBuildPrintHTML(){
    if (!window.GHD || typeof window.GHD.buildPrintHTML !== 'function' || window.GHD.__wrapLandscapeOption) return;
    var _old = window.GHD.buildPrintHTML;
    window.GHD.buildPrintHTML = function(tab, qno){
      var html = _old.call(window.GHD, tab, qno);
      var want = false;
      var cb = document.getElementById('ghdLandscapeToggle');
      if (cb && cb.checked) want = true;
      else { try { want = (localStorage.getItem(KEY) === '1'); } catch(e){} }
      if (want){
        if (!/id=["']ghd-print-landscape-opt["']/.test(html)){
          var style = '<style id="ghd-print-landscape-opt">@media print{ @page{ size: A4 landscape; margin: 12mm; } @page{ size: landscape; } }</style>';
          html = html.replace(/<\/head>/i, style + '</head>');
        }
      } else {
        html = html.replace(/<style[^>]*id=["']ghd-print-landscape-opt["'][\s\S]*?<\/style>/ig, '');
      }
      return html;
    };
    window.GHD.__wrapLandscapeOption = true;
  }

  document.addEventListener('DOMContentLoaded', function(){
    insertToggle();
    ensureOrientation();
    wrapBuildPrintHTML();
  });

  window.addEventListener('beforeprint', ensureOrientation);

  // Re-apply if parts of the DOM get replaced
  new MutationObserver(function(){
    insertToggle();
    wrapBuildPrintHTML();
  }).observe(document.documentElement, {childList:true, subtree:true});
})();
</script>

<script id="ghd-print-master">
(function(){
  var LS_KEY = 'ghd_landscape_pref';

  function wantLandscape(){
    var cb = document.getElementById('ghdLandscapeToggle');
    var val = !!(cb && cb.checked);
    try { if (!val) val = (localStorage.getItem(LS_KEY) === '1'); } catch(e){}
    return val;
  }

  function getFooterNotes(){ 
    var el = document.getElementById('ghdFooterNotesInput'); 
    return (el && el.value) ? el.value : ''; 
  }

  function printRoot(){
    return document.getElementById('ghd-print-body') || document.getElementById('ghd-print-root') || document.body;
  }

  function buildPrintCSS(landscape){
    var orient = landscape ? '@page{size:A4 landscape;margin:12mm;} @page{size:landscape;}' : '';
    return '@media print{'
      + orient
      + ' #ghd-print-root{font-size:10pt!important;}'
      + ' #ghd-print-body, #ghd-print-root{padding:0 2mm!important;}'
      + ' #ghd-print-body table{width:96%!important;margin:0 auto!important;border-collapse:collapse!important;border-spacing:0!important;table-layout:fixed!important;outline:1px solid #000!important;outline-offset:-1px!important;}'
      + ' #ghd-print-body thead{display:table-header-group!important;}'
      + ' #ghd-print-body table,#ghd-print-body thead,#ghd-print-body tbody,#ghd-print-body tr,#ghd-print-body th,#ghd-print-body td{break-inside:avoid!important;page-break-inside:avoid!important;}'
      + ' #ghd-print-body th,#ghd-print-body td{border:1px solid #000!important;padding:5px 7px!important;line-height:1.2!important;overflow:visible!important;text-overflow:clip!important;white-space:normal!important;word-break:break-word!important;overflow-wrap:anywhere!important;background-clip:padding-box!important;}'
      + ' #ghd-print-body th.col-idx,#ghd-print-body td.col-idx{white-space:nowrap!important;min-width:34px!important;width:34px!important;text-align:center!important;}'
      + ' #ghd-footer-notes-print{white-space:pre-wrap!important;font-size:12pt!important;margin-top:10mm!important;padding-top:4mm!important;border-top:1px solid #000!important;}'
      + '}';
  }

  function ensureMasterCSS(){
    // Remove older injected orientation-only style to avoid conflicts
    var old = document.getElementById('ghd-orientation-style');
    if (old) old.remove();

    var style = document.getElementById('ghd-print-master-css');
    if (!style){
      style = document.createElement('style');
      style.id = 'ghd-print-master-css';
      document.head.appendChild(style);
    }
    style.textContent = buildPrintCSS(wantLandscape());
  }

  function ensureSN(){
    document.querySelectorAll('#ghd-print-body thead th.col-idx').forEach(function(th){
      th.textContent = 'SN';
      th.style.whiteSpace = 'nowrap';
    });
  }

  function injectNotesAndSignature(){
    var root = printRoot();
    if (!root) return;

    // Clear any previous injected blocks to avoid duplicates
    var prev = document.getElementById('ghd-footer-notes-print'); if (prev) prev.remove();
    prev = document.getElementById('ghd-customer-sign-print'); if (prev) prev.remove();

    // Footer Notes
    var notes = getFooterNotes();
    if (notes){
      var notesDiv = document.createElement('div');
      notesDiv.id = 'ghd-footer-notes-print';
      notesDiv.textContent = notes;
      root.appendChild(notesDiv);
    }

    // Compact Customer Signature
    var sigWrap = document.createElement('div');
    sigWrap.id = 'ghd-customer-sign-print';
    sigWrap.setAttribute('style','page-break-inside:avoid;margin-top:8mm;width:100%;font-size:12px;display:flex;');
    var inner = document.createElement('div');
    inner.setAttribute('style','display:inline-block;min-width:180px;max-width:220px;');
    inner.innerHTML = '<div style="border-bottom:1px solid #000;height:22px;width:100%;"></div>'
                    + '<div style="margin-top:4px;text-align:left;">Customer Signature</div>';
    sigWrap.appendChild(inner);
    root.appendChild(sigWrap);
  }

  // Compose all steps for same-window print
  function prepareForPrint(){
    ensureMasterCSS();
    ensureSN();
    injectNotesAndSignature();
  }

  // Wrap/compose the generated print HTML so it always includes landscape (optional), SN, footer notes, and signature
  function wrapBuildPrintHTML(){
    if (!window.GHD || typeof window.GHD.buildPrintHTML !== 'function') return;
    if (window.GHD.__ghdMasterWrapped) return;
    var orig = window.GHD.buildPrintHTML;
    window.GHD.buildPrintHTML = function(tab, qno){
      var html = orig.call(window.GHD, tab, qno);
      try{
        var notes = getFooterNotes() || '';
        // Force SN in header first cell (class col-idx)
        html = html.replace(/(<th\b[^>]*class="[^"]*col-idx[^"]*"[^>]*>)[\s\S]*?(<\/th>)/ig, '$1SN$2');
        // Inject our CSS into the child <head>
        var css = '<style id="ghd-print-master-css-child">' + buildPrintCSS(wantLandscape()) + '</style>';
        html = html.replace(/<\/head>/i, css + '</head>');
        // Append Footer Notes + compact signature before </body>
        var inject = '';
        if (notes){
          inject += '<div id="ghd-footer-notes-print" style="white-space:pre-wrap;font-size:12pt;margin-top:10mm;padding-top:4mm;border-top:1px solid #000;">'
                 +  notes.replace(/</g,'&lt;').replace(/>/g,'&gt;')
                 +  '</div>';
        }
        inject += '<div id="ghd-customer-sign-print" style="page-break-inside:avoid;margin-top:8mm;width:100%;font-size:12px;display:flex;">'
               +  '  <div style="display:inline-block;min-width:180px;max-width:220px;">'
               +  '    <div style="border-bottom:1px solid #000;height:22px;width:100%;"></div>'
               +  '    <div style="margin-top:4px;text-align:left;">Customer Signature</div>'
               +  '  </div>'
               +  '</div>';
        html = html.replace(/<\/body>/i, inject + '</body>');
      }catch(e){}
      return html;
    };
    window.GHD.__ghdMasterWrapped = true;
  }

  // Bindings
  document.addEventListener('DOMContentLoaded', function(){
    // Remove older injected scripts that may conflict (keep toggle UI)
    ['ghd-wire-footer-notes-and-landscape','ghd-force-sn-final','ghd-link-footer-notes-to-print-21','ghd-fix-sn-and-borders'].forEach(function(id){
      var el = document.getElementById(id); if (el) el.remove();
    });
    prepareForPrint();
    wrapBuildPrintHTML();
  });

  // Re-prepare each time you print (so edits are reflected)
  window.addEventListener('beforeprint', prepareForPrint);

  // Re-apply if DOM changes (e.g., you edit items, switch tabs)
  var mo = new MutationObserver(function(){
    wrapBuildPrintHTML();
  });
  mo.observe(document.documentElement, {childList:true, subtree:true});
})();
</script>

<script id="ghd-proprint-fallback">
(function(){
  function safeUpdate(){
    try { if (typeof updateOnPagePrintRoot === 'function') updateOnPagePrintRoot(); } catch(e){}
  }

  function wrapOpenQuoteOnce(){
    if (!window.GHD || typeof window.GHD.openQuote !== 'function') return;
    if (window.GHD.openQuote.__ghdWrapped) return;
    var _orig = window.GHD.openQuote;
    function _wrapped(tab){
      safeUpdate();
      try {
        return _orig.apply(this, arguments);
      } catch (e){
        console.error('[GHD print fallback]', e);
        safeUpdate();
        return window.print();
      }
    }
    _wrapped.__ghdWrapped = true;
    _wrapped.__orig = _orig;
    window.GHD.openQuote = _wrapped;
  }

  // Re-wrap if the app hot-swaps openQuote after edits
  function ensureWrapped(){
    if (window.GHD && typeof window.GHD.openQuote === 'function'){
      if (!window.GHD.openQuote.__ghdWrapped) wrapOpenQuoteOnce();
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    wrapOpenQuoteOnce();
    // As a safety net, bind any element that looks like a print button
    document.addEventListener('click', function(ev){
      var el = ev.target.closest && ev.target.closest('button, a, [role="button"], input[type="button"], input[type="submit"]');
      if (!el) return;
      var txt = (el.textContent||'').trim().toLowerCase();
      var id  = (el.id||'').toLowerCase();
      var cls = (el.className||'').toString().toLowerCase();
      // If it looks like a print trigger, make sure openQuote is wrapped before handlers run
      if (txt === 'print quote' || txt === 'print' || id.includes('print') || cls.includes('print')){
        ensureWrapped();
      }
    }, true); // capture phase, before the app's handler
  });

  // Keep checking occasionally in case the app replaces GHD.openQuote
  setInterval(ensureWrapped, 1200);
})();
</script>

<script id="ghd-safe-print-v1">
(function(){
  var LS_KEY = 'ghd_landscape_pref';

  function wantLandscape(){
    var cb = document.getElementById('ghdLandscapeToggle');
    var val = !!(cb && cb.checked);
    try { if (!val) val = (localStorage.getItem(LS_KEY) === '1'); } catch(e){}
    return val;
  }

  function getFooterNotes(){
    var el = document.getElementById('ghdFooterNotesInput');
    return (el && el.value) ? el.value.trim() : '';
  }

  function getRoot(){
    return document.getElementById('ghd-print-body') || document.getElementById('ghd-print-root') || document.body;
  }

  function forceSN(scope){
    (scope||document).querySelectorAll('thead th.col-idx').forEach(function(th){
      th.textContent = 'SN';
      th.style.whiteSpace = 'nowrap';
    });
  }

  function elementToText(el){
    var span = document.createElement('span');
    var text = '';
    if (el.tagName === 'SELECT'){
      var opt = el.options[el.selectedIndex];
      text = opt && opt.text ? opt.text : (el.value || '');
    } else if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA'){
      text = el.value || el.textContent || '';
    } else {
      text = el.textContent || '';
    }
    span.textContent = text;
    span.setAttribute('data-from', el.tagName.toLowerCase());
    return span;
  }

  function cloneForPrint(){
    var root = getRoot();
    var clone = root.cloneNode(true);

    // Remove toolbars/controls in clone
    Array.from(clone.querySelectorAll('.toolbar, .actions, .controls, [data-noprint]')).forEach(function(n){ n.remove(); });

    // Convert inputs/selects to plain text (so content never disappears)
    Array.from(clone.querySelectorAll('input, textarea, select')).forEach(function(el){
      var txt = elementToText(el);
      // keep surrounding layout
      el.parentNode && el.parentNode.replaceChild(txt, el);
    });

    // Ensure SN header is correct
    forceSN(clone);

    // Footer Notes
    var notes = getFooterNotes();
    if (notes){
      var notesDiv = document.createElement('div');
      notesDiv.id = 'ghd-footer-notes-print';
      notesDiv.textContent = notes;
      notesDiv.setAttribute('style','white-space:pre-wrap;font-size:12pt;margin-top:10mm;padding-top:4mm;border-top:1px solid #000;');
      clone.appendChild(notesDiv);
    }

    // Customer Signature (short line)
    var sig = document.createElement('div');
    sig.id = 'ghd-customer-sign-print';
    sig.setAttribute('style','page-break-inside:avoid;margin-top:8mm;width:100%;font-size:12px;display:flex;');
    var inner = document.createElement('div');
    inner.setAttribute('style','display:inline-block;min-width:180px;max-width:220px;');
    inner.innerHTML = '<div style="border-bottom:1px solid #000;height:22px;width:100%;"></div>'
                    + '<div style="margin-top:4px;text-align:left;">Customer Signature</div>';
    sig.appendChild(inner);
    clone.appendChild(sig);

    return clone;
  }

  function buildPrintDoc(){
    var landscape = wantLandscape();
    var css = ''
      + '<style>@media print{'
      + (landscape ? '@page{size:A4 landscape;margin:12mm;} @page{size:landscape;}' : '@page{margin:12mm;}')
      + ' #ghd-print-root{font-size:10pt!important;}'
      + ' body{padding:0 2mm!important;}'
      + ' table{width:96%!important;margin:0 auto!important;border-collapse:collapse!important;border-spacing:0!important;table-layout:fixed!important;outline:1px solid #000!important;outline-offset:-1px!important;}'
      + ' thead{display:table-header-group!important;}'
      + ' table, thead, tbody, tr, th, td{break-inside:avoid!important;page-break-inside:avoid!important;}'
      + ' th, td{border:1px solid #000!important;padding:5px 7px!important;line-height:1.2!important;overflow:visible!important;text-overflow:clip!important;white-space:normal!important;word-break:break-word!important;overflow-wrap:anywhere!important;background-clip:padding-box!important;}'
      + ' th.col-idx, td.col-idx{white-space:nowrap!important;min-width:34px!important;width:34px!important;text-align:center!important;}'
      + '}</style>';

    var clone = cloneForPrint();
    var html = '<!doctype html><html><head><meta charset="utf-8"><title>Print Quote</title>' + css + '</head><body>' + clone.innerHTML + '</body></html>';
    return html;
  }

  function safePrintNow(){
    try{
      var win = window.open('', '_blank');
      if (!win) { window.print(); return; }
      var doc = win.document;
      doc.open();
      doc.write(buildPrintDoc());
      doc.close();
      win.focus();
      // Wait a tick to allow layout before printing
      setTimeout(function(){ win.print(); setTimeout(function(){ try{ win.close(); }catch(e){} }, 200); }, 50);
    }catch(e){
      console.error('safePrint error', e);
      window.print();
    }
  }

  function bindPrintButtons(){
    var nodes = Array.prototype.slice.call(document.querySelectorAll('button,a,[role="button"],input[type="button"],input[type="submit"]'));
    nodes.forEach(function(n){
      if (n.__ghdSafePrintBound) return;
      var id=(n.id||'').toLowerCase(), cls=(n.className||'').toLowerCase(), txt=(n.textContent||'').trim().toLowerCase();
      if (id.includes('print')||cls.includes('print')||txt==='print quote'||txt==='print'){
        n.__ghdSafePrintBound = true;
        n.addEventListener('click', function(ev){
          ev.preventDefault(); ev.stopPropagation();
          safePrintNow();
          return false;
        }, true); // capture
      }
    });
  }

  document.addEventListener('DOMContentLoaded', bindPrintButtons);
  new MutationObserver(bindPrintButtons).observe(document.documentElement, {childList:true, subtree:true});
})();
</script>
</body>
</html>


<script>
// === GHD Custom Pricing for Accordion/Screens/Honeycomb in "All Products" ===
// Adds computation for 14 specific variants without removing existing logic.

(function(){
  const PRODUCT_VARIANTS = [
    "Regular Accordion Door One Way",
    "Regular Accordion Door Two Way",
    "French Accordion Door One Way",
    "French Accordion Door Two Way",
    "Polycarbonate Accordion Door One Way",
    "Polycarbonate Accordion Door Two Way",
    "Pleated Mesh One Way",
    "Pleated Mesh Two Way",
    "Security Screen One Way",
    "Security Screen Two Way",
    "Top to Bottom Screen",
    "Honeycomb Only One Way",
    "Honeycomb Only Two Way",
    "Honeycomb Combination with Screen"
  ];

  // Helpers (reuse from globals if exist)
  function toInches(val, unit){
    const v = +val||0;
    switch(unit){
      case 'cm': return v / 2.54;
      case 'mm': return v / 25.4;
      case 'ft': return v * 12;
      case 'm':  return v * 39.3701;
      default:   return v; // inches
    }
  }
  function fmt(n){ return (Math.round((+n||0))).toLocaleString('en-PH'); }

  function adjustedAccordionHeightIn(H_in) {
  // Accordion height bucketing: 7/8/9/10 ft only, cap at 10 ft
  if (H_in <= 84) return 84;        // ‚â§7 ft ‚Üí 7 ft; exact 7 ft stays 7
  if (H_in < 96) return 96;         // >7 ft and <8 ft ‚Üí 8 ft
  if (H_in === 96) return 96;       // exact 8 ft stays 8
  if (H_in < 108) return 108;       // >8 ft and <9 ft ‚Üí 9 ft
  if (H_in === 108) return 108;     // exact 9 ft stays 9
  return 120;                       // ‚â•9 ft ‚Üí 10 ft (cap)
}


  function areaSqftAccordion(W_in, H_in){
    const H_adj = adjustedAccordionHeightIn(H_in);
    return (W_in * H_adj) / 144.0;
  }
  function areaSqftPlain(W_in, H_in){
    return (W_in * H_in) / 144.0;
  }

  // Per-product calculators (return line total in PHP)
  function calcLine(product, W_in, H_in){
    const A_acc = Math.max(20, areaSqftAccordion(W_in, H_in)); // for accordion types
    const A_plain20 = Math.max(20, areaSqftPlain(W_in, H_in));
    const A_plain15 = Math.max(15, areaSqftPlain(W_in, H_in));

    switch(product){
      // Regular Accordion
      case "Regular Accordion Door One Way":   return A_acc * 220 + 1000;              // + lock optional handled separately
      case "Regular Accordion Door Two Way":   return A_acc * 220 + 2000;

      // French Accordion
      case "French Accordion Door One Way":    return A_acc * 320 + 1200;
      case "French Accordion Door Two Way":    return A_acc * 320 + 2400;

      // Polycarbonate Accordion
      case "Polycarbonate Accordion Door One Way": return A_acc * 750 + 1200;
      case "Polycarbonate Accordion Door Two Way": return A_acc * 750 + 4200;

      // Pleated Mesh
      case "Pleated Mesh One Way":             return A_plain20 * 350;
      case "Pleated Mesh Two Way":             return A_plain20 * 375;

      // Security Screen
      case "Security Screen One Way":          return A_plain20 * 750;
      case "Security Screen Two Way":          return A_plain20 * 780 + 3000;

      // Top to Bottom
      case "Top to Bottom Screen":             return A_plain15 * 250;

      // Honeycomb
      case "Honeycomb Only One Way":           return A_plain20 * 390;
      case "Honeycomb Only Two Way":           return A_plain20 * 390 + 3000;
      case "Honeycomb Combination with Screen":return A_plain20 * 410;
    }
    return null;
  }

  // Max/Restriction messages
  function checkNotes(product, W_in, H_in){
    const notes = [];
    // Top-to-Bottom: width <= 78.74, height <= 70.866
    if (product === "Top to Bottom Screen"){
      if (W_in > 78.74 || H_in > 70.866){
        notes.push("Top-to-Bottom exceeded ‚Äî suggest Pleated Screen or Security Screen.");
      }
    }
    // Honeycomb Only: max width 94.49, max height 120 (else suggest two-way)
    if (product === "Honeycomb Only One Way" || product === "Honeycomb Only Two Way"){
      if (W_in > 94.49 || H_in > 120){
        notes.push("Honeycomb exceeded ‚Äî suggest Two-way Honeycomb Only.");
      }
    }
    // Pleated recommended max: 1-way 3m width, 2-way 6m width; height 120in (recommendation)
    const W_m = W_in / 39.3701 * 1.0; // convert inches to meters
    if (product === "Pleated Mesh One Way"){
      if (W_m > 3 || H_in > 120){
        notes.push("Pleated 1-way: recommended up to 3m width √ó 120in height.");
      }
    }
    if (product === "Pleated Mesh Two Way"){
      if (W_m > 6 || H_in > 120){
        notes.push("Pleated 2-way: recommended up to 6m width √ó 120in height.");
      }
    }
    // Same recommendation applies to Polycarbonate & Security
    if (product === "Polycarbonate Accordion Door One Way" || product === "Security Screen One Way"){
      if (W_m > 3 || H_in > 120){
        notes.push("Recommended: up to 3m width √ó 120in height for one-way. If above, two-way is recommended (but one-way can be done up to 6m if customer insists).");
      }
    }
    if (product === "Polycarbonate Accordion Door Two Way" || product === "Security Screen Two Way"){
      if (W_m > 6 || H_in > 120){
        notes.push("Recommended: up to 6m width √ó 120in height for two-way.");
      }
    }
    return notes;
  }

  // Attach calculator to All Products table
  function recalcAllProductsVariant(){
    const table = document.getElementById('a-table');
    if (!table) return;
    let sub = 0, i = 0;
    table.querySelectorAll('tbody tr').forEach(tr => {
      // sync row index
      const idxCell = tr.querySelector('.col-idx');
      if (idxCell) idxCell.textContent = (++i);

      const typeSel = tr.querySelector('select.type');
      const wEl = tr.querySelector('.width');
      const hEl = tr.querySelector('.height');
      const unitEls = tr.querySelectorAll('.unit');
      const lineCell = tr.querySelector('.line');
      const sqftCell = tr.querySelector('.sqft');

      if (!typeSel || !wEl || !hEl || unitEls.length < 2 || !lineCell) return;
      const product = typeSel.value;
      // Only handle our 14 variants; else leave existing logic untouched
      if (!PRODUCT_VARIANTS.includes(product)) return;

      const W_in = toInches(parseFloat(wEl.value||0), unitEls[0].value);
      const H_in = toInches(parseFloat(hEl.value||0), unitEls[1].value);

      // Compute area display (use appropriate function for transparency)
      const area = (product.includes("Accordion") ? areaSqftAccordion(W_in,H_in) : areaSqftPlain(W_in,H_in));
      if (sqftCell) sqftCell.textContent = (product === "Top to Bottom Screen" ? Math.max(15, area) : Math.max(20, area)).toFixed(2);

      const line = calcLine(product, W_in, H_in);
      if (line != null){
        lineCell.textContent = '‚Ç±' + fmt(line);
        sub += line;
      }

      // Attach/refresh notes into the Options cell for guidance
      const optCell = tr.querySelector('.col-opt');
      if (optCell){
        const msgs = checkNotes(product, W_in, H_in);
        optCell.setAttribute('title', msgs.join(' '));
        // also render a small helper text inside
        const id = 'ghd-note';
        let note = optCell.querySelector('.'+id);
        if (!note){
          note = document.createElement('div');
          note.className = id;
          note.style.fontSize = '11px';
          note.style.color = '#6b7280';
          optCell.appendChild(note);
        }
        note.textContent = msgs.join(' ');
      }
    });

    // Update totals shown under All Products
    const subEl = document.getElementById('a-sub');
    const discPctEl = document.getElementById('a-disc');
    const vatPctEl  = document.getElementById('a-vat');
    const discAmtEl = document.getElementById('a-discAmt');
    const vatAmtEl  = document.getElementById('a-vatAmt');
    const grandEl   = document.getElementById('a-grand');

    if (subEl && discPctEl && vatPctEl && discAmtEl && vatAmtEl && grandEl){
      subEl.textContent = fmt(sub);
      const discPct = +discPctEl.value||0;
      const vatPct  = +vatPctEl.value||0;
      const discAmt = sub * (discPct/100);
      const afterDisc = sub - discAmt;
      const vatAmt = afterDisc * (vatPct/100);
      const grand = afterDisc + vatAmt;
      discAmtEl.textContent = fmt(discAmt);
      vatAmtEl.textContent = fmt(vatAmt);
      grandEl.textContent = fmt(grand);
    }
  }

  // Observe changes within All Products panel to trigger recalculation
  const panel = document.getElementById('panel-all');
  if (panel){
    panel.addEventListener('input', recalcAllProductsVariant);
    panel.addEventListener('change', recalcAllProductsVariant);
    // Initial pass (in case rows are pre-added by script)
    setTimeout(recalcAllProductsVariant, 300);
  }

  // Also patch rows added later via "+ Add Item" by hooking into DOM changes
  const aTable = document.getElementById('a-table');
  if (aTable && 'MutationObserver' in window){
    const mo = new MutationObserver(()=> setTimeout(recalcAllProductsVariant, 50));
    mo.observe(aTable.querySelector('tbody'), {childList:true, subtree:true});
  }
})();
</script>


<script>
(function(){
  const VARIANTS = [
    "Regular Accordion Door One Way",
    "Regular Accordion Door Two Way",
    "French Accordion Door One Way",
    "French Accordion Door Two Way",
    "Polycarbonate Accordion Door One Way",
    "Polycarbonate Accordion Door Two Way",
    "Pleated Mesh One Way",
    "Pleated Mesh Two Way",
    "Security Screen One Way",
    "Security Screen Two Way",
    "Top to Bottom Screen",
    "Honeycomb Only One Way",
    "Honeycomb Only Two Way",
    "Honeycomb Combination with Screen"
  ];

  function isVariant(val){ return VARIANTS.includes(val); }

  function ensureShiftCell(tr, needed){
    // We insert/remove a placeholder cell immediately after the Type cell
    // to shift subsequent cells by one column for variant rows.
    const typeCell = tr.querySelector('td.col-type');
    if (!typeCell) return;
    const next = typeCell.nextElementSibling;
    const isPlaceholder = next && next.classList && next.classList.contains('col-shift');

    if (needed && !isPlaceholder){
      const td = document.createElement('td');
      td.className = 'col-shift';
      td.style.minWidth = '140px';
      td.style.width = '140px';
      td.style.opacity = '0';     // invisible spacer
      td.style.pointerEvents = 'none';
      typeCell.after(td);
    } else if (!needed && isPlaceholder){
      next.remove();
    }
  }

  function applyShiftAll(){
    const rows = document.querySelectorAll('#a-table tbody tr');
    rows.forEach(tr => {
      const sel = tr.querySelector('select.type');
      if (!sel) return;
      ensureShiftCell(tr, isVariant(sel.value));
    });
  }

  // Run at start and whenever anything changes in All Products panel
  const panel = document.getElementById('panel-all');
  if (panel){
    panel.addEventListener('change', applyShiftAll);
    panel.addEventListener('input', applyShiftAll);
    setTimeout(applyShiftAll, 200);
  }
  // Also watch new rows
  const tbody = document.querySelector('#a-table tbody');
  if (tbody && 'MutationObserver' in window){
    new MutationObserver(()=> setTimeout(applyShiftAll, 50)).observe(tbody, {childList:true, subtree:true});
  }
})();
</script>
